<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVAD - Listar Nova Conta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* VARIÁVEIS DE COR */
        :root {
            --primary-color: #007bff;
            --purple-vibrant: #7f00ff;
            --pink-vibrant: #ff007f;
            --background-dark: #212529;
            --form-bg: #ffffff;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* NOVO FUNDO 3D IMPACTANTE E INTERATIVO */
        body {
            font-family: var(--font-family);
            /* Gradiente radial para simular profundidade 3D (ponto de luz no centro) */
            background: radial-gradient(circle at top left, #3a0099, #1f005c, var(--purple-vibrant));
            background-attachment: fixed;
            color: #333;
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        
        /* Contêiner Principal do Formulário (Onde o 3D é aplicado) */
        .form-container {
            background-color: var(--form-bg);
            border-radius: 1.5rem;
            padding: 3rem;
            max-width: 850px;
            margin: auto;
            /* Sombra profunda para o EFEITO 3D */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5), 0 0 0 10px rgba(255, 255, 255, 0.1); 
            transition: all 0.3s ease;
        }
        .form-container:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        /* ELEMENTOS DE INTERFACE */
        .header-title {
            color: var(--pink-vibrant);
            font-weight: 700;
            border-bottom: 3px solid var(--purple-vibrant);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .text-purple-vibrant { color: var(--purple-vibrant) !important; }
        
        /* Estilização dos Fieldsets (Seções) */
        .form-section {
            border: 1px solid #ddd;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            background-color: #fcfcfc;
        }
        .form-section legend {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Pré-visualização de Imagens */
        .image-preview-item {
            position: relative;
            height: 100px; /* Altura fixa para miniaturas */
            overflow: hidden;
            border: 1px solid #ccc;
            border-radius: 0.3rem;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Botão de Publicação */
        .btn-publish {
            background-color: var(--purple-vibrant);
            border-color: var(--purple-vibrant);
            color: white;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .btn-publish:hover {
            background-color: var(--pink-vibrant); 
            border-color: var(--pink-vibrant);
            color: white;
            transform: translateY(-2px);
        }

        /* Navbar e Footer (para consistência) */
        .navbar { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        footer { background-color: var(--background-dark) !important; color: #bbb; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">IVAD | Marketplace</a>
            <span class="navbar-text text-white-50 ms-3">/ Anunciar Conta</span>
        </div>
    </nav>

    <div class="container form-container">
        
        <h1 class="header-title mb-4">
            <i class="fas fa-bullhorn me-2"></i> Listar Sua Conta Digital
        </h1>
        <p class="lead text-muted">Preencha os dados com precisão para atrair compradores rapidamente. Seus dados de contato ficam privados.</p>

        <form id="listing-form">
            
            <fieldset class="form-section">
                <legend class="float-none w-auto px-2">1. Informações Essenciais</legend>
                
                <div class="mb-3">
                    <label for="title" class="form-label">Título do Anúncio <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="title" required 
                           placeholder="Ex: Conta Free Fire Rara com 5 passes" maxlength="80">
                    <div class="form-text">Seja claro e inclua palavras-chave importantes.</div>
                </div>
                
                <div class="mb-3">
                    <label for="category" class="form-label">Categoria Principal <span class="text-danger">*</span></label>
                    <select class="form-select" id="category" required>
                        <option value="" disabled selected>-- Selecione a Categoria --</option>
                        <option value="eFootball">eFootball / FIFA</option>
                        <option value="Roblox/Minecraft">Roblox / Minecraft</option>
                        <option value="FreeFire/COD">Free Fire / Call of Duty</option>
                        <option value="ServicosDiversos">Outros Jogos / Serviços</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Descrição Detalhada <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="description" rows="5" required 
                              placeholder="Descreva itens raros, nível, skins, motivo da venda, etc."></textarea>
                </div>
                
            </fieldset>

            <fieldset class="form-section">
                <legend class="float-none w-auto px-2">2. Preço e Negociação</legend>
                
                <div class="mb-3">
                    <label for="price" class="form-label">Preço de Venda (R$) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" min="0" class="form-control" id="price" required 
                           placeholder="Ex: 450.00">
                    <div class="form-text">Este é o valor que o comprador pagará via Escrow.</div>
                </div>
                
                <div class="form-check mb-4 p-4 border rounded">
                    <input class="form-check-input" type="checkbox" id="acceptsExchange">
                    <label class="form-check-label fs-5" for="acceptsExchange">
                        <i class="fas fa-exchange-alt text-warning me-2"></i> Aceito Troca por outra Conta/Item
                    </label>
                    <div class="mt-2 text-muted">Marque se você estiver aberto a propostas de troca, além da venda direta.</div>
                </div>
                
                <div class="mb-3" id="exchange-details" style="display:none;">
                    <label for="interest" class="form-label">Interesse Específico de Troca</label>
                    <input type="text" class="form-control" id="interest" 
                           placeholder="Ex: Contas de Genshin Impact, Console, ou R$ 200 + Troca">
                </div>
            </fieldset>
            
            <fieldset class="form-section">
                <legend class="float-none w-auto px-2">3. Imagens e Evidências</legend>
                
                <p class="text-muted">Anexe até **5 capturas de tela** da conta para comprovar os itens. **Fotos de alta qualidade** geram mais confiança.</p>
                
                <div class="mb-3">
                    <label for="listing-images" class="form-label">Upload de Fotos da Conta (Máx. 5)</label>
                    <input class="form-control" type="file" id="listing-images" multiple accept="image/*">
                    <div class="form-text">Formatos aceitos: JPG, PNG. Cada arquivo deve ter no máximo 2MB.</div>
                </div>

                <div id="image-preview" class="row g-2 mt-3">
                    </div>
                
            </fieldset>

            <fieldset class="form-section">
                <legend class="float-none w-auto px-2">4. Confirmação</legend>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i> O anúncio será publicado em seu nome de usuário. O chat privado será o canal de negociação.
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" value="" id="termsCheck" required>
                    <label class="form-check-label" for="termsCheck">
                        Eu concordo com os <a href="#" class="text-primary">Termos de Serviço e a Política de Transação Segura (Escrow)</a> do IVAD. <span class="text-danger">*</span>
                    </label>
                </div>
                
            </fieldset>

            <button type="submit" class="btn btn-lg btn-publish w-100" id="submit-listing-btn">
                <i class="fas fa-upload me-2"></i> Publicar Anúncio Agora
            </button>
            <div class="text-center mt-3">
                 <a href="index.html" class="text-muted"><small>Cancelar e Voltar ao Início</small></a>
            </div>
        </form>

    </div> <footer class="py-4 fixed-bottom">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 IVAD - Marketplace.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script> <script>
        // Inicialização do Firebase (Requerido para o Storage)
        const firebaseConfig = {
            apiKey: "AIzaSyB8-tIVUAlMWQtCbF1sGLWgW9sL2Z0ixrk",
            authDomain: "ivad-trocas-e-vendas.firebaseapp.com",
            projectId: "ivad-trocas-e-vendas",
            storageBucket: "ivad-trocas-e-vendas.firebasestorage.app",
            messagingSenderId: "447811910709",
            appId: "1:447811910709:web:a42b73819f6e6eb34c057c",
            measurementId: "G-RHVF8P3RCW"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Novo serviço: Storage

        let currentUserUid = null;

        // Monitora o estado de autenticação (Necessário para obter o UID)
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserUid = user.uid;
            } else {
                currentUserUid = null;
                alert('Você precisa estar logado para listar uma conta. Redirecionando para o login.');
                // Em um ambiente real, você redirecionaria para index.html e forçaria o modal de login
            }
        });

        // Lógica de toggle para o campo de interesse de troca
        document.getElementById('acceptsExchange').addEventListener('change', function() {
            document.getElementById('exchange-details').style.display = this.checked ? 'block' : 'none';
        });

        // Lógica de pré-visualização das imagens
        document.getElementById('listing-images').addEventListener('change', function() {
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            
            if (this.files.length > 5) {
                alert("Máximo de 5 imagens permitido. As primeiras 5 serão consideradas.");
            }

            Array.from(this.files).slice(0, 5).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewContainer.innerHTML += `
                        <div class="col-4 col-md-3 image-preview-item">
                            <img src="${e.target.result}" alt="Preview da Imagem">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });
        });

        // Lógica Principal de Envio (Handle Submit)
        const listingForm = document.getElementById('listing-form');
        if (listingForm) {
            listingForm.addEventListener('submit', handleListingSubmit);
        }

        // Função de Upload e Publicação (O core da etapa)
        async function handleListingSubmit(e) {
            e.preventDefault();

            if (!currentUserUid) {
                alert("Você precisa estar logado para listar uma conta.");
                return;
            }
            
            const submitBtn = document.getElementById('submit-listing-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Publicando...';

            const files = document.getElementById('listing-images').files;
            const uploadPromises = [];
            const imageUrls = [];
            
            // 1. Coleta e Validação dos Dados
            const listingData = {
                titulo: document.getElementById('title').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                preco: parseFloat(document.getElementById('price').value) || 0,
                aceitaTroca: document.getElementById('acceptsExchange').checked,
                interesse: document.getElementById('interest').value || '',
                vendedorUid: currentUserUid,
                status: 'pendente',
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // 2. Upload de Imagens para o Firebase Storage
                if (files.length > 5) {
                     throw new Error("Máximo de 5 imagens permitido.");
                }
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.size > 2 * 1024 * 1024) { // 2MB
                        throw new Error(`O arquivo ${file.name} excede o limite de 2MB.`);
                    }
                    
                    const fileName = `${currentUserUid}_${Date.now()}_${i}`;
                    const storageRef = storage.ref(`anuncios/${listingData.category}/${fileName}`);
                    
                    // Cria a Promise para o upload
                    const uploadTask = storageRef.put(file);
                    uploadPromises.push(new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', 
                            (snapshot) => { /* Progresso (Opcional) */ }, 
                            (error) => {
                                reject(`Erro no upload da imagem ${i+1}: ${error.message}`);
                            }, 
                            () => {
                                storageRef.getDownloadURL().then(url => {
                                    imageUrls.push(url);
                                    resolve();
                                });
                            }
                        );
                    }));
                }

                // Aguarda todos os uploads terminarem
                await Promise.all(uploadPromises);
                
                // 3. Salva o Anúncio no Firestore com as URLs das Imagens
                listingData.imageUrls = imageUrls;
                await db.collection('anuncios').add(listingData);

                alert('Anúncio publicado com sucesso! Ele passará por moderação antes de ser exibido.');
                window.location.href = 'index.html';

            } catch (error) {
                console.error("Erro completo na publicação:", error);
                alert(`Falha ao publicar anúncio: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload me-2"></i> Publicar Anúncio Agora';
            }
        }
    </script>
</body>
</html>
