<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVAD - Chat Privado de Negociação</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --purple-vibrant: #7f00ff;
            --chat-bg: #f8f9fa;
        }

        body {
            background-color: #e9ecef;
            padding-top: 56px; /* Espaço para a navbar */
        }
        
        .chat-container {
            max-width: 900px;
            margin: 20px auto;
            border-radius: 1rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: 80vh; /* Altura da tela */
        }

        .chat-header {
            background-color: var(--purple-vibrant);
            color: white;
            padding: 1rem;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        #chat-messages-area {
            height: calc(80vh - 150px); /* Altura do container - header - input */
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--chat-bg);
        }

        .message-bubble {
            max-width: 80%;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .message-incoming {
            background-color: #ffffff;
            border: 1px solid #ddd;
            margin-right: auto;
        }

        .message-outgoing {
            background-color: #d1e7ff; /* Azul claro do bootstrap */
            margin-left: auto;
        }

        .chat-input-area {
            background-color: #ffffff;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">IVAD | Marketplace</a>
            <span class="navbar-text text-white-50 ms-3">/ Chat Privado</span>
        </div>
    </nav>

    <div class="container chat-container">
        
        <div class="chat-header">
            <h4 class="mb-0">
                <i class="fas fa-comments me-2"></i> Negociação: <span id="chat-title">Carregando...</span>
            </h4>
        </div>

        <div id="chat-messages-area">
            <div id="loading-status" class="text-center text-muted mt-5">
                <i class="fas fa-spinner fa-spin me-2"></i> Conectando à sala de negociação...
            </div>
        </div>

        <div class="chat-input-area">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Digite sua mensagem..." disabled>
                <button class="btn btn-primary" id="send-btn" disabled>
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB8-tIVUAlMWQtCbF1sGLWgW9sL2Z0ixrk",
            authDomain: "ivad-trocas-e-vendas.firebaseapp.com",
            projectId: "ivad-trocas-e-vendas",
            messagingSenderId: "447811910709",
            appId: "1:447811910709:web:a42b73819f6e6eb34c057c",
            measurementId: "G-RHVF8P3RCW"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Acesso aos elementos
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessagesArea = document.getElementById('chat-messages-area');
        const chatTitle = document.getElementById('chat-title');
        const loadingStatus = document.getElementById('loading-status');

        let currentUserUid = null;
        let targetUid = null; // O UID do vendedor
        let chatRoomId = null; // ID da sala (garante unicidade)

        // Funções Auxiliares (A serem implementadas no script.js se for compartilhado)
        async function getUsernameByUid(uid) {
            if (!uid) return 'Usuário Desconhecido';
            try {
                const doc = await db.collection('users').doc(uid).get();
                return doc.exists && doc.data().username ? doc.data().username : `UID: ${uid.substring(0, 4)}...`;
            } catch (e) {
                return `Erro ao buscar nome`;
            }
        }
        
        /**
         * Gera um ID de sala único e consistente (sempre o mesmo para os dois usuários).
         * @param {string} uid1
         * @param {string} uid2
         * @returns {string} ID da sala.
         */
        function generateChatRoomId(uid1, uid2) {
            // Usa ordenação alfabética para garantir que Comprador/Vendedor gerem o mesmo ID.
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        /**
         * Renderiza uma mensagem na interface.
         */
        function displayMessage(messageData, senderName) {
            const isOutgoing = messageData.senderUid === currentUserUid;
            const bubbleClass = isOutgoing ? 'message-outgoing ms-4' : 'message-incoming me-4';
            const floatClass = isOutgoing ? 'float-end' : 'float-start';
            
            let timeString = '';
            if (messageData.timestamp && messageData.timestamp.toDate) {
                const date = messageData.timestamp.toDate();
                timeString = date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            }

            const messageHtml = `
                <div class="${floatClass} w-100">
                    <div class="message-bubble ${bubbleClass}">
                        <small class="text-muted">${isOutgoing ? 'Você' : senderName}</small>
                        <p class="mb-0">${messageData.text}</p>
                        <small class="text-secondary float-end">${timeString}</small>
                    </div>
                </div>
            `;
            chatMessagesArea.insertAdjacentHTML('beforeend', messageHtml);
            chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
        }

        /**
         * Envia uma nova mensagem para a sala privada.
         */
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !currentUserUid || !chatRoomId) return;

            chatInput.disabled = true;
            sendBtn.disabled = true;

            const messageData = {
                senderUid: currentUserUid,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('chats').doc(chatRoomId).collection('messages').add(messageData)
                .then(() => {
                    chatInput.value = '';
                })
                .catch((error) => {
                    console.error("Erro ao enviar mensagem privada:", error);
                    alert("Falha ao enviar mensagem.");
                })
                .finally(() => {
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    chatInput.focus();
                });
        }
        
        /**
         * Inicializa a conexão e os listeners do chat.
         */
        async function initializeChat() {
            // 1. Obtém o UID do Vendedor da URL
            const urlParams = new URLSearchParams(window.location.search);
            targetUid = urlParams.get('vendedorId');

            if (!targetUid || !currentUserUid) {
                loadingStatus.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> Erro: UID do vendedor ou seu login não encontrados. Faça login e tente novamente.`;
                return;
            }

            const targetName = await getUsernameByUid(targetUid);
            const myName = await getUsernameByUid(currentUserUid);

            chatTitle.textContent = targetName;
            
            // 2. Cria o ID da Sala
            chatRoomId = generateChatRoomId(currentUserUid, targetUid);
            loadingStatus.remove();

            // 3. Configura o Listener da Sala
            db.collection('chats').doc(chatRoomId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(async change => {
                        if (change.type === 'added') {
                            const messageData = change.doc.data();
                            const senderName = await getUsernameByUid(messageData.senderUid);
                            displayMessage(messageData, senderName);
                        }
                    });
                }, error => {
                    console.error("Erro no listener do chat:", error);
                    chatMessagesArea.innerHTML = `<div class="alert alert-danger">Erro de conexão com o chat.</div>`;
                });

            // 4. Habilita o Input
            chatInput.disabled = false;
            sendBtn.disabled = false;
        }

        // Event Listeners
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserUid = user.uid;
                initializeChat();
            } else {
                currentUserUid = null;
                loadingStatus.innerHTML = `<i class="fas fa-lock me-2"></i> Você deve estar logado para iniciar uma negociação.`;
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
