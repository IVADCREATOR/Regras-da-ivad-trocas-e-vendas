<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVAD TROCAS E VENDAS</title>
<style>
/* VARS */
:root{
  --card-bg: rgba(0,0,0,0.85); 
  --btn-gradient: linear-gradient(90deg,#ffd54f,#ffb300);
  --btn-blue: linear-gradient(90deg,#90caf9,#42a5f5);
  --btn-red: linear-gradient(90deg,#ef9a9a,#e57373);
  --text-primary: #fff;
  --text-secondary: #c0c0c0;
  --main-gold: #ffb300;
  --border-color: rgba(255,255,255,0.15);
}

/* BASE & LAYOUT */
html,body{height:100%;margin:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color:var(--text-primary);background:#000}
body{perspective:1000px;overflow-x:hidden}

.bg3d{
  position:fixed;inset:0;background:url('/* LINK RAW IMAGEM */') no-repeat center center;
  background-size:cover;z-index:-2;filter:contrast(0.92) saturate(0.95) brightness(0.9);
  transform-origin:center center;animation:float3d 18s ease-in-out infinite alternate;
}
@keyframes float3d{
  0%{transform:translateZ(0px) rotateY(0deg) rotateX(0deg) scale(1)}
  50%{transform:translateZ(12px) rotateY(2deg) rotateX(1deg) scale(1.01)}
  100%{transform:translateZ(0px) rotateY(-1deg) rotateX(-1deg) scale(1)}
}
.overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6))}

header{background:rgba(0,0,0,0.9);padding:1.4rem;text-align:center;position:relative;z-index:2;border-bottom: 3px solid var(--main-gold); box-shadow: 0 4px 15px rgba(0,0,0,0.7);}
header h1{margin:.2rem;font-size:2rem; letter-spacing: 3px; text-shadow: 0 0 10px rgba(255,179,0,0.8);}
header p{margin:.1rem;color:var(--text-secondary);font-size:0.95rem}

.container{max-width:1100px;margin:2rem auto;padding:1rem;display:grid;grid-template-columns:300px 1fr;gap:2rem}
.card{background:var(--card-bg);padding:1.5rem;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.9);border: 1px solid var(--border-color);}

/* MENU E ABAS */
.menu button{display:block;width:100%;margin-bottom:.8rem;padding:.9rem 1rem;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:var(--text-primary);font-weight:700;cursor:pointer;transition:all .2s}
.menu button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(255,179,0,0.4); background:rgba(255,255,255,0.15);}
.menu button.active{background:var(--btn-gradient);color:#111;transform:translateY(0);box-shadow:0 4px 10px rgba(0,0,0,0.5)}

/* CONTE√öDO */
.content h2{margin-top:0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 1.5rem; color: var(--main-gold);}
ul{padding-left:1.5rem}
.small{font-size:.85rem;color:var(--text-secondary)}

/* BOT√ïES GERAIS */
.btn{
  display:inline-block;padding:.8rem 1.5rem;border-radius:8px;border:none;background:var(--btn-gradient);color:#111;font-weight:700;cursor:pointer; 
  transition: all .2s; position: relative; overflow: hidden; transform: translateZ(0);
}
.btn:hover:not(:disabled){box-shadow: 0 0 20px rgba(255,179,0,0.5); transform: scale(1.02);}
.btn:disabled{opacity:0.6; cursor: not-allowed; filter: grayscale(100%);}
.btn::before { /* Efeito Shine */
    content: ''; position: absolute; top: 0; left: -75%; width: 50%; height: 100%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 100%);
    transform: skewX(-25deg); transition: all 0.7s;
}
.btn:not(:disabled):hover::before { left: 125%; }

/* INPUTS */
input[type="text"],input[type="password"],input[type=number],select,textarea{width:100%;padding:.9rem;margin:.5rem 0;border-radius:8px;border:1px solid rgba(255,255,255,0.3);background:rgba(0,0,0,0.5);color:var(--text-primary);box-sizing: border-box; transition: border-color .2s;}
input:focus, textarea:focus{outline: none; border-color: var(--main-gold);}

/* RANKING */
.rank-list{max-height:420px;overflow-y:auto;padding:1rem; background: rgba(0,0,0,0.4);}
.rank-list ol{padding-left: 0; margin: 0;}
.rank-list li{list-style: none; padding: .6rem 0; border-bottom: 1px dashed rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;}
.rank-list li strong{color: #fff;}
.rank-list li:nth-child(1) strong{color: var(--main-gold); text-shadow: 0 0 5px var(--main-gold);}
.rank-list li:nth-child(2) strong{color: #c0c0c0;}
.rank-list li:nth-child(3) strong{color: #cd7f32;}

/* CHAT */
.chat-box{max-height:300px;overflow-y:auto;background:rgba(0,0,0,0.5);padding:.75rem;margin-top:.75rem;border-radius:8px;border: 1px solid var(--border-color)}
.chat-msg{margin:.4rem 0; font-size: 0.9rem; word-wrap: break-word; color: #eee;}
.chat-msg strong{color: #42a5f5; margin-right: 5px; font-weight: 600;}
.chat-msg .audio-player{display: block; margin-top: 5px;}
.chat-input-area{margin-top:.75rem; display: flex; gap: 5px; flex-wrap: wrap; align-items: stretch;}
.chat-input-area input[type=text]{margin: 0; flex-grow: 1;}
.chat-input-area button{padding: 0 1.2rem; margin: 0; font-size: 1rem;}
#btnRecordAudio{background: var(--btn-blue); color: #fff; width: 50px; font-size: 1.2rem;}
#btnRecordAudio.recording{background: var(--btn-red); animation: pulse 1s infinite;}
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 115, 115, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 115, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 115, 115, 0); } }


/* NOTIFICA√á√ÉO GLOBAL */
#globalNotice{
    position:fixed;top:10px;right:10px;background:var(--main-gold);color:#111;padding:.9rem 1.8rem;border-radius:8px;display:none;z-index:9999;
    font-weight:700;box-shadow:0 4px 15px rgba(0,0,0,0.7);
    animation: fadeInOut 4.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
}
@keyframes fadeInOut { 0%{opacity:0; transform: translateX(100px)} 5%{opacity:1; transform: translateX(0)} 95%{opacity:1; transform: translateX(0)} 100%{opacity:0; transform: translateX(100px)} }

/* ABA DE VENDAS */
.sale-item{border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; background: rgba(255,255,255,0.05);}
.sale-item img{width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid var(--main-gold);}
.sale-info{flex-grow: 1;}
.sale-info p{margin: 0.2rem 0;}
.sale-info .price-real{color: #4CAF50; font-weight: bold;}
.sale-info .contact-btn{background: #25D366; color: #fff; text-decoration: none; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; margin-left: 10px;}

@media(max-width:880px){ .container{grid-template-columns:1fr; padding:.5rem; margin-top: 1rem} .menu{order:2} }
</style>
</head>
<body>
<div class="bg3d" aria-hidden="true"></div>
<div class="overlay" aria-hidden="true"></div>

<header>
  <h1>IVAD TROCAS E VENDAS</h1>
  <p>Criado por IVADCREATOR</p>
</header>

<main class="container">
  <aside class="card menu">
    <button class="tabbtn active" data-tab="regrasTab">REGRAS</button>
    <button class="tabbtn" data-tab="jogoTab">üéÆ JOGUINHOS (Sorte Extrema)</button>
    <button class="tabbtn" data-tab="salesTab">üí∞ VENDAS (Dinheiro Real)</button>
    <button class="tabbtn" data-tab="rankTab">üèÜ RANK GLOBAL</button>
    <button class="tabbtn" data-tab="chatTab">üí¨ CHAT GLOBAL</button>
    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">

    <div id="authArea" class="small">
      <div id="signedOutUI">
        <input id="username" type="text" placeholder="Escolha um nome (sem espa√ßos)">
        <input id="pwd" type="password" placeholder="Senha (‚â•6)">
        <div style="display:flex;gap:.5rem">
          <button id="btnSignup" class="btn" style="background:var(--btn-blue); flex-grow: 1;">Criar conta</button>
          <button id="btnLogin" class="btn" style="flex-grow: 1;">Entrar</button>
        </div>
        <p class="small" style="margin-top: 5px;">Nome √∫nico (A-z, 0-9, _).</p>
      </div>

      <div id="signedInUI" style="display:none">
        <p style="margin-bottom: .8rem;"><strong id="userLabel"></strong></p>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="btnLogout" class="btn" style="background:var(--btn-red); padding: .6rem 1rem;">Sair</button>
          <div style="margin-left:auto; font-size: 1.2rem;"><span class="small" style="color:var(--main-gold);">Gold: </span><strong id="myGold">0</strong></div>
        </div>
      </div>
    </div>

    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
    <div id="ownerPanel" style="display:none">
      <h4 style="margin:.3rem 0; color: #e57373;">Painel do Dono</h4>
      <input id="adminName" placeholder="nome do usu√°rio (exact)">
      <input id="adminAmount" type="number" placeholder="gold (+/-)">
      <button id="btnGive" class="btn" style="width: 100%; margin-top: .5rem; background: var(--btn-blue);">Dar/Remover gold</button>
      <button id="btnReset" class="btn" style="background:var(--btn-red);margin-top:.5rem; width: 100%;">Resetar ranking</button>
      <button id="btnClearChat" class="btn" style="background:var(--btn-red);margin-top:.5rem; width: 100%;">Limpar Chat Global</button>
      <p class="small" style="margin-top: 5px;">Somente OWNER_UID pode usar</p>
    </div>
    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
    <p class="small">Ranking salvo no Firestore.</p>
    <p class="small">Visitantes online: <strong id="visitorCount">0</strong></p>
  </aside>

  <section class="card content">
    <div id="regrasTab">
      <h2>Regras</h2>
      <h3>üö´ Proibido</h3>
      <ul>
        <li>**Spam** ou flood de mensagens repetitivas.</li>
        <li>Compartilhar **conte√∫do NSFW** (banimento imediato se detectado!).</li>
        <li>**Avaliar contas** de outros membros.</li>
        <li>Ofensas, xingamentos ou **desrespeito** m√∫tuo.</li>
        <li>Vendas de itens ilegais ou roubados.</li>
      </ul>
      <h3>‚úÖ Permitido</h3>
      <ul>
        <li>Anunciar itens por dinheiro real na aba de Vendas.</li>
        <li>Comprar e vender produtos de forma **clara e transparente**.</li>
        <li>Negociar e interagir com **bom senso** e educa√ß√£o.</li>
      </ul>
      <h3>‚ö†Ô∏è Observa√ß√µes</h3>
      <ul>
        <li>Descumprimento pode levar a **banimento**.</li>
        <li>Negocia√ß√µes s√£o **responsabilidade das partes**.</li>
        <li>O Chat √© monitorado para garantir um ambiente saud√°vel.</li>
      </ul>
    </div>

    <div id="jogoTab" style="display:none">
      <h2>üéÆ Cassino: Jogos de Sorte Extrema</h2>
      
      <div id="playerInfo" class="card" style="margin-bottom:1.5rem; padding: .8rem; background: rgba(255,255,255,0.15); display:none;">
        <p style="margin: 0;">Seu Gold: <strong id="playerGold" style="color: var(--main-gold);">0</strong></p>
      </div>

      <p class="small">Clique <strong>Trabalhar</strong>. Ganho varia de **1% a 100%** do seu Gold atual. (Cooldown: 5s)</p>
      <button id="btnWork" class="btn">Trabalhar (Gold Aleat√≥rio)</button>
      <span id="workMsg" class="small" style="margin-left:1rem; color: #90caf9;"></span>

      <hr style="border:none;height:1px;background:var(--border-color);margin:20px 0">

      <h3 style="margin-top: 1rem;">Aposta Simples (2x)</h3>
      <p class="small">Chance de 50%. Ganha 2x o que apostou se acertar, **perde o valor se errar**.</p>
      <input type="number" id="betAmount" placeholder="Quantos golds apostar?" min="1">
      <button id="btnBetSimple" class="btn">Apostar 2x</button>
      <span id="betMsgSimple" class="small" style="color: #ffd54f;"></span>

      <h3 style="margin-top: 2rem;">Aposta M√©dia (5x)</h3>
      <p class="small">Chance de 20%. Ganha 5x o que apostou, **perde o valor se errar**.</p>
      <input type="number" id="betAmountMedium" placeholder="Quantos golds apostar?" min="1">
      <button id="btnBetMedium" class="btn" style="background:var(--btn-blue)">Apostar 5x</button>
      <span id="betMsgMedium" class="small" style="color: #90caf9;"></span>

      <h3 style="margin-top: 2rem;">Aposta Alta (10x)</h3>
      <p class="small">Chance de 10%. Ganha 10x o que apostou, **perde o valor se errar**.</p>
      <input type="number" id="betAmountHigh" placeholder="Quantos golds apostar?" min="1">
      <button id="btnBetHigh" class="btn" style="background:var(--btn-red)">Apostar 10x</button>
      <span id="betMsgHigh" class="small" style="color: #ef9a9a;"></span>
    </div>

    <div id="salesTab" style="display:none">
      <h2>üí∞ Vendas por Dinheiro Real (R$)</h2>
      <p class="small">Publique sua conta ou item! O contato √© feito diretamente via WhatsApp.</p>
      
      <div class="card" style="background: rgba(0,0,0,0.4); margin-bottom: 2rem;">
        <h4>Publicar Novo Item</h4>
        <input type="text" id="saleTitle" placeholder="T√≠tulo do Item (Ex: Conta N√≠vel 50)">
        <input type="number" id="salePriceReal" placeholder="Pre√ßo em Reais (R$)" min="1">
        <input type="text" id="saleContact" placeholder="N√∫mero de WhatsApp (apenas n√∫meros)">
        <textarea id="saleDescription" placeholder="Descri√ß√£o detalhada do item." rows="3"></textarea>
        
        <label style="display:block; margin-top:.5rem;">Foto do Item (PNG/JPG):</label>
        <input type="file" id="saleImage" accept="image/*" style="margin-bottom: 1rem;">
        <p class="small" style="color: #e57373;">‚ö†Ô∏è **Moderac√£o Obrigat√≥ria:** O upload de imagens e a detec√ß√£o de **conte√∫do √≠ntimo/NSFW** exigem Cloud Functions para banimento e exclus√£o da foto.</p>

        <button id="btnSubmitSale" class="btn" style="width: 100%;">Publicar Venda</button>
      </div>

      <h4>Itens Atuais (Mockup)</h4>
      <div id="saleList">
        <div class="sale-item">
            <img src="https://via.placeholder.com/80?text=Conta" alt="Conta N√≠vel 50">
            <div class="sale-info">
                <p><strong>Conta Rara (N√≠vel 50)</strong></p>
                <p class="small">Vendedor: OWNER_UID</p>
                <p class="price-real">R$ 350,00</p>
            </div>
            <a href="https://wa.me/5511999999999" target="_blank" class="contact-btn">CHAMAR NO ZAP</a>
        </div>
        <div class="sale-item">
            <img src="https://via.placeholder.com/80?text=Item" alt="Item Exclusivo">
            <div class="sale-info">
                <p><strong>Skin Exclusiva (Rar√≠ssima)</strong></p>
                <p class="small">Vendedor: JogadorTeste</p>
                <p class="price-real">R$ 15,00</p>
            </div>
            <a href="https://wa.me/5511988888888" target="_blank" class="contact-btn">CHAMAR NO ZAP</a>
        </div>
      </div>
    </div>

    <div id="rankTab" style="display:none">
      <h2>üèÜ Rank Global</h2>
      <p class="small">Top 50 jogadores (atualiza a cada 5 segundos)</p>
      <div class="rank-list card" id="rankList"></div>
    </div>

    <div id="chatTab" style="display:none">
      <h2>üí¨ Chat Global Din√¢mico</h2>
      <div class="chat-box" id="chatBox"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem ou grave um √°udio..." style="margin: 0;">
        <button id="btnRecordAudio" class="btn" title="Gravar √Åudio (M√°x 15s)">üé§</button>
        <button id="btnSendChat" class="btn">Enviar</button>
      </div>
      <p class="small" style="margin-top: 5px; color: #ffb300;">üé§ √Åudio: Gravado e salvo diretamente no banco de dados (m√°x 15s). Evite gravar √°udios longos.</p>
    </div>
  </section>
</main>

<div id="globalNotice"></div>

<footer>¬© 2025 IVAD TROCAS E VENDAS | IVADCREATOR</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// ===================================
// ‚öôÔ∏è CONFIGURA√á√ïES FIREBASE
// ===================================
const firebaseConfig = {
  apiKey: "AIzaSyCkmyMqEJaM8jVvmTN8I3gLnbC8YtMPWOI",
  authDomain: "regras-ivad.firebaseapp.com",
  projectId: "regras-ivad",
  storageBucket: "regras-ivad.firebasestorage.app",
  messagingSenderId: "812565896201",
  appId: "1:812565896201:android:afc3bddd8edb14071aacd8"
};
const OWNER_UID = "m3h06woQv2V7lrNu1p8fDQCZ8IW2"; 

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage(); 

// ===================================
// üéØ ELEMENTOS DO DOM
// ===================================
const elements = {
    signedOutUI: document.getElementById('signedOutUI'),
    signedInUI: document.getElementById('signedInUI'),
    userLabel: document.getElementById('userLabel'),
    myGold: document.getElementById('myGold'),
    playerGold: document.getElementById('playerGold'),
    playerInfo: document.getElementById('playerInfo'),
    chatBox: document.getElementById('chatBox'),
    chatInput: document.getElementById('chatInput'),
    rankList: document.getElementById('rankList'),
    visitorCounter: document.getElementById('visitorCount'),
    workMsg: document.getElementById('workMsg'),
    globalNotice: document.getElementById('globalNotice'),
    btnWork: document.getElementById('btnWork'),
    btnBetSimple: document.getElementById('btnBetSimple'),
    btnBetMedium: document.getElementById('btnBetMedium'),
    btnBetHigh: document.getElementById('btnBetHigh'),
    betMsgSimple: document.getElementById('betMsgSimple'),
    betMsgMedium: document.getElementById('betMsgMedium'),
    betMsgHigh: document.getElementById('betMsgHigh'),
    btnRecordAudio: document.getElementById('btnRecordAudio'),
    btnSendChat: document.getElementById('btnSendChat')
};

// ===================================
// üí° FUN√á√ïES AUXILIARES
// ===================================

function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function showTab(id){
  ['regrasTab','jogoTab','rankTab','chatTab','salesTab'].forEach(t=>document.getElementById(t).style.display=(t===id?'block':'none'));
}
document.querySelectorAll('.tabbtn').forEach(b=>{
  b.addEventListener('click',e=>{
    document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    showTab(e.currentTarget.dataset.tab);
  });
});
showTab('regrasTab');

function usernameToEmail(u){ return `${u}@ivad.local`; }
function validUsername(u){ return /^[a-zA-Z0-9_]{3,20}$/.test(u); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function showNotification(message) {
  const el = elements.globalNotice;
  el.textContent = message;
  el.style.animation = 'none';
  el.offsetHeight; 
  el.style.animation = 'fadeInOut 4.5s cubic-bezier(0.19, 1, 0.22, 1) forwards';
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

// ===================================
// üîí AUTENTICA√á√ÉO E ESTADO DO USU√ÅRIO
// ===================================
document.getElementById('btnSignup').onclick = async ()=>{
  const uname = document.getElementById('username').value.trim();
  const pw = document.getElementById('pwd').value;
  if(!validUsername(uname)){ showNotification('Nome de usu√°rio inv√°lido (3-20 caracteres, sem espa√ßos/caracteres especiais, exceto _).'); return; }
  if(pw.length<6){ showNotification('Senha precisa ter 6 ou mais caracteres.'); return; }
  try{
    const q = await db.collection('users').where('displayName','==',uname).limit(1).get();
    if(!q.empty){ showNotification('Nome de usu√°rio j√° existe, escolha outro.'); return; }
    await auth.createUserWithEmailAndPassword(usernameToEmail(uname), pw);
    showNotification('Conta criada! Voc√™ j√° est√° logado.');
  }catch(err){ console.error(err); showNotification('Erro ao criar conta: '+err.message); }
};

document.getElementById('btnLogin').onclick = async ()=>{
  const uname = document.getElementById('username').value.trim();
  const pw = document.getElementById('pwd').value;
  if(!validUsername(uname)){ showNotification('Nome de usu√°rio inv√°lido.'); return; }
  if(pw.length<6){ showNotification('Senha precisa ter 6 ou mais caracteres.'); return; }
  try{ await auth.signInWithEmailAndPassword(usernameToEmail(uname), pw); }
  catch(err){ console.error(err); showNotification('Erro ao entrar: '+err.message); }
};

document.getElementById('btnLogout').onclick = ()=>auth.signOut();

auth.onAuthStateChanged(async user=>{
  if(user){
    elements.signedOutUI.style.display='none';
    elements.signedInUI.style.display='block';
    const displayName = user.email ? user.email.split('@')[0] : user.uid;
    elements.userLabel.textContent = `Conectado: ${displayName}`;
    
    const userRef = db.collection('users').doc(user.uid);
    const doc = await userRef.get();
    if (!doc.exists) {
        await userRef.set({
            uid: user.uid,
            email: user.email,
            displayName: displayName,
            gold: 100, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    if(user.uid === OWNER_UID) document.getElementById('ownerPanel').style.display='block';
    else document.getElementById('ownerPanel').style.display='none';
    
    db.collection('users').doc(user.uid).onSnapshot(doc => {
        if(doc.exists){
            const gold = Number(doc.data().gold||0);
            const goldFormatted = gold.toLocaleString('pt-BR');
            elements.myGold.textContent = goldFormatted;
            elements.playerGold.textContent = goldFormatted;
            elements.playerInfo.style.display='block';
        }
    });

    loadChat();
    reloadRank();
  }else{
    elements.signedOutUI.style.display='block';
    elements.signedInUI.style.display='none';
    document.getElementById('ownerPanel').style.display='none';
    elements.myGold.textContent='0';
    elements.playerInfo.style.display='none';
  }
});


// ===================================
// üéÆ JOGOS E ALEATORIEDADE (1%-100%)
// ===================================
let lastWork=0;
elements.btnWork.onclick=async ()=>{
  const user = auth.currentUser;
  if(!user){ showNotification('Fa√ßa login para trabalhar.'); return; }
  
  const now = Date.now();
  const cooldown = 5000;
  if(now-lastWork<cooldown){ 
    elements.workMsg.textContent=`Aguarde ${Math.ceil((cooldown - (now - lastWork)) / 1000)}s`; 
    return; 
  }
  lastWork=now;
  
  elements.btnWork.disabled = true;
  elements.workMsg.textContent='Buscando Gold...';
  
  try{
    const userRef = db.collection('users').doc(user.uid);
    await db.runTransaction(async tx=>{
      const d = await tx.get(userRef);
      if(!d.exists) throw new Error('Usu√°rio n√£o encontrado');
      
      const currentGold = d.data().gold || 0;
      
      const percentage = getRandomInt(1, 100); 
      const baseGold = currentGold > 0 ? currentGold : 100; 
      const gain = Math.round(baseGold * (percentage / 100)); 
      
      const newGold = currentGold + gain;
      tx.update(userRef,{gold:newGold});
      
      elements.workMsg.textContent=`üí∞ Ganhou ${gain.toLocaleString('pt-BR')} gold! (+${percentage}%)`;
    });
    reloadRank();
  }catch(err){ 
    console.error(err); 
    elements.workMsg.textContent='Erro!';
    showNotification('Erro ao trabalhar: '+err.message); 
  } finally {
    setTimeout(() => { elements.btnWork.disabled = false; elements.workMsg.textContent=''; }, cooldown);
  }
};

/**
 * Fun√ß√£o gen√©rica para lidar com todas as apostas.
 * **CORRIGIDO: A subtra√ß√£o do Gold na perda agora est√° funcionando.**
 */
async function handleBet(amountInput, multiplier, winChance, msgEl, btn) {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login para apostar.'); return; }
    
    const amt = Number(amountInput.value);
    if(isNaN(amt) || amt<=0){ showNotification('Insira um valor v√°lido (m√≠nimo 1 gold).'); return; }
    
    btn.disabled = true;
    msgEl.textContent = 'Aguarde, jogando os dados...';
    
    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
            
            const currentGold = doc.data().gold || 0;
            if(currentGold < amt){ throw new Error('Gold insuficiente para esta aposta.'); }
            
            const roll = Math.random(); 
            const win = roll < winChance;
            
            let diff;
            
            if (win) {
                // Ganha o valor apostado * multiplicador
                const gain = amt * multiplier;
                diff = gain; 
            } else {
                // Perde exatamente o valor apostado
                diff = -amt; 
            }

            const newGold = currentGold + diff;

            tx.update(userRef, { gold: newGold });

            if (win) {
                msgEl.textContent = `üèÜ VITORIA! Voc√™ ganhou ${diff.toLocaleString('pt-BR')} gold! (Chance: ${Math.round(winChance*100)}%)`;
            } else {
                msgEl.textContent = `üòî DERROTA! Voc√™ perdeu ${amt.toLocaleString('pt-BR')} gold. (Sorte: ${Math.round(roll*100)}%)`;
            }
        });
        reloadRank();
    } catch(err) {
        console.error(err); 
        msgEl.textContent = 'Erro na aposta!';
        showNotification('Erro na aposta: '+err.message);
    } finally {
        btn.disabled = false;
        setTimeout(() => msgEl.textContent='', 3000);
    }
}

// Aposta Simples (2x) - Chance de 50%
elements.btnBetSimple.onclick=()=> {
    handleBet(document.getElementById('betAmount'), 2, 0.5, elements.betMsgSimple, elements.btnBetSimple);
};

// Aposta M√©dia (5x) - Chance de 20%
elements.btnBetMedium.onclick=()=> {
    handleBet(document.getElementById('betAmountMedium'), 5, 0.2, elements.betMsgMedium, elements.btnBetMedium);
};

// Aposta Alta (10x) - Chance de 10%
elements.btnBetHigh.onclick=()=> {
    handleBet(document.getElementById('betAmountHigh'), 10, 0.1, elements.betMsgHigh, elements.btnBetHigh);
};

// ===================================
// üèÜ RANK GLOBAL
// ===================================
async function reloadRank(){
  try {
    const snap=await db.collection('users').orderBy('gold','desc').limit(50).get();
    let html='<ol>';
    snap.forEach((doc, index)=>{
      const d=doc.data();
      const goldFormatted = Number(d.gold||0).toLocaleString('pt-BR');
      html+=`<li><span>${index + 1}.</span> <strong>${escapeHtml(d.displayName||'Usu√°rio')}</strong> <span>${goldFormatted} gold</span></li>`;
    });
    html+='</ol>';
    elements.rankList.innerHTML=html;
  } catch (err) {
    console.error("Erro ao carregar rank:", err);
    elements.rankList.innerHTML = `<p class="small" style="color: #e57373;">Erro ao carregar o ranking.</p>`;
  }
}
setInterval(reloadRank, 5000); 

// ===================================
// üí¨ CHAT GLOBAL
// ===================================

/** Converte Base64 para Blob para tocar √°udio */
function b64toBlob(b64Data, contentType, sliceSize=512) {
  const byteCharacters = atob(b64Data);
  const byteArrays = [];

  for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
    const slice = byteCharacters.slice(offset, offset + sliceSize);
    const byteNumbers = new Array(slice.length);
    for (let i = 0; i < slice.length; i++) {
      byteNumbers[i] = slice.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    byteArrays.push(byteArray);
  }
  
  const blob = new Blob(byteArrays, {type: contentType});
  return blob;
}

async function loadChat(){
  db.collection('chat').orderBy('timestamp','desc').limit(50).onSnapshot(snapshot=>{
    elements.chatBox.innerHTML='';
    const messages = [];
    snapshot.forEach(doc=>{ messages.push(doc.data()); });
    messages.reverse().forEach(msg => { 
      const el = document.createElement('div');
      el.classList.add('chat-msg');
      const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '...';
      const userDisplayName = escapeHtml(msg.user);
      
      let contentHTML = `<strong>${userDisplayName}</strong>: `;

      if (msg.audioBase64) {
          // √â uma mensagem de √°udio (Base64)
          const audioBlob = b64toBlob(msg.audioBase64, msg.audioMimeType || 'audio/webm');
          const audioUrl = URL.createObjectURL(audioBlob);
          contentHTML += '<span style="color:#90caf9;">[√Åudio]</span>';
          contentHTML += `<audio controls class="audio-player" src="${audioUrl}"></audio>`;

      } else {
          // √â uma mensagem de texto
          const textContent = escapeHtml(msg.text);
          contentHTML += textContent;
      }
      
      el.innerHTML = `[${time}] ${contentHTML}`;
      elements.chatBox.appendChild(el);
    });
    elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
  });
}

// Envio de Texto
elements.btnSendChat.onclick=async ()=>{
  const user = auth.currentUser;
  if(!user){ showNotification('Fa√ßa login para enviar mensagens.'); return; }
  const text = elements.chatInput.value.trim();
  if(!text || text.length > 150){ showNotification('A mensagem deve ter entre 1 e 150 caracteres.'); return; }

  try {
    await db.collection('chat').add({
      user: user.email.split('@')[0],
      text: text, 
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    elements.chatInput.value='';
  } catch (err) {
    console.error(err); showNotification('Erro ao enviar mensagem: '+err.message);
  }
};

// --- Sistema de Grava√ß√£o de √Åudio ---
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

elements.btnRecordAudio.onclick = async () => {
    if (!auth.currentUser) {
        showNotification('Fa√ßa login para gravar √°udio.');
        return;
    }
    
    if (isRecording) {
        // PARAR a grava√ß√£o
        mediaRecorder.stop();
        isRecording = false;
        elements.btnRecordAudio.classList.remove('recording');
        elements.chatInput.placeholder = "Processando √°udio...";
        elements.btnSendChat.disabled = true;
    } else {
        // INICIAR a grava√ß√£o
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = async () => {
                    const base64Data = reader.result.split(',')[1]; // Pega a Base64 pura
                    const mimeType = audioBlob.type;
                    
                    try {
                        await db.collection('chat').add({
                            user: auth.currentUser.email.split('@')[0],
                            audioBase64: base64Data,
                            audioMimeType: mimeType,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showNotification('√Åudio enviado com sucesso!');
                    } catch (err) {
                        console.error('Erro ao enviar √°udio:', err);
                        showNotification('Erro ao enviar √°udio. Tente novamente.');
                    } finally {
                         // Libera o microfone
                        stream.getTracks().forEach(track => track.stop()); 
                        elements.chatInput.placeholder = "Digite sua mensagem ou grave um √°udio...";
                        elements.btnSendChat.disabled = false;
                    }
                };
            };

            mediaRecorder.start();
            isRecording = true;
            elements.btnRecordAudio.classList.add('recording');
            elements.chatInput.placeholder = "Gravando... (m√°x 15s)";
            
            // Define um limite de tempo para n√£o estourar o limite do Firestore
            setTimeout(() => {
                if(isRecording) {
                    showNotification("Grava√ß√£o de √°udio parou (limite de 15s). Enviando...");
                    mediaRecorder.stop();
                }
            }, 15000); 

        } catch (err) {
            console.error('Permiss√£o de √°udio negada:', err);
            showNotification('Permiss√£o de microfone negada ou indispon√≠vel.');
        }
    }
};


// ===================================
// üí∞ VENDAS (AN√öNCIOS POR DINHEIRO REAL)
// ===================================
document.getElementById('btnSubmitSale').onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
        showNotification('Fa√ßa login para publicar uma venda.');
        return;
    }
    
    const title = document.getElementById('saleTitle').value.trim();
    const price = Number(document.getElementById('salePriceReal').value);
    const contact = document.getElementById('saleContact').value.trim();
    const description = document.getElementById('saleDescription').value.trim();
    const file = document.getElementById('saleImage').files[0];
    
    if (!title || isNaN(price) || price <= 0 || !contact || !description || !file) {
        showNotification('Preencha todos os campos corretamente (T√≠tulo, Pre√ßo R$, Contato, Descri√ß√£o e Imagem).');
        return;
    }
    
    try {
        // 1. Upload da Imagem para o Firebase Storage
        const filePath = `sales_images/${user.uid}_${Date.now()}_${file.name}`;
        const storageRef = storage.ref(filePath);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                showNotification(`Upload em andamento: ${Math.round(progress)}%`);
            }, 
            (error) => {
                console.error("Erro no upload:", error);
                showNotification('Erro ao fazer upload da imagem.');
            }, 
            async () => {
                const downloadURL = await storageRef.getDownloadURL();
                
                // 2. Salvar o An√∫ncio no Firestore
                // Lembrete: A modera√ß√£o/banimento de imagem NSFW precisa de Cloud Functions aqui!
                await db.collection('sales').add({
                    sellerUid: user.uid,
                    sellerName: user.email.split('@')[0],
                    title: title,
                    priceReal: price,
                    contact: contact,
                    description: description,
                    imageUrl: downloadURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('‚úÖ An√∫ncio Publicado! O banimento por NSFW deve ser ativado via Cloud Functions.');

                document.getElementById('saleTitle').value = '';
                document.getElementById('salePriceReal').value = '';
                document.getElementById('saleContact').value = '';
                document.getElementById('saleDescription').value = '';
                document.getElementById('saleImage').value = '';
            }
        );

    } catch (err) {
        console.error(err);
        showNotification('Erro ao publicar an√∫ncio: '+err.message);
    }
};


// ===================================
// üìà CONTADOR DE VISITANTES
// ===================================
if (!sessionStorage.getItem('visited')) {
  db.collection('visitors').doc('count').update({total:firebase.firestore.FieldValue.increment(1)})
    .catch(() => db.collection('visitors').doc('count').set({total:1})); 
  sessionStorage.setItem('visited', 'true');
}

db.collection('visitors').doc('count').onSnapshot(doc=>{
  elements.visitorCounter.textContent = doc.data()?.total?.toLocaleString('pt-BR') || 0;
});


// ===================================
// üëë PAINEL DO DONO (Admin)
// ===================================
document.getElementById('btnGive').onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.uid!==OWNER_UID){ showNotification('Acesso negado.'); return; }
  const uname = document.getElementById('adminName').value.trim();
  const amount = Number(document.getElementById('adminAmount').value);
  if(!uname || isNaN(amount)){ showNotification('Preencha corretamente o nome e a quantidade.'); return; }

  try {
    const q = await db.collection('users').where('displayName','==',uname).limit(1).get();
    if(q.empty){ showNotification('Usu√°rio n√£o encontrado.'); return; }
    const docSnapshot = q.docs[0];
    const userRef = docSnapshot.ref;
    await userRef.update({gold: firebase.firestore.FieldValue.increment(amount)});
    
    reloadRank();
    const action = amount >= 0 ? 'adicionado' : 'removido';
    showNotification(`${Math.abs(amount).toLocaleString('pt-BR')} gold ${action} para ${uname}.`);

  } catch(err) {
    console.error(err);
    showNotification('Erro na transa√ß√£o de gold: '+err.message);
  }
};

document.getElementById('btnReset').onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.uid!==OWNER_UID){ showNotification('Acesso negado.'); return; }
  if(!confirm('ATEN√á√ÉO: Certeza que deseja ZERAR o GOLD de TODOS os jogadores? Esta a√ß√£o √© irrevers√≠vel.')) return;

  try {
    const snap = await db.collection('users').get();
    const batch = db.batch();
    snap.forEach(doc => {
       batch.update(doc.ref, { gold: 0 });
    });
    await batch.commit();
    showNotification('Ranking COMPLETAMENTE RESETADO! Gold zerado.');
    reloadRank();
  } catch(err) {
    console.error(err);
    showNotification('Erro ao resetar o ranking: '+err.message);
  }
};

document.getElementById('btnClearChat').onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.uid!==OWNER_UID){ showNotification('Acesso negado.'); return; }
  if(!confirm('ATEN√á√ÉO: Certeza que deseja APAGAR TODAS as mensagens do Chat Global?')) return;

  try {
    const snap = await db.collection('chat').get();
    const batch = db.batch();
    snap.forEach(doc => {
       batch.delete(doc.ref);
    });
    await batch.commit();
    showNotification('Chat Global limpo com sucesso.');
  } catch(err) {
    console.error(err);
    showNotification('Erro ao limpar o chat: '+err.message);
  }
};
</script>
</body>
</html>
