<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat com Mural e Regras</title>
    <style>
        /* ESTILOS CSS */
        body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; background-color: #f4f4f9; }
        .sidebar { width: 250px; background-color: #333; color: white; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .tabbtn { background: #555; color: white; border: none; padding: 10px; margin-bottom: 10px; text-align: left; cursor: pointer; transition: background 0.3s; border-radius: 4px; }
        .tabbtn:hover { background: #666; }
        .tabbtn.active { background: #007bff; }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Estilos do Mural */
        #mural { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 20px; }
        .post { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .post-content { flex-grow: 1; }
        .post-author { font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .post-text { margin-bottom: 5px; }
        .post-time { font-size: 0.8em; color: #888; text-align: right; }
        .delete-btn { background: none; border: none; color: red; cursor: pointer; font-size: 1.2em; margin-left: 10px; opacity: 0.7; transition: opacity 0.2s; }
        .delete-btn:hover { opacity: 1; }
        
        /* Estilos de Autenticação */
        #auth-status { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #eee; }
        #auth-buttons button { padding: 8px 15px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
        #google-login-btn { background-color: #db4437; color: white; }
        #logout-btn { background-color: #aaa; color: #333; }

        /* Estilos do Formulário */
        #post-form { display: flex; margin-bottom: 20px; }
        #post-text { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; }
        #post-form button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #post-form button:disabled { background-color: #ccc; cursor: not-allowed; }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
</head>
<body>

    <div class="sidebar">
        <h2>Menu</h2>
        <button class="tabbtn active" data-tab="regrasTab">Regras</button>
        <button class="tabbtn" data-tab="muralTab">Mural de Mensagens</button>
        <button class="tabbtn" data-tab="adminTab">Admin</button>

        <div id="auth-status">
            <p>Status: <span id="user-status">Não Logado</span></p>
            <p>Usuário: <span id="user-name">Anônimo</span></p>
            <div id="auth-buttons">
                <button id="google-login-btn">Entrar com Google</button>
                <button id="logout-btn" style="display: none;">Sair</button>
            </div>
        </div>

        <p style="margin-top: auto; font-size: 0.9em; text-align: center;">Visitantes Online: <span id="visitorCount">0</span></p>
    </div>

    <div class="content">

        <div id="regrasTab" class="tab-content active">
            <h1>Regras e Boas Práticas</h1>
            <p>Leia atentamente as regras para manter um ambiente saudável:</p>
            <ul>
                <li>Respeito mútuo é fundamental.</li>
                <li>Proibido conteúdo ofensivo, ilegal ou spam.</li>
                <li>Mensagens no mural expiram a cada 24 horas.</li>
            </ul>
        </div>

        <div id="muralTab" class="tab-content">
            <h1>Mural de Mensagens</h1>

            <div id="post-controls">
                <form id="post-form">
                    <input type="text" id="post-text" placeholder="Escreva sua mensagem aqui..." required>
                    <button type="submit" id="submit-post-btn" disabled>Publicar</button>
                </form>
            </div>
            
            <div id="mural">
                </div>
        </div>

        <div id="adminTab" class="tab-content">
            <h1>Painel Administrativo</h1>
            <p id="admin-message">Acesso restrito. Faça login como administrador.</p>
            <div id="admin-controls" style="display:none;">
                <button id="clear-mural-btn">Limpar Mural (Todos os Posts)</button>
            </div>
        </div>

    </div>

    <script>
        // ----------------------------------------------------
        // 2. CONFIGURAÇÃO E INICIALIZAÇÃO DO FIREBASE
        // ----------------------------------------------------

        // CONFIGURAÇÕES (SUBSTITUA PELAS SUAS)
        const firebaseConfig = {
            apiKey: "AIzaSyCkmyMqEJaM8jVvmTN8I3gLnbC8YtMPWOI",
            authDomain: "AIzaSyCkmyMqEJaM8jVvmTN8I3gLnbC8YtMPWOI",
            projectId: "812565896201",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Importação de Funções Modulares (v9)
        const { initializeApp } = firebase;
        const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously } = firebase.auth;
        const { getFirestore, collection, doc, addDoc, getDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, limit, deleteField, writeBatch, serverTimestamp, increment } = firebase.firestore;
        
        // Inicialização dos Serviços
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referências Comuns
        const postsColRef = collection(db, 'posts');
        const visitorDocRef = doc(db, 'visitors', 'online');
        const adminUid = "UID_DO_ADMINISTRADOR"; // SUBSTITUA PELO SEU UID DE ADMIN

        let currentUser = null; // Armazena o usuário autenticado

        // ----------------------------------------------------
        // 3. CONTROLE DE ABAS (CORRIGIDO)
        // ----------------------------------------------------

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tabbtn').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Lógica específica para a aba Admin
            if (tabId === 'adminTab') {
                updateAdminUI(currentUser);
            }
        }

        // ----------------------------------------------------
        // 4. AUTENTICAÇÃO
        // ----------------------------------------------------

        const provider = new GoogleAuthProvider();

        document.getElementById('google-login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Erro no login com Google:", error);
                alert(`Erro ao tentar logar: ${error.message}`);
            });
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).catch(error => {
                console.error("Erro ao fazer logout:", error);
            });
        });

        function updateAuthUI(user) {
            currentUser = user;
            const statusElement = document.getElementById('user-status');
            const nameElement = document.getElementById('user-name');
            const loginBtn = document.getElementById('google-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const postBtn = document.getElementById('submit-post-btn');
            const postInput = document.getElementById('post-text');
            
            if (user && !user.isAnonymous) {
                statusElement.textContent = 'Logado';
                nameElement.textContent = user.displayName || user.email;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                postBtn.disabled = false;
                postInput.disabled = false;
            } else {
                statusElement.textContent = user ? 'Anônimo' : 'Desconectado';
                nameElement.textContent = user ? 'Anônimo' : 'N/A';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                postBtn.disabled = true;
                postInput.disabled = true;
            }
            updateAdminUI(user);
        }

        function updateAdminUI(user) {
            const adminControls = document.getElementById('admin-controls');
            const adminMessage = document.getElementById('admin-message');
            
            if (user && user.uid === adminUid) {
                adminControls.style.display = 'block';
                adminMessage.textContent = 'Acesso Administrativo Concedido.';
            } else {
                adminControls.style.display = 'none';
                adminMessage.textContent = 'Acesso restrito. Faça login como administrador.';
            }
        }

        // ----------------------------------------------------
        // 5. MURAL - FUNÇÕES DE POSTAGEM
        // ----------------------------------------------------

        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const postText = document.getElementById('post-text').value.trim();
            if (!postText || !currentUser || currentUser.isAnonymous) {
                alert("Você precisa estar logado para publicar uma mensagem.");
                return;
            }

            try {
                // addDoc usando nova sintaxe (v9)
                await addDoc(postsColRef, {
                    author: currentUser.displayName || currentUser.email,
                    authorUid: currentUser.uid,
                    text: postText,
                    // serverTimestamp usando nova sintaxe (v9)
                    timestamp: serverTimestamp(), 
                    likes: 0
                });
                document.getElementById('post-text').value = '';
            } catch (error) {
                console.error("Erro ao adicionar post:", error);
                alert("Erro ao publicar a mensagem. Tente novamente.");
            }
        });

        // ----------------------------------------------------
        // 6. MURAL - FUNÇÕES DE RENDERIZAÇÃO E DELEÇÃO
        // ----------------------------------------------------
        
        function renderPost(post) {
            const postElement = document.createElement('div');
            postElement.classList.add('post');
            postElement.dataset.id = post.id;
            
            const content = `
                <div class="post-content">
                    <div class="post-author">${post.author || 'Anônimo'}</div>
                    <div class="post-text">${post.text}</div>
                </div>
                <div class="post-time">${post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'Publicando...'}</div>
            `;
            postElement.innerHTML = content;

            // Adicionar botão de delete se o usuário for o autor ou for admin
            if (currentUser && (currentUser.uid === post.authorUid || currentUser.uid === adminUid)) {
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Deletar Mensagem';
                deleteBtn.addEventListener('click', () => deletePost(post.id));
                postElement.appendChild(deleteBtn);
            }

            return postElement;
        }
        
        async function deletePost(postId) {
            if (!currentUser) return;

            const postRef = doc(db, 'posts', postId);
            
            // Verificação de segurança (opcional, mas bom)
            try {
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                    const postData = postSnap.data();
                    // Só permite deletar se for o autor OU o admin
                    if (currentUser.uid === postData.authorUid || currentUser.uid === adminUid) {
                        // deleteDoc usando nova sintaxe (v9)
                        await deleteDoc(postRef);
                    } else {
                        alert("Você só pode deletar suas próprias mensagens.");
                    }
                }
            } catch (error) {
                console.error("Erro ao deletar post:", error);
            }
        }

        // ----------------------------------------------------
        // 7. MURAL - ATUALIZAÇÃO EM TEMPO REAL
        // ----------------------------------------------------
        
        // query usando nova sintaxe (v9) - Ordena por timestamp e limita a 50
        const muralQuery = query(postsColRef, orderBy('timestamp', 'desc'), limit(50));

        // onSnapshot (listener) usando nova sintaxe (v9)
        onSnapshot(muralQuery, (snapshot) => {
            const mural = document.getElementById('mural');
            mural.innerHTML = ''; // Limpa o mural antes de atualizar
            
            snapshot.forEach(doc => {
                const postData = doc.data();
                const post = { id: doc.id, ...postData };
                mural.appendChild(renderPost(post));
            });
        });

        // ----------------------------------------------------
        // 8. ADMIN - LIMPAR MURAL (CORRIGIDO)
        // ----------------------------------------------------

        document.getElementById('clear-mural-btn').addEventListener('click', async () => {
            if (!currentUser || currentUser.uid !== adminUid) {
                alert("Apenas o administrador pode limpar o mural.");
                return;
            }
            if (!confirm("Tem certeza que deseja deletar TODAS as mensagens do mural? Esta ação é irreversível.")) {
                return;
            }

            try {
                const snapshot = await firebase.firestore.getDocs(postsColRef);
                
                // writeBatch usando nova sintaxe (v9)
                const batch = writeBatch(db); 
                
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                alert("Mural limpo com sucesso!");
            } catch (error) {
                console.error("Erro ao limpar mural:", error);
                alert("Erro ao limpar o mural. Verifique o console.");
            }
        });
        
        // ----------------------------------------------------
        // 9. CONTADOR DE VISITANTES ONLINE (CORRIGIDO)
        // ----------------------------------------------------
        
        async function updateVisitorCount() {
            // Verifica se está logado anonimamente ou normalmente
            const user = auth.currentUser;
            if (!user) return; // A inicialização tentará logar anonimamente
            
            const userRef = doc(db, 'onlineUsers', user.uid);
            
            // Tenta adicionar/atualizar o registro do usuário
            try {
                // setDoc usando nova sintaxe (v9)
                await setDoc(userRef, { 
                    // serverTimestamp usando nova sintaxe (v9)
                    last_seen: serverTimestamp(), 
                    // increment usando nova sintaxe (v9)
                    page_views: increment(1) 
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao atualizar status online:", e);
            }

            // Garante que o usuário seja removido ao fechar a aba
            window.addEventListener('beforeunload', async () => {
                await updateDoc(userRef, { last_seen: deleteField() }); // deleteField usando nova sintaxe (v9)
            });
        }
        
        // Listener para o contador total de visitantes
        // query e onSnapshot usando nova sintaxe (v9)
        onSnapshot(query(collection(db, 'onlineUsers'), firebase.firestore.where('last_seen', '!=', null)), (snapshot) => {
            document.getElementById('visitorCount').textContent = snapshot.size;
        });


        // ----------------------------------------------------
        // 10. INICIALIZAÇÃO E OUVINTES GLOBAIS
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // CORREÇÃO ESSENCIAL: Adiciona o listener de clique para todos os botões de aba
            document.querySelectorAll('.tabbtn').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Inicia a página na aba de Regras
            switchTab('regrasTab');

            // onAuthStateChanged usando nova sintaxe (v9)
            onAuthStateChanged(auth, user => {
                if (user && !user.isAnonymous) {
                     // Checa se o usuário está banido antes de prosseguir
                     getDoc(doc(db, 'bannedUsers', user.uid)).then(docSnapshot => {
                        if (docSnapshot.exists()) {
                            signOut(auth);
                            alert(`⚠️ Sua conta está BANIDA. Motivo: ${docSnapshot.data().reason}`);
                            return;
                        }
                        updateAuthUI(user);
                        updateVisitorCount();
                    }).catch(error => {
                        console.error("Erro ao checar banimento:", error);
                        updateAuthUI(user);
                        updateVisitorCount();
                    });
                } else {
                    updateAuthUI(user);
                    // Garante que haja um usuário anônimo se ninguém estiver logado
                    if (!user) {
                        signInAnonymously(auth).then(() => {
                           updateVisitorCount(); 
                        }).catch(error => console.error("Erro ao logar anonimamente:", error));
                    } else {
                         updateVisitorCount(); 
                    }
                }
            });

        });
    </script>
</body>
</html>
