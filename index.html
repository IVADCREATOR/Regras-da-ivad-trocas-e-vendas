<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVAD TROCAS E VENDAS - MULTIJOGOS</title>
<style>
/* VARS */
:root{
  --card-bg: rgba(0,0,0,0.85); 
  --btn-gradient: linear-gradient(90deg,#ffd54f,#ffb300);
  --btn-blue: linear-gradient(90deg,#90caf9,#42a5f5);
  --btn-red: linear-gradient(90deg,#ef9a9a,#e57373);
  --text-primary: #fff;
  --text-secondary: #c0c0c0;
  --main-gold: #ffb300;
  --border-color: rgba(255,255,255,0.15);
  --green-win: #4CAF50;
  --red-loss: #E57373;
}

/* BASE & LAYOUT */
html,body{height:100%;margin:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color:var(--text-primary);background:#000}
body{perspective:1000px;overflow-x:hidden}

.bg3d{
  position:fixed;inset:0;background:url('/* LINK RAW IMAGEM */') no-repeat center center;
  background-size:cover;z-index:-2;filter:contrast(0.92) saturate(0.95) brightness(0.9);
  transform-origin:center center;animation:float3d 18s ease-in-out infinite alternate;
}
@keyframes float3d{
  0%{transform:translateZ(0px) rotateY(0deg) rotateX(0deg) scale(1)}
  50%{transform:translateZ(12px) rotateY(2deg) rotateX(1deg) scale(1.01)}
  100%{transform:translateZ(0px) rotateY(-1deg) rotateX(-1deg) scale(1)}
}
.overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6))}

header{background:rgba(0,0,0,0.9);padding:1.4rem;text-align:center;position:relative;z-index:2;border-bottom: 3px solid var(--main-gold); box-shadow: 0 4px 15px rgba(0,0,0,0.7);}
header h1{margin:.2rem;font-size:2rem; letter-spacing: 3px; text-shadow: 0 0 10px rgba(255,179,0,0.8);}
header p{margin:.1rem;color:var(--text-secondary);font-size:0.95rem}

.container{max-width:1100px;margin:2rem auto;padding:1rem;display:grid;grid-template-columns:300px 1fr;gap:2rem}
.card{background:var(--card-bg);padding:1.5rem;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.9);border: 1px solid var(--border-color);}

/* MENU E ABAS */
.menu button{display:block;width:100%;margin-bottom:.8rem;padding:.9rem 1rem;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:var(--text-primary);font-weight:700;cursor:pointer;transition:all .2s}
.menu button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(255,179,0,0.4); background:rgba(255,255,255,0.15);}
.menu button.active{background:var(--btn-gradient);color:#111;transform:translateY(0);box-shadow:0 4px 10px rgba(0,0,0,0.5)}

/* CONTE√öDO */
.content h2{margin-top:0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 1.5rem; color: var(--main-gold);}
ul{padding-left:1.5rem}
.small{font-size:.85rem;color:var(--text-secondary)}

/* BOT√ïES GERAIS */
.btn{
  display:inline-block;padding:.8rem 1.5rem;border-radius:8px;border:none;background:var(--btn-gradient);color:#111;font-weight:700;cursor:pointer; 
  transition: all .2s; position: relative; overflow: hidden; transform: translateZ(0);
}
.btn:hover:not(:disabled){box-shadow: 0 0 20px rgba(255,179,0,0.5); transform: scale(1.02);}
.btn:disabled{opacity:0.6; cursor: not-allowed; filter: grayscale(100%);}
.btn::before { /* Efeito Shine */
    content: ''; position: absolute; top: 0; left: -75%; width: 50%; height: 100%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 100%);
    transform: skewX(-25deg); transition: all 0.7s;
}
.btn:not(:disabled):hover::before { left: 125%; }

/* INPUTS */
input[type="text"],input[type="password"],input[type=number],select,textarea{width:100%;padding:.9rem;margin:.5rem 0;border-radius:8px;border:1px solid rgba(255,255,255,0.3);background:rgba(0,0,0,0.5);color:var(--text-primary);box-sizing: border-box; transition: border-color .2s;}
input:focus, textarea:focus{outline: none; border-color: var(--main-gold);}

/* RANKING */
.rank-list{max-height:420px;overflow-y:auto;padding:1rem; background: rgba(0,0,0,0.4);}
.rank-list ol{padding-left: 0; margin: 0;}
.rank-list li{list-style: none; padding: .6rem 0; border-bottom: 1px dashed rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;}
.rank-list li strong{color: #fff;}
.rank-list li:nth-child(1) strong{color: var(--main-gold); text-shadow: 0 0 5px var(--main-gold);}
.rank-list li:nth-child(2) strong{color: #c0c0c0;}
.rank-list li:nth-child(3) strong{color: #cd7f32;}

/* CHAT */
.chat-box{max-height:300px;overflow-y:auto;background:rgba(0,0,0,0.5);padding:.75rem;margin-top:.75rem;border-radius:8px;border: 1px solid var(--border-color)}
.chat-msg{margin:.4rem 0; font-size: 0.9rem; word-wrap: break-word; color: #eee;}
.chat-msg strong{color: #42a5f5; margin-right: 5px; font-weight: 600;}
.chat-msg .audio-player{display: block; margin-top: 5px; width: 100%;}
.chat-input-area{margin-top:.75rem; display: flex; gap: 5px; flex-wrap: wrap; align-items: stretch;}
.chat-input-area input[type=text]{margin: 0; flex-grow: 1;}
.chat-input-area button{padding: 0 1.2rem; margin: 0; font-size: 1rem;}
#btnRecordAudio{background: var(--btn-blue); color: #fff; width: 50px; font-size: 1.2rem;}
#btnRecordAudio.recording{background: var(--btn-red); animation: pulse 1s infinite;}
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 115, 115, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 115, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 115, 115, 0); } }

/* JOGOS DE HABILIDADE */
.game-area{
    display: flex; flex-direction: column; gap: 15px;
}
.quiz-options button {
    display: block; width: 100%; margin-bottom: 5px; padding: 10px; border-radius: 6px;
    background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--border-color);
    cursor: pointer; transition: background .2s;
}
.quiz-options button:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
.quiz-options button.correct { background: var(--green-win); color: #000; }
.quiz-options button.incorrect { background: var(--red-loss); }

/* Jogo da Velha */
.tictactoe-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; max-width: 300px; margin: 10px auto;
}
.tictactoe-cell {
    width: 100px; height: 100px; background: rgba(255,255,255,0.1); display: flex;
    justify-content: center; align-items: center; font-size: 3rem; font-weight: bold;
    cursor: pointer; user-select: none; transition: background .2s; border-radius: 8px;
}
.tictactoe-cell:hover:not(.x):not(.o) { background: rgba(255,255,255,0.2); }
.tictactoe-cell.x { color: var(--btn-blue); }
.tictactoe-cell.o { color: var(--btn-red); }

/* APOSTAS AVAN√áADAS */
.bet-options { display: flex; gap: 20px; flex-wrap: wrap;}
.bet-option-card {
    flex: 1 1 30%; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;
    border: 1px solid var(--border-color); min-width: 180px;
}
/* Raspadinha */
.scratch-area { 
    width: 100%; height: 50px; background: #c0c0c0; border: 2px solid #fff; border-radius: 8px;
    display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
    font-weight: bold; color: #333; cursor: pointer; user-select: none; margin-top: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5) inset;
}
.scratched { background: #333; color: var(--main-gold); }

/* Roleta */
.prize-wheel {
    width: 100%; max-width: 250px; aspect-ratio: 1/1; border-radius: 50%;
    margin: 10px auto; background: conic-gradient(red 0 33%, blue 33% 66%, green 66% 100%);
    position: relative; transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
    border: 5px solid var(--main-gold);
}
.wheel-pointer {
    position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
    width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent;
    border-bottom: 15px solid var(--main-gold); z-index: 10;
}
/* SOCIAL / ID */
.user-id-box { 
    background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;
    text-align: center; border: 1px solid var(--main-gold);
}
.friend-list { max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;}
.friend-list li { list-style: none; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;}


/* NOTIFICA√á√ÉO GLOBAL */
#globalNotice{
    position:fixed;top:10px;right:10px;background:var(--main-gold);color:#111;padding:.9rem 1.8rem;border-radius:8px;display:none;z-index:9999;
    font-weight:700;box-shadow:0 4px 15px rgba(0,0,0,0.7);
    animation: fadeInOut 4.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
}
@keyframes fadeInOut { 0%{opacity:0; transform: translateX(100px)} 5%{opacity:1; transform: translateX(0)} 95%{opacity:1; transform: translateX(0)} 100%{opacity:0; transform: translateX(100px)} }

@media(max-width:880px){ .container{grid-template-columns:1fr; padding:.5rem; margin-top: 1rem} .menu{order:2} .bet-option-card { flex-basis: 100%;} }
</style>
</head>
<body>
<div class="bg3d" aria-hidden="true"></div>
<div class="overlay" aria-hidden="true"></div>

<header>
  <h1>IVAD TROCAS E VENDAS</h1>
  <p>Criado por IVADCREATOR</p>
</header>

<main class="container">
  <aside class="card menu">
    <button class="tabbtn active" data-tab="regrasTab">REGRAS</button>
    <button class="tabbtn" data-tab="socialTab">ü§ù SOCIAL (ID e Amigos)</button>
    <button class="tabbtn" data-tab="jogoSimplesTab">üí∞ GOLD SIMPLES (Trabalho/Apostas)</button>
    <button class="tabbtn" data-tab="apostasAvancadasTab">üé≤ APOSTAS AVAN√áADAS</button>
    <button class="tabbtn" data-tab="habilidadeTab">üß† JOGOS DE HABILIDADE</button>
    <button class="tabbtn" data-tab="salesTab">üí≤ VENDAS (Dinheiro Real)</button>
    <button class="tabbtn" data-tab="rankTab">üèÜ RANK GLOBAL</button>
    <button class="tabbtn" data-tab="chatTab">üí¨ CHAT GLOBAL</button>
    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">

    <div id="authArea" class="small">
      <div id="signedOutUI">
        <input id="username" type="text" placeholder="Escolha um nome (sem espa√ßos)">
        <input id="pwd" type="password" placeholder="Senha (‚â•6)">
        <div style="display:flex;gap:.5rem">
          <button id="btnSignup" class="btn" style="background:var(--btn-blue); flex-grow: 1;">Criar conta</button>
          <button id="btnLogin" class="btn" style="flex-grow: 1;">Entrar</button>
        </div>
        <p class="small" style="margin-top: 5px;">Nome √∫nico (A-z, 0-9, _).</p>
      </div>

      <div id="signedInUI" style="display:none">
        <p style="margin-bottom: .8rem;"><strong id="userLabel"></strong></p>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="btnLogout" class="btn" style="background:var(--btn-red); padding: .6rem 1rem;">Sair</button>
          <div style="margin-left:auto; font-size: 1.2rem;"><span class="small" style="color:var(--main-gold);">Gold: </span><strong id="myGold">0</strong></div>
        </div>
      </div>
    </div>

    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
    <div id="ownerPanel" style="display:none">
      <h4 style="margin:.3rem 0; color: #e57373;">Painel do Dono</h4>
      <input id="adminName" placeholder="nome do usu√°rio (exact)">
      <input id="adminAmount" type="number" placeholder="gold (+/-)">
      <button id="btnGive" class="btn" style="width: 100%; margin-top: .5rem; background: var(--btn-blue);">Dar/Remover gold</button>
      <button id="btnReset" class="btn" style="background:var(--btn-red);margin-top:.5rem; width: 100%;">Resetar ranking</button>
      <button id="btnClearChat" class="btn" style="background:var(--btn-red);margin-top:.5rem; width: 100%;">Limpar Chat Global</button>
      <p class="small" style="margin-top: 5px;">Somente OWNER_UID pode usar</p>
    </div>
    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
    <p class="small">Ranking salvo no Firestore.</p>
    <p class="small">Visitantes online: <strong id="visitorCount">0</strong></p>
  </aside>

  <section class="card content">
    <div id="regrasTab">
      <h2>Regras</h2>
      <h3>üö´ Proibido</h3>
      <ul>
        <li>**Spam** ou flood de mensagens repetitivas.</li>
        <li>Compartilhar **conte√∫do NSFW** (banimento imediato se detectado!).</li>
        <li>**Avaliar contas** de outros membros.</li>
        <li>Ofensas, xingamentos ou **desrespeito** m√∫tuo.</li>
        <li>Vendas de itens ilegais ou roubados.</li>
      </ul>
      <h3>‚úÖ Permitido</h3>
      <ul>
        <li>Anunciar itens por dinheiro real na aba de Vendas.</li>
        <li>Comprar e vender produtos de forma **clara e transparente**.</li>
        <li>Negociar e interagir com **bom senso** e educa√ß√£o.</li>
      </ul>
      <h3>‚ö†Ô∏è Observa√ß√µes</h3>
      <ul>
        <li>Descumprimento pode levar a **banimento**.</li>
        <li>Negocia√ß√µes s√£o **responsabilidade das partes**.</li>
        <li>O Chat √© monitorado para garantir um ambiente saud√°vel.</li>
      </ul>
    </div>

    <div id="socialTab" style="display:none">
      <h2>ü§ù Social: Amigos e ID</h2>
      <div id="playerInfoSocial" class="user-id-box" style="display:none;">
          <p style="margin: 0;"><span class="small" style="color:var(--main-gold);">Seu Nome: </span><strong id="socialUsername"></strong></p>
          <p style="margin: 5px 0 0 0;"><span class="small" style="color:var(--main-gold);">Seu ID √önico: </span><strong id="socialUserId"></strong></p>
          <p class="small" style="margin-top: 10px;">Use este ID para ser adicionado ou convidado para jogos.</p>
      </div>

      <h3 style="margin-top: 1.5rem;">Adicionar Amigo</h3>
      <input type="text" id="friendInput" placeholder="ID √önico ou Nome do Usu√°rio">
      <button id="btnAddFriend" class="btn" style="width: 100%; background: var(--btn-blue);">Adicionar</button>
      <span id="friendMsg" class="small" style="display: block; margin-top: 5px;"></span>

      <h3 style="margin-top: 2rem;">Minha Lista de Amigos (<span id="friendCount">0</span>)</h3>
      <ul class="friend-list" id="friendList">
        <p class="small" style="text-align: center;">Adicione amigos por ID para que eles apare√ßam aqui.</p>
      </ul>
    </div>

    <div id="jogoSimplesTab" style="display:none">
        <h2>üí∞ Gold Simples (Trabalho e Apostas)</h2>
      
      <div id="playerInfo" class="card" style="margin-bottom:1.5rem; padding: .8rem; background: rgba(255,255,255,0.15); display:none;">
        <p style="margin: 0;">Seu Gold: <strong id="playerGold" style="color: var(--main-gold);">0</strong></p>
      </div>

      <p class="small">Clique <strong>Trabalhar</strong>. Ganho varia de **1% a 100%** do seu Gold atual. (Cooldown: 5s)</p>
      <button id="btnWork" class="btn">Trabalhar (Gold Aleat√≥rio)</button>
      <span id="workMsg" class="small" style="margin-left:1rem; color: #90caf9;"></span>

      <hr style="border:none;height:1px;background:var(--border-color);margin:20px 0">

      <h3 style="margin-top: 1rem;">Aposta Simples (2x)</h3>
      <p class="small">Chance de 50%. Ganha 2x o que apostou se acertar, **perde o valor se errar**.</p>
      <input type="number" id="betAmount" placeholder="Quantos golds apostar?" min="1">
      <button id="btnBetSimple" class="btn">Apostar 2x</button>
      <span id="betMsgSimple" class="small" style="color: #ffd54f;"></span>

      <h3 style="margin-top: 2rem;">Aposta M√©dia (5x)</h3>
      <p class="small">Chance de 20%. Ganha 5x o que apostou, **perde o valor se errar**.</p>
      <input type="number" id="betAmountMedium" placeholder="Quantos golds apostar?" min="1">
      <button id="btnBetMedium" class="btn" style="background:var(--btn-blue)">Apostar 5x</button>
      <span id="betMsgMedium" class="small" style="color: #90caf9;"></span>

      <h3 style="margin-top: 2rem;">Aposta Alta (10x)</h3>
      <p class="small">Chance de 10%. Ganha 10x o que apostou, **perde o valor se errar**.</p>
      <input type="number" id="betAmountHigh" placeholder="Quantos golds apostar?" min="1">
      <button id="btnBetHigh" class="btn" style="background:var(--btn-red)">Apostar 10x</button>
      <span id="betMsgHigh" class="small" style="color: #ef9a9a;"></span>
    </div>

    <div id="apostasAvancadasTab" style="display:none">
        <h2>üé≤ Apostas Avan√ßadas</h2>

        <p class="small">Aqui voc√™ encontra jogos de sorte com chances fixas e pr√™mios variados.</p>

        <div class="bet-options">
            <div class="bet-option-card">
                <h3 style="margin-top: 0;">Cor (2x ou 4x)</h3>
                <p class="small">Aposte no Vermelho (48%), Preto (48%) ou Verde (4%).</p>
                <input type="number" id="betCorAmount" placeholder="Gold para apostar" min="1">
                <select id="betCorColor" style="margin-bottom: 10px;">
                    <option value="red" style="color: red;">Vermelho (2x)</option>
                    <option value="black" style="color: #333;">Preto (2x)</option>
                    <option value="green" style="color: green;">Verde (4x)</option>
                </select>
                <button id="btnBetCor" class="btn" style="width: 100%;">Apostar</button>
                <span id="betCorMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>

            <div class="bet-option-card">
                <h3 style="margin-top: 0;">Raspadinha R$50</h3>
                <p class="small">Custa 50 Gold. Ganhe 0x, 2x, 5x, ou 10x o valor da aposta (50 Gold).</p>
                <div id="scratchCard" class="scratch-area">RASPE AQUI!</div>
                <button id="btnScratch" class="btn" style="width: 100%; margin-top: 10px;">Comprar Raspadinha (50 Gold)</button>
                <span id="scratchMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>

            <div class="bet-option-card">
                <h3 style="margin-top: 0;">Roleta de Pr√™mios</h3>
                <p class="small">Custa 100 Gold. Gire e ganhe **+500**, **+100** ou **-200** Gold.</p>
                <div style="position: relative; text-align: center;">
                    <div class="wheel-pointer"></div>
                    <div id="prizeWheel" class="prize-wheel"></div>
                </div>
                <button id="btnSpin" class="btn" style="width: 100%;">Girar Roleta (100 Gold)</button>
                <span id="spinMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>
        </div>
    </div>

    <div id="habilidadeTab" style="display:none">
        <h2>üß† Jogos de Habilidade e Torneios</h2>
        <p class="small">Teste sua intelig√™ncia e reflexos. Alguns jogos permitem apostas contra amigos.</p>
        
        <div class="game-area">
            <div class="card" style="background: rgba(0,0,0,0.4); padding: 1rem;">
                <h4>Quiz R√°pido: Qual o Gold do Campe√£o?</h4>
                <p class="small">Aposte 10 Gold. Acerte a pergunta em 5s e ganhe 50 Gold. Erre ou estoure o tempo e perca.</p>
                <p id="quizQuestion">Clique em "Come√ßar" para iniciar.</p>
                <div id="quizOptions" class="quiz-options"></div>
                <button id="btnStartQuiz" class="btn" style="background: var(--btn-blue);">Come√ßar Quiz (Aposta: 10 Gold)</button>
                <span id="quizMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>

            <div class="card" style="background: rgba(0,0,0,0.4); padding: 1rem;">
                <h4>Mini Torneio: Jogo da Velha (PvP)</h4>
                <p class="small">Convide um amigo por ID √önico para jogar. O vencedor leva o Gold.</p>
                
                <div id="tictactoeLobby">
                    <input type="text" id="tttFriendId" placeholder="ID √önico do Amigo para Convidar">
                    <input type="number" id="tttBetAmount" placeholder="Gold para apostar (min 100)" min="100">
                    <button id="btnInviteTTT" class="btn" style="background: var(--green-win);">Convidar Amigo</button>
                    <span id="tttInviteMsg" class="small" style="display: block; margin-top: 5px;"></span>
                    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
                    
                    <div id="tttIncomingInvites">
                         <p class="small">Convites Recebidos: Nenhum</p>
                    </div>
                </div>

                <div id="tictactoeGame" style="display: none;">
                    <p style="text-align: center;">Partida: <strong id="tttPlayer1"></strong> (X) vs <strong id="tttPlayer2"></strong> (O)</p>
                    <p style="text-align: center;">Gold Apostado: <strong id="tttGameBet"></strong></p>
                    <p id="tttStatus" style="text-align: center; font-weight: bold; color: var(--main-gold);"></p>
                    <div class="tictactoe-grid" id="tttGrid">
                        <div class="tictactoe-cell" data-index="0"></div>
                        <div class="tictactoe-cell" data-index="1"></div>
                        <div class="tictactoe-cell" data-index="2"></div>
                        <div class="tictactoe-cell" data-index="3"></div>
                        <div class="tictactoe-cell" data-index="4"></div>
                        <div class="tictactoe-cell" data-index="5"></div>
                        <div class="tictactoe-cell" data-index="6"></div>
                        <div class="tictactoe-cell" data-index="7"></div>
                        <div class="tictactoe-cell" data-index="8"></div>
                    </div>
                    <button id="btnLeaveTTT" class="btn" style="background: var(--btn-red); width: 100%;">Abandonar Partida</button>
                </div>
            </div>

            <div class="card" style="background: rgba(0,0,0,0.4); padding: 1rem;">
                <h4>Click Race (10 Cliques)</h4>
                <p class="small">Aposte 20 Gold. Seja o mais r√°pido a clicar 10 vezes. Se for o mais r√°pido, ganha 60 Gold. (1 chance por 10s)</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="btnClickStart" class="btn" style="background: var(--btn-blue);">START (20 Gold)</button>
                    <span id="clickTimer" style="font-size: 1.5rem; color: var(--main-gold);">0.00s</span>
                </div>
                <p id="clickStatus" class="small" style="margin-top: 5px;">Cliques: <span id="clickCount">0</span>/10</p>
            </div>
            
            <div class="card" style="background: rgba(0,0,0,0.4); padding: 1rem;">
                <h4>Jogo da Mem√≥ria (4 Pares)</h4>
                <p class="small">Aposte 50 Gold. Ache 4 pares em 60 segundos. Se conseguir, ganha 150 Gold.</p>
                <div id="memoryGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 400px; margin: 10px auto;"></div>
                <button id="btnStartMemory" class="btn" style="background: var(--green-win);">Iniciar Jogo (50 Gold)</button>
                <span id="memoryMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>

        </div>
    </div>


    <div id="salesTab" style="display:none">
      <h2>üí≤ Vendas por Dinheiro Real (R$)</h2>
      <p class="small">Publique sua conta ou item! O contato √© feito diretamente via WhatsApp.</p>
      
      <div class="card" style="background: rgba(0,0,0,0.4); margin-bottom: 2rem;">
        <h4>Publicar Novo Item</h4>
        <input type="text" id="saleTitle" placeholder="T√≠tulo do Item (Ex: Conta N√≠vel 50)">
        <input type="number" id="salePriceReal" placeholder="Pre√ßo em Reais (R$)" min="1">
        <input type="text" id="saleContact" placeholder="N√∫mero de WhatsApp (apenas n√∫meros)">
        <textarea id="saleDescription" placeholder="Descri√ß√£o detalhada do item." rows="3"></textarea>
        
        <label style="display:block; margin-top:.5rem;">Foto do Item (PNG/JPG):</label>
        <input type="file" id="saleImage" accept="image/*" style="margin-bottom: 1rem;">
        <p class="small" style="color: #e57373;">‚ö†Ô∏è **Moderac√£o Obrigat√≥ria:** O upload de imagens e a detec√ß√£o de **conte√∫do √≠ntimo/NSFW** exigem Cloud Functions para banimento e exclus√£o da foto.</p>

        <button id="btnSubmitSale" class="btn" style="width: 100%;">Publicar Venda</button>
      </div>

      <h4>Itens Atuais (Mockup)</h4>
      <div id="saleList">
        <div class="sale-item">
            <img src="https://via.placeholder.com/80?text=Conta" alt="Conta N√≠vel 50">
            <div class="sale-info">
                <p><strong>Conta Rara (N√≠vel 50)</strong></p>
                <p class="small">Vendedor: OWNER_UID</p>
                <p class="price-real">R$ 350,00</p>
            </div>
            <a href="https://wa.me/5511999999999" target="_blank" class="contact-btn">CHAMAR NO ZAP</a>
        </div>
        <div class="sale-item">
            <img src="https://via.placeholder.com/80?text=Item" alt="Item Exclusivo">
            <div class="sale-info">
                <p><strong>Skin Exclusiva (Rar√≠ssima)</strong></p>
                <p class="small">Vendedor: JogadorTeste</p>
                <p class="price-real">R$ 15,00</p>
            </div>
            <a href="https://wa.me/5511988888888" target="_blank" class="contact-btn">CHAMAR NO ZAP</a>
        </div>
      </div>
    </div>

    <div id="rankTab" style="display:none">
      <h2>üèÜ Rank Global</h2>
      <p class="small">Top 50 jogadores (atualiza a cada 5 segundos)</p>
      <div class="rank-list card" id="rankList"></div>
    </div>

    <div id="chatTab" style="display:none">
      <h2>üí¨ Chat Global Din√¢mico</h2>
      <div class="chat-box" id="chatBox"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem ou grave um √°udio..." style="margin: 0;">
        <button id="btnRecordAudio" class="btn" title="Gravar √Åudio (M√°x 60s)">üé§</button>
        <button id="btnSendChat" class="btn">Enviar</button>
      </div>
      <p class="small" style="margin-top: 5px; color: #ffb300;">üé§ √Åudio: Gravado e salvo no banco de dados (m√°x 60s). Evite √°udios longos.</p>
    </div>
  </section>
</main>

<div id="globalNotice"></div>

<footer>¬© 2025 IVAD TROCAS E VENDAS | IVADCREATOR</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// ===================================
// ‚öôÔ∏è CONFIGURA√á√ïES FIREBASE
// ===================================
const firebaseConfig = {
  apiKey: "AIzaSyCkmyMqEJaM8jVvmTN8I3gLnbC8YtMPWOI",
  authDomain: "regras-ivad.firebaseapp.com",
  projectId: "regras-ivad",
  storageBucket: "regras-ivad.firebasestorage.app",
  messagingSenderId: "812565896201",
  appId: "1:812565896201:android:afc3bddd8edb14071aacd8"
};
const OWNER_UID = "m3h06woQv2V7lrNu1p8fDQCZ8IW2"; 

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage(); 

// ===================================
// üéØ ELEMENTOS DO DOM
// ===================================
const elements = {
    // Auth & General
    signedOutUI: document.getElementById('signedOutUI'),
    signedInUI: document.getElementById('signedInUI'),
    userLabel: document.getElementById('userLabel'),
    myGold: document.getElementById('myGold'),
    playerGold: document.getElementById('playerGold'),
    playerInfo: document.getElementById('playerInfo'),
    playerInfoSocial: document.getElementById('playerInfoSocial'),
    socialUsername: document.getElementById('socialUsername'),
    socialUserId: document.getElementById('socialUserId'),
    globalNotice: document.getElementById('globalNotice'),
    // Games Simples
    workMsg: document.getElementById('workMsg'),
    btnWork: document.getElementById('btnWork'),
    betMsgSimple: document.getElementById('betMsgSimple'),
    betMsgMedium: document.getElementById('betMsgMedium'),
    betMsgHigh: document.getElementById('betMsgHigh'),
    btnBetSimple: document.getElementById('btnBetSimple'),
    btnBetMedium: document.getElementById('btnBetMedium'),
    btnBetHigh: document.getElementById('btnBetHigh'),
    // Jogos Avan√ßados
    btnBetCor: document.getElementById('btnBetCor'),
    betCorMsg: document.getElementById('betCorMsg'),
    scratchCard: document.getElementById('scratchCard'),
    btnScratch: document.getElementById('btnScratch'),
    scratchMsg: document.getElementById('scratchMsg'),
    prizeWheel: document.getElementById('prizeWheel'),
    btnSpin: document.getElementById('btnSpin'),
    spinMsg: document.getElementById('spinMsg'),
    // Habilidade
    btnStartQuiz: document.getElementById('btnStartQuiz'),
    quizQuestion: document.getElementById('quizQuestion'),
    quizOptions: document.getElementById('quizOptions'),
    quizMsg: document.getElementById('quizMsg'),
    btnClickStart: document.getElementById('btnClickStart'),
    clickTimer: document.getElementById('clickTimer'),
    clickCount: document.getElementById('clickCount'),
    clickStatus: document.getElementById('clickStatus'),
    memoryGrid: document.getElementById('memoryGrid'),
    btnStartMemory: document.getElementById('btnStartMemory'),
    memoryMsg: document.getElementById('memoryMsg'),
    // Social
    btnAddFriend: document.getElementById('btnAddFriend'),
    friendInput: document.getElementById('friendInput'),
    friendMsg: document.getElementById('friendMsg'),
    friendList: document.getElementById('friendList'),
    friendCount: document.getElementById('friendCount'),
    // TTT
    tttFriendId: document.getElementById('tttFriendId'),
    tttBetAmount: document.getElementById('tttBetAmount'),
    btnInviteTTT: document.getElementById('btnInviteTTT'),
    tttInviteMsg: document.getElementById('tttInviteMsg'),
    tttIncomingInvites: document.getElementById('tttIncomingInvites'),
    tictactoeLobby: document.getElementById('tictactoeLobby'),
    tictactoeGame: document.getElementById('tictactoeGame'),
    tttGrid: document.getElementById('tttGrid'),
    tttStatus: document.getElementById('tttStatus'),
    tttPlayer1: document.getElementById('tttPlayer1'),
    tttPlayer2: document.getElementById('tttPlayer2'),
    tttGameBet: document.getElementById('tttGameBet'),
    btnLeaveTTT: document.getElementById('btnLeaveTTT'),
    // Chat
    chatBox: document.getElementById('chatBox'),
    chatInput: document.getElementById('chatInput'),
    btnRecordAudio: document.getElementById('btnRecordAudio'),
    btnSendChat: document.getElementById('btnSendChat'),
    // Ranking
    rankList: document.getElementById('rankList'),
    visitorCounter: document.getElementById('visitorCount'),
};


// ===================================
// üí° FUN√á√ïES AUXILIARES
// ===================================

/** Gera um n√∫mero inteiro aleat√≥rio entre min (inclusivo) e max (inclusivo). */
function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

/** Gera um ID num√©rico aleat√≥rio de 6 d√≠gitos */
function generateUniqueID() {
    return getRandomInt(100000, 999999);
}

function showTab(id){
  ['regrasTab','jogoSimplesTab','apostasAvancadasTab','habilidadeTab','rankTab','chatTab','salesTab', 'socialTab'].forEach(t=>document.getElementById(t).style.display=(t===id?'block':'none'));
}
document.querySelectorAll('.tabbtn').forEach(b=>{
  b.addEventListener('click',e=>{
    document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    showTab(e.currentTarget.dataset.tab);
  });
});
showTab('regrasTab');

function usernameToEmail(u){ return `${u}@ivad.local`; }
function validUsername(u){ return /^[a-zA-Z0-9_]{3,20}$/.test(u); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function showNotification(message) {
  const el = elements.globalNotice;
  el.textContent = message;
  el.style.animation = 'none';
  el.offsetHeight; 
  el.style.animation = 'fadeInOut 4.5s cubic-bezier(0.19, 1, 0.22, 1) forwards';
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

// ===================================
// üîí AUTENTICA√á√ÉO E ESTADO DO USU√ÅRIO
// ===================================
document.getElementById('btnSignup').onclick = async ()=>{
  const uname = document.getElementById('username').value.trim();
  const pw = document.getElementById('pwd').value;
  if(!validUsername(uname)){ showNotification('Nome de usu√°rio inv√°lido (3-20 caracteres, sem espa√ßos/caracteres especiais, exceto _).'); return; }
  if(pw.length<6){ showNotification('Senha precisa ter 6 ou mais caracteres.'); return; }
  
  try{
    const q = await db.collection('users').where('displayName','==',uname).limit(1).get();
    if(!q.empty){ showNotification('Nome de usu√°rio j√° existe, escolha outro.'); return; }
    
    // 1. Cria o usu√°rio no Auth
    const userCredential = await auth.createUserWithEmailAndPassword(usernameToEmail(uname), pw);
    const user = userCredential.user;
    
    // 2. Cria ID √önico (6 digitos) e garante que ele n√£o existe
    let uniqueId;
    let idExists = true;
    while(idExists) {
        uniqueId = generateUniqueID();
        const idCheck = await db.collection('users').where('uniqueId', '==', uniqueId).limit(1).get();
        if(idCheck.empty) idExists = false;
    }

    // 3. Cria/Atualiza o documento do usu√°rio no Firestore com o ID
    const userRef = db.collection('users').doc(user.uid);
    await userRef.set({
        uid: user.uid,
        email: user.email,
        displayName: uname,
        uniqueId: uniqueId, // SALVA O ID √öNICO
        gold: 100, 
        friends: [], // Lista de IDs de amigos
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification('Conta criada! Voc√™ j√° est√° logado. Seu ID √©: ' + uniqueId);
  }catch(err){ console.error(err); showNotification('Erro ao criar conta: '+err.message); }
};

document.getElementById('btnLogin').onclick = async ()=>{
  const uname = document.getElementById('username').value.trim();
  const pw = document.getElementById('pwd').value;
  if(!validUsername(uname)){ showNotification('Nome de usu√°rio inv√°lido.'); return; }
  if(pw.length<6){ showNotification('Senha precisa ter 6 ou mais caracteres.'); return; }
  try{ await auth.signInWithEmailAndPassword(usernameToEmail(uname), pw); }
  catch(err){ console.error(err); showNotification('Erro ao entrar: '+err.message); }
};

document.getElementById('btnLogout').onclick = ()=>auth.signOut();

let unsubscribeUserData = null; // Para gerenciar a subscri√ß√£o de dados do usu√°rio

auth.onAuthStateChanged(async user=>{
  if(user){
    elements.signedOutUI.style.display='none';
    elements.signedInUI.style.display='block';
    const displayName = user.email ? user.email.split('@')[0] : user.uid;
    elements.userLabel.textContent = `Conectado: ${displayName}`;
    
    const userRef = db.collection('users').doc(user.uid);
    const doc = await userRef.get();
    if (!doc.exists) {
        // Redireciona para o fluxo de signup se o doc n√£o existir (algo deu errado no cadastro)
        auth.signOut(); 
        showNotification('Erro: Documento do usu√°rio n√£o encontrado. Tente novamente.');
        return;
    }
    
    if(user.uid === OWNER_UID) document.getElementById('ownerPanel').style.display='block';
    else document.getElementById('ownerPanel').style.display='none';
    
    // Limpa subscri√ß√£o anterior e cria uma nova
    if(unsubscribeUserData) unsubscribeUserData();
    
    unsubscribeUserData = userRef.onSnapshot(doc => {
        if(doc.exists){
            const data = doc.data();
            const gold = Number(data.gold||0);
            const goldFormatted = gold.toLocaleString('pt-BR');
            
            elements.myGold.textContent = goldFormatted;
            elements.playerGold.textContent = goldFormatted;
            elements.playerInfo.style.display='block';
            
            // Dados Sociais
            elements.playerInfoSocial.style.display='block';
            elements.socialUsername.textContent = data.displayName || displayName;
            elements.socialUserId.textContent = data.uniqueId || '...';
            
            loadFriends(data.friends || []); // Carrega a lista de amigos
        }
    });

    loadChat();
    reloadRank();
    listenForTTTInvites(user.uid); // Come√ßa a ouvir convites de jogos
  }else{
    elements.signedOutUI.style.display='block';
    elements.signedInUI.style.display='none';
    document.getElementById('ownerPanel').style.display='none';
    elements.myGold.textContent='0';
    elements.playerInfo.style.display='none';
    elements.playerInfoSocial.style.display='none';
    if(unsubscribeUserData) unsubscribeUserData();
  }
});


// ===================================
// ü§ù SOCIAL (AMIGOS E ID)
// ===================================

// Carrega a lista de amigos na aba social
async function loadFriends(friendUIDs) {
    elements.friendList.innerHTML = '';
    elements.friendCount.textContent = friendUIDs.length;

    if (friendUIDs.length === 0) {
        elements.friendList.innerHTML = '<p class="small" style="text-align: center;">Adicione amigos por ID para que eles apare√ßam aqui.</p>';
        return;
    }

    // Busca os dados dos amigos
    const friendPromises = friendUIDs.map(uid => db.collection('users').doc(uid).get());
    const friendDocs = await Promise.all(friendPromises);

    friendDocs.forEach(doc => {
        if (doc.exists) {
            const data = doc.data();
            const li = document.createElement('li');
            li.innerHTML = `
                <strong>${escapeHtml(data.displayName)}</strong> 
                <span class="small" style="color: #42a5f5;">ID: ${data.uniqueId}</span>
            `;
            elements.friendList.appendChild(li);
        }
    });
}

// L√≥gica de adicionar amigo
elements.btnAddFriend.onclick = async () => {
    const user = auth.currentUser;
    if (!user) { showNotification('Fa√ßa login.'); return; }

    const input = elements.friendInput.value.trim();
    if (!input) { elements.friendMsg.textContent = 'Insira um nome ou ID.'; return; }

    let friendQuery;
    let isId = /^\d{6}$/.test(input);

    if (isId) {
        friendQuery = db.collection('users').where('uniqueId', '==', Number(input)).limit(1);
    } else {
        friendQuery = db.collection('users').where('displayName', '==', input).limit(1);
    }
    
    elements.friendMsg.textContent = 'Buscando usu√°rio...';
    elements.btnAddFriend.disabled = true;

    try {
        const snapshot = await friendQuery.get();
        if (snapshot.empty) {
            elements.friendMsg.textContent = 'Usu√°rio/ID n√£o encontrado.';
            return;
        }

        const friendDoc = snapshot.docs[0];
        const friendUID = friendDoc.id;
        const friendName = friendDoc.data().displayName;

        if (friendUID === user.uid) {
            elements.friendMsg.textContent = 'Voc√™ n√£o pode adicionar a si mesmo.';
            return;
        }

        // Adiciona o amigo (em ambas as listas, para simplificar)
        await db.runTransaction(async tx => {
            const userDoc = await tx.get(db.collection('users').doc(user.uid));
            const friendDocData = await tx.get(db.collection('users').doc(friendUID));

            const userFriends = userDoc.data().friends || [];
            const friendFriends = friendDocData.data().friends || [];
            
            if (userFriends.includes(friendUID)) {
                throw new Error('J√° s√£o amigos.');
            }

            // Adiciona na lista do usu√°rio
            userFriends.push(friendUID);
            tx.update(db.collection('users').doc(user.uid), { friends: userFriends });

            // Adiciona na lista do amigo (opcional, mas bom para reciprocidade)
            if (!friendFriends.includes(user.uid)) {
                friendFriends.push(user.uid);
                tx.update(db.collection('users').doc(friendUID), { friends: friendFriends });
            }
        });

        elements.friendMsg.textContent = `‚úÖ ${friendName} adicionado √† sua lista!`;

    } catch (error) {
        console.error(error);
        if (error.message.includes('J√° s√£o amigos')) {
            elements.friendMsg.textContent = 'Voc√™s j√° s√£o amigos!';
        } else {
            elements.friendMsg.textContent = 'Erro ao adicionar amigo: ' + error.message;
        }
    } finally {
        elements.btnAddFriend.disabled = false;
        elements.friendInput.value = '';
    }
};


// ===================================
// üéÆ JOGOS SIMPLES (Gold, 1%-100%, Apostas)
// ===================================
let lastWork=0;
elements.btnWork.onclick=async ()=>{
  const user = auth.currentUser;
  if(!user){ showNotification('Fa√ßa login para trabalhar.'); return; }
  
  const now = Date.now();
  const cooldown = 5000;
  if(now-lastWork<cooldown){ 
    elements.workMsg.textContent=`Aguarde ${Math.ceil((cooldown - (now - lastWork)) / 1000)}s`; 
    return; 
  }
  lastWork=now;
  
  elements.btnWork.disabled = true;
  elements.workMsg.textContent='Buscando Gold...';
  
  try{
    const userRef = db.collection('users').doc(user.uid);
    await db.runTransaction(async tx=>{
      const d = await tx.get(userRef);
      if(!d.exists) throw new Error('Usu√°rio n√£o encontrado');
      
      const currentGold = d.data().gold || 0;
      const percentage = getRandomInt(1, 100); 
      const baseGold = currentGold > 0 ? currentGold : 100; 
      const gain = Math.round(baseGold * (percentage / 100)); 
      
      const newGold = currentGold + gain;
      tx.update(userRef,{gold:newGold});
      
      elements.workMsg.textContent=`üí∞ Ganhou ${gain.toLocaleString('pt-BR')} gold! (+${percentage}%)`;
    });
    reloadRank();
  }catch(err){ 
    console.error(err); 
    elements.workMsg.textContent='Erro!';
    showNotification('Erro ao trabalhar: '+err.message); 
  } finally {
    setTimeout(() => { elements.btnWork.disabled = false; elements.workMsg.textContent=''; }, cooldown);
  }
};

/** Fun√ß√£o gen√©rica para lidar com todas as apostas. */
async function handleBet(amountInput, multiplier, winChance, msgEl, btn) {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login para apostar.'); return; }
    
    const amt = Number(amountInput.value);
    if(isNaN(amt) || amt<=0){ showNotification('Insira um valor v√°lido (m√≠nimo 1 gold).'); return; }
    
    btn.disabled = true;
    msgEl.textContent = 'Aguarde, jogando os dados...';
    
    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
            
            const currentGold = doc.data().gold || 0;
            if(currentGold < amt){ throw new Error('Gold insuficiente para esta aposta.'); }
            
            const roll = Math.random(); 
            const win = roll < winChance;
            
            let diff;
            
            if (win) {
                const gain = amt * multiplier;
                diff = gain; 
            } else {
                diff = -amt; 
            }

            const newGold = currentGold + diff;

            tx.update(userRef, { gold: newGold });

            if (win) {
                msgEl.textContent = `üèÜ VITORIA! Voc√™ ganhou ${diff.toLocaleString('pt-BR')} gold! (Chance: ${Math.round(winChance*100)}%)`;
            } else {
                msgEl.textContent = `üòî DERROTA! Voc√™ perdeu ${amt.toLocaleString('pt-BR')} gold. (Sorte: ${Math.round(roll*100)}%)`;
            }
        });
        reloadRank();
    } catch(err) {
        console.error(err); 
        msgEl.textContent = 'Erro na aposta!';
        showNotification('Erro na aposta: '+err.message);
    } finally {
        btn.disabled = false;
        setTimeout(() => msgEl.textContent='', 3000);
    }
}

// Aposta Simples (2x) - Chance de 50%
elements.btnBetSimple.onclick=()=> {
    handleBet(document.getElementById('betAmount'), 2, 0.5, elements.betMsgSimple, elements.btnBetSimple);
};

// Aposta M√©dia (5x) - Chance de 20%
elements.btnBetMedium.onclick=()=> {
    handleBet(document.getElementById('betAmountMedium'), 5, 0.2, elements.betMsgMedium, elements.btnBetMedium);
};

// Aposta Alta (10x) - Chance de 10%
elements.btnBetHigh.onclick=()=> {
    handleBet(document.getElementById('betAmountHigh'), 10, 0.1, elements.betMsgHigh, elements.btnBetHigh);
};


// ===================================
// üé≤ APOSTAS AVAN√áADAS
// ===================================

// Aposta Cor
elements.btnBetCor.onclick = async () => {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login para apostar.'); return; }
    
    const amt = Number(document.getElementById('betCorAmount').value);
    const color = document.getElementById('betCorColor').value;
    if(isNaN(amt) || amt<=0){ showNotification('Insira um valor v√°lido (m√≠nimo 1 gold).'); return; }

    let winChance = 0;
    let multiplier = 0;
    if (color === 'red') { winChance = 0.48; multiplier = 2; } 
    else if (color === 'black') { winChance = 0.48; multiplier = 2; } 
    else if (color === 'green') { winChance = 0.04; multiplier = 4; }
    
    elements.btnBetCor.disabled = true;
    elements.betCorMsg.textContent = 'Girando a roda...';

    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
            
            const currentGold = doc.data().gold || 0;
            if(currentGold < amt){ throw new Error('Gold insuficiente.'); }
            
            const roll = Math.random();
            let resultColor = 'red'; // 48%
            if (roll > 0.48) resultColor = 'black'; // +48%
            if (roll > 0.96) resultColor = 'green'; // +4%

            const win = resultColor === color;
            let diff = -amt;
            
            if (win) {
                diff = amt * multiplier;
            } 

            const newGold = currentGold + diff;
            tx.update(userRef, { gold: newGold });

            if (win) {
                elements.betCorMsg.textContent = `üèÜ VITORIA! Caiu ${resultColor.toUpperCase()}. Voc√™ ganhou ${diff.toLocaleString('pt-BR')} gold!`;
            } else {
                elements.betCorMsg.textContent = `üòî DERROTA! Caiu ${resultColor.toUpperCase()}. Voc√™ perdeu ${amt.toLocaleString('pt-BR')} gold.`;
            }
        });
        reloadRank();
    } catch(err) {
        elements.betCorMsg.textContent = 'Erro na aposta!';
        showNotification('Erro na aposta: '+err.message);
    } finally {
        elements.btnBetCor.disabled = false;
        setTimeout(() => elements.betCorMsg.textContent='', 4000);
    }
};

// Raspadinha
let scratchPrize = 0;
elements.btnScratch.onclick = async () => {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login para raspar.'); return; }

    const cost = 50;
    elements.btnScratch.disabled = true;
    elements.scratchCard.classList.remove('scratched');
    elements.scratchCard.textContent = 'RASPE AQUI!';

    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
            
            const currentGold = doc.data().gold || 0;
            if(currentGold < cost){ throw new Error('Gold insuficiente (50 Gold).'); }

            const roll = Math.random();
            let multiplier = 0;
            if (roll < 0.05) { multiplier = 10; } // 5% chance: 10x (500)
            else if (roll < 0.20) { multiplier = 5; } // 15% chance: 5x (250)
            else if (roll < 0.50) { multiplier = 2; } // 30% chance: 2x (100)
            else { multiplier = 0; } // 50% chance: 0x (0)

            scratchPrize = cost * multiplier;
            const finalGoldChange = scratchPrize - cost; // Ganho - Custo
            
            tx.update(userRef, { gold: currentGold + finalGoldChange });

            elements.scratchMsg.textContent = `Custo: ${cost} Gold. Raspe para ver o pr√™mio!`;
        });
        
        reloadRank();
        // Permite "raspar" ap√≥s a transa√ß√£o
        elements.scratchCard.onclick = () => {
            elements.scratchCard.textContent = `${scratchPrize.toLocaleString('pt-BR')} GOLD`;
            elements.scratchCard.classList.add('scratched');
            elements.scratchMsg.textContent = `üéâ Voc√™ ganhou ${scratchPrize.toLocaleString('pt-BR')} Gold! (Gold Final: ${scratchPrize > 0 ? '+'+(scratchPrize-50) : '-50'})`;
            elements.scratchCard.onclick = null; // Desativa at√© a pr√≥xima compra
        };

    } catch(err) {
        elements.scratchMsg.textContent = 'Erro ao comprar raspadinha: '+err.message;
        elements.btnScratch.disabled = false;
    } finally {
        setTimeout(() => { elements.btnScratch.disabled = false; }, 3000);
    }
};

// Roleta de Pr√™mios
elements.btnSpin.onclick = async () => {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login para girar.'); return; }

    const cost = 100;
    elements.btnSpin.disabled = true;
    elements.spinMsg.textContent = 'Girando...';

    const prizes = [
        {name: "500 Gold", value: 500, range: [0, 10]}, // 10%
        {name: "100 Gold", value: 100, range: [10, 40]}, // 30%
        {name: "-200 Gold", value: -200, range: [40, 100]}, // 60%
    ];
    const roll = getRandomInt(0, 99); // 0 a 99

    let winPrize = null;
    let winIndex = 0;
    for (let i = 0; i < prizes.length; i++) {
        if (roll >= prizes[i].range[0] && roll < prizes[i].range[1]) {
            winPrize = prizes[i];
            winIndex = i;
            break;
        }
    }
    
    // Gira a roleta (simula√ß√£o visual)
    const sectors = 3; 
    const degreePerSector = 360 / sectors;
    // Calcula o ponto de parada (aponta para o centro do setor)
    const targetDegree = 360 * 5 + (degreePerSector / 2) + (degreePerSector * winIndex); 
    elements.prizeWheel.style.transform = `rotate(${targetDegree}deg)`;
    
    // Aplica a l√≥gica do Gold ap√≥s o giro visual (4 segundos)
    setTimeout(async () => {
        try {
            await db.runTransaction(async tx => {
                const userRef = db.collection('users').doc(user.uid);
                const doc = await tx.get(userRef);
                if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
                
                const currentGold = doc.data().gold || 0;
                if(currentGold < cost){ throw new Error('Gold insuficiente (100 Gold).'); }

                // O custo j√° foi subtra√≠do no pr√™mio (Pr√™mio - Custo)
                const finalGoldChange = winPrize.value - cost; 
                
                tx.update(userRef, { gold: currentGold + finalGoldChange });

                elements.spinMsg.textContent = `Pr√™mio: ${winPrize.name}! Gold Final: ${finalGoldChange > 0 ? '+'+finalGoldChange : finalGoldChange} Gold!`;
            });
            reloadRank();
        } catch(err) {
            elements.spinMsg.textContent = 'Erro ao girar roleta: '+err.message;
        } finally {
            elements.btnSpin.disabled = false;
        }
    }, 4000); // Tempo do CSS transition (4s)
};


// ===================================
// üß† JOGOS DE HABILIDADE
// ===================================

// 1. Quiz R√°pido
const quizData = [
    { q: "Qual o maior gold j√° registrado no rank?", a: 2, options: ["1 milh√£o", "500 mil", "10 milh√µes", "100 mil"] },
    { q: "Quantos por cento √© a chance de 10x?", a: 3, options: ["5%", "20%", "1%", "10%"] },
    { q: "O Jogo da Velha est√° nesta aba?", a: 4, options: ["N√£o", "Talvez", "Sim", "Com certeza"] }
];
let currentQuiz = null;
let quizTimer = null;

elements.btnStartQuiz.onclick = async () => {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login para jogar.'); return; }
    
    const cost = 10;
    
    // Verifica Gold e Inicia Transa√ß√£o
    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
            const currentGold = doc.data().gold || 0;
            if(currentGold < cost){ throw new Error('Gold insuficiente (10 Gold).'); }
            
            tx.update(userRef, { gold: currentGold - cost }); // Subtrai o custo
        });
        reloadRank();
        
        // Inicia o jogo
        const qIndex = getRandomInt(0, quizData.length - 1);
        currentQuiz = quizData[qIndex];

        elements.quizQuestion.textContent = currentQuiz.q;
        elements.quizOptions.innerHTML = '';
        
        currentQuiz.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.onclick = () => checkQuizAnswer(index + 1);
            elements.quizOptions.appendChild(btn);
        });

        elements.btnStartQuiz.disabled = true;
        elements.quizMsg.textContent = 'Tempo: 5s';

        let timeLeft = 5;
        quizTimer = setInterval(() => {
            timeLeft--;
            elements.quizMsg.textContent = `Tempo: ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(quizTimer);
                checkQuizAnswer(-1); // Resposta incorreta por tempo
            }
        }, 1000);

    } catch(err) {
        elements.quizMsg.textContent = 'Erro ao iniciar Quiz: '+err.message;
        elements.btnStartQuiz.disabled = false;
    }
};

async function checkQuizAnswer(answerIndex) {
    if(!currentQuiz || quizTimer === null) return;

    clearInterval(quizTimer);
    quizTimer = null;
    elements.btnStartQuiz.disabled = false;
    elements.quizOptions.querySelectorAll('button').forEach(btn => btn.disabled = true);

    const isCorrect = answerIndex === currentQuiz.a;
    const allButtons = elements.quizOptions.querySelectorAll('button');
    
    allButtons.forEach((btn, index) => {
        if (index + 1 === currentQuiz.a) {
            btn.classList.add('correct');
        } else if (index + 1 === answerIndex) {
            btn.classList.add('incorrect');
        }
    });

    if (isCorrect) {
        // GANHA 50 Gold
        await updateGold(50, 'Quiz ganho');
        elements.quizMsg.textContent = '‚úÖ CERTO! Voc√™ ganhou 50 Gold!';
        showNotification('Quiz ganho: +50 Gold!');
    } else {
        // PERDE (j√° perdeu os 10 Gold na aposta inicial)
        elements.quizMsg.textContent = '‚ùå ERROU! Voc√™ perdeu 10 Gold.';
    }

    currentQuiz = null;
    setTimeout(() => { 
        elements.quizQuestion.textContent = 'Clique em "Come√ßar" para iniciar.';
        elements.quizOptions.innerHTML = '';
        elements.quizMsg.textContent = '';
    }, 3000);
}


// 2. Jogo da Velha (Tic-Tac-Toe - TTT) - Sistema de Convite Simulado
const tttGamesRef = db.collection('ttt_games');
let currentGame = null; // Guarda o ID do jogo atual se estiver jogando
let unsubscribeTTT = null; // Para gerenciar a subscri√ß√£o do jogo

// Iniciar convite
elements.btnInviteTTT.onclick = async () => {
    const user = auth.currentUser;
    if (!user) { showNotification('Fa√ßa login.'); return; }

    const friendId = elements.tttFriendId.value.trim();
    const bet = Number(elements.tttBetAmount.value);
    
    if (!/^\d{6}$/.test(friendId)) { elements.tttInviteMsg.textContent = 'ID do amigo inv√°lido (6 d√≠gitos).'; return; }
    if (isNaN(bet) || bet < 100) { elements.tttInviteMsg.textContent = 'Aposta m√≠nima de 100 Gold.'; return; }

    elements.btnInviteTTT.disabled = true;
    elements.tttInviteMsg.textContent = 'Verificando Gold e Amigo...';

    try {
        // 1. Verifica se o usu√°rio tem Gold e subtrai
        const userRef = db.collection('users').doc(user.uid);
        await db.runTransaction(async tx => {
            const d = await tx.get(userRef);
            if (!d.exists) throw new Error('Usu√°rio n√£o encontrado');
            if ((d.data().gold || 0) < bet) throw new Error('Gold insuficiente.');
            
            tx.update(userRef, { gold: d.data().gold - bet }); // Tira o gold do desafiante
        });
        reloadRank();

        // 2. Busca o amigo pelo ID
        const friendSnap = await db.collection('users').where('uniqueId', '==', Number(friendId)).limit(1).get();
        if (friendSnap.empty) throw new Error('Amigo com este ID n√£o encontrado.');
        const friendDoc = friendSnap.docs[0];
        const friendUID = friendDoc.id;
        const friendName = friendDoc.data().displayName;

        if (friendUID === user.uid) throw new Error('N√£o pode convidar a si mesmo.');

        // 3. Cria o jogo no Firestore (Lobby)
        const gameData = {
            status: 'pending', // pending, accepted, finished
            player1: { uid: user.uid, name: user.email.split('@')[0] }, // Desafiante (X)
            player2: { uid: friendUID, name: friendName }, // Desafiado (O)
            bet: bet,
            board: Array(9).fill(null),
            turn: user.uid, // Come√ßa o desafiante (X)
            winner: null
        };
        const gameRef = await tttGamesRef.add(gameData);
        showNotification(`Convite enviado para ${friendName}!`);
        elements.tttInviteMsg.textContent = `Convite enviado para ${friendName} (ID: ${friendId}). Esperando aceita√ß√£o...`;

        // 4. Entra no modo de espera
        setupTTTGameListener(gameRef.id);

    } catch (err) {
        showNotification('Erro ao convidar: ' + err.message);
        elements.tttInviteMsg.textContent = 'Erro: ' + err.message;
        // Se a aposta falhou, o gold n√£o foi tirado, ent√£o n√£o precisa devolver.
        elements.btnInviteTTT.disabled = false;
    }
};

// Escuta por convites recebidos
function listenForTTTInvites(myUid) {
    db.collection('ttt_games')
      .where('player2.uid', '==', myUid)
      .where('status', '==', 'pending')
      .onSnapshot(snapshot => {
        elements.tttIncomingInvites.innerHTML = '';
        if (snapshot.empty) {
            elements.tttIncomingInvites.innerHTML = '<p class="small">Convites Recebidos: Nenhum</p>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.innerHTML = `
                <p class="small">Convite de <strong>${data.player1.name}</strong> para apostar <strong>${data.bet} Gold</strong>!</p>
                <button class="btn" style="background: var(--green-win); padding: 5px 10px;" onclick="acceptTTTInvite('${doc.id}', ${data.bet})">Aceitar</button>
                <button class="btn" style="background: var(--btn-red); padding: 5px 10px; margin-left: 5px;" onclick="rejectTTTInvite('${doc.id}')">Rejeitar</button>
            `;
            elements.tttIncomingInvites.appendChild(div);
        });
      });
}

// Aceitar convite
async function acceptTTTInvite(gameId, betAmount) {
    const user = auth.currentUser;
    if (!user) return;

    // Tenta subtrair o Gold e mudar o status para 'accepted'
    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await tx.get(userRef);
            if ((userDoc.data().gold || 0) < betAmount) throw new Error('Gold insuficiente.');

            const gameRef = tttGamesRef.doc(gameId);
            const gameDoc = await tx.get(gameRef);
            if (gameDoc.data().status !== 'pending') throw new Error('Jogo n√£o pendente.');

            tx.update(userRef, { gold: userDoc.data().gold - betAmount }); // Subtrai o gold do desafiado
            tx.update(gameRef, { status: 'accepted' }); // Inicia o jogo
        });
        
        reloadRank();
        setupTTTGameListener(gameId); // Come√ßa a ouvir o jogo
        showNotification(`Jogo aceito! Apostando ${betAmount} Gold.`);

    } catch (error) {
        showNotification('Erro ao aceitar: ' + error.message);
    }
}

// Rejeitar convite
async function rejectTTTInvite(gameId) {
    // Apaga o jogo e o Gold do desafiante ser√° devolvido por uma Cloud Function (n√£o implementada aqui)
    // Para fins pr√°ticos, o desafiante perde o Gold se a fun√ß√£o de devolu√ß√£o n√£o existir.
    // **NOTA:** Em um sistema real, o Gold deve ser devolvido ao desafiante.
    await tttGamesRef.doc(gameId).delete();
    showNotification('Convite rejeitado. (Gold do desafiante perdido na simula√ß√£o)');
}

// Configurar listener e UI do jogo
function setupTTTGameListener(gameId) {
    currentGame = gameId;
    elements.tictactoeLobby.style.display = 'none';
    elements.tictactoeGame.style.display = 'block';

    if(unsubscribeTTT) unsubscribeTTT(); // Limpa listener anterior

    unsubscribeTTT = tttGamesRef.doc(gameId).onSnapshot(doc => {
        if (!doc.exists) {
            // O jogo foi deletado (abandono ou erro)
            resetTTTUI();
            showNotification('A partida foi encerrada.');
            return;
        }

        const game = doc.data();
        renderTTTGame(game);
        
        if (game.status === 'finished') {
            handleTTTEndGame(game);
        }
    });
}

// Renderiza o estado do jogo na tela
function renderTTTGame(game) {
    const myUid = auth.currentUser.uid;
    const isMyTurn = game.turn === myUid;
    const myMark = game.player1.uid === myUid ? 'x' : 'o';
    const opponentName = game.player1.uid === myUid ? game.player2.name : game.player1.name;

    elements.tttPlayer1.textContent = game.player1.name;
    elements.tttPlayer2.textContent = game.player2.name;
    elements.tttGameBet.textContent = game.bet.toLocaleString('pt-BR');

    if (game.status === 'pending') {
        elements.tttStatus.textContent = 'Aguardando oponente aceitar...';
        elements.btnLeaveTTT.textContent = 'Cancelar Convite';
    } else if (game.status === 'accepted') {
        elements.tttStatus.textContent = isMyTurn ? 'SUA VEZ!' : `Vez de ${opponentName}`;
        elements.btnLeaveTTT.textContent = 'Abandonar Partida';
    } else if (game.status === 'finished') {
        elements.tttStatus.textContent = game.winner ? `VENCEDOR: ${game.winner === myUid ? 'VOC√ä' : opponentName}!` : 'EMPATE!';
    }
    
    // Renderiza o tabuleiro
    elements.tttGrid.querySelectorAll('.tictactoe-cell').forEach((cell, index) => {
        const mark = game.board[index];
        cell.className = 'tictactoe-cell'; // Reset classes
        cell.textContent = mark ? mark.toUpperCase() : '';
        if (mark) {
            cell.classList.add(mark);
        }
        
        // Adiciona o evento de clique (se for a vez do jogador e a c√©lula estiver vazia)
        cell.onclick = (mark || !isMyTurn || game.status !== 'accepted') 
            ? null 
            : () => makeTTTMove(index, myMark);
    });
}

// Faz a jogada (chamada ao clicar na c√©lula)
async function makeTTTMove(index, mark) {
    const user = auth.currentUser;
    if (!user || !currentGame) return;

    try {
        await tttGamesRef.doc(currentGame).set({
            board: firebase.firestore.FieldValue.arrayUnion({ index: index, mark: mark, uid: user.uid }),
            turn: mark === 'x' ? currentGame.player2.uid : currentGame.player1.uid // Inverte o turno
        }, { merge: true });

    } catch (error) {
        showNotification('Erro ao fazer jogada: ' + error.message);
    }
}

// Verifica e finaliza o jogo
function handleTTTEndGame(game) {
    if (!game.winner) {
        showNotification(`FIM DE JOGO: Empate! Aposta devolvida.`);
        // Devolver a aposta total para os dois jogadores (n√£o implementado: complexo)
    } else {
        const myUid = auth.currentUser.uid;
        const prize = game.bet * 2; // O ganhador leva o dobro da aposta
        
        if (game.winner === myUid) {
            updateGold(prize, 'Vit√≥ria Jogo da Velha');
            showNotification(`üèÜ VOC√ä VENCEU! Ganhou ${prize.toLocaleString('pt-BR')} Gold!`);
        } else {
            showNotification(`üòî Voc√™ perdeu! O Gold foi para o seu oponente.`);
        }
    }
    
    // Deleta o jogo do banco para limpeza (simula√ß√£o)
    tttGamesRef.doc(currentGame).delete();
}

// Abandona a partida
elements.btnLeaveTTT.onclick = () => {
    if (currentGame) {
        // Deletar o jogo e notificar o oponente (n√£o implementado)
        tttGamesRef.doc(currentGame).delete();
        // O abandono √© considerado perda, a aposta fica com o vencedor (n√£o implementado)
        showNotification('Voc√™ abandonou a partida! Gold perdido.');
    }
};

// Reseta a UI para o lobby
function resetTTTUI() {
    if (unsubscribeTTT) unsubscribeTTT();
    currentGame = null;
    elements.tictactoeLobby.style.display = 'block';
    elements.tictactoeGame.style.display = 'none';
    elements.btnInviteTTT.disabled = false;
    elements.tttInviteMsg.textContent = '';
    elements.tttGrid.querySelectorAll('.tictactoe-cell').forEach(cell => {
        cell.className = 'tictactoe-cell';
        cell.textContent = '';
        cell.onclick = null;
    });
    elements.btnLeaveTTT.textContent = 'Abandonar Partida';
    elements.tttIncomingInvites.innerHTML = '<p class="small">Convites Recebidos: Nenhum</p>';
}

// Fun√ß√µes de Habilidade (Demais jogos - L√≥gica Simples)

// 3. Click Race
let clickStartTime = 0;
let clickCount = 0;
let clickTimeout = null;
const CLICK_COST = 20;
const CLICK_WIN = 60;
const CLICK_TARGET = 10;
let clickRaceCooldown = 0;

elements.btnClickStart.onclick = async () => {
    const user = auth.currentUser;
    if(!user){ showNotification('Fa√ßa login.'); return; }

    if (Date.now() < clickRaceCooldown) {
        showNotification(`Aguarde ${Math.ceil((clickRaceCooldown - Date.now()) / 1000)}s para jogar novamente.`);
        return;
    }

    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if ((doc.data().gold || 0) < CLICK_COST) throw new Error('Gold insuficiente (20 Gold).');
            tx.update(userRef, { gold: doc.data().gold - CLICK_COST });
        });
        reloadRank();
        
        // Inicia o jogo
        clickStartTime = Date.now();
        clickCount = 0;
        elements.clickCount.textContent = '0';
        elements.clickTimer.textContent = '0.00s';
        elements.btnClickStart.textContent = 'CLIQUE!';
        elements.btnClickStart.disabled = false;
        elements.btnClickStart.style.background = 'var(--main-gold)';
        elements.clickStatus.textContent = 'Cliques: 0/10 - R√ÅPIDO!';

        clickTimeout = setTimeout(() => {
            handleClickRaceEnd(false); // Perde por tempo
        }, 10000); // 10 segundos para terminar

        elements.btnClickStart.onclick = handleRaceClick;
        showNotification('Click Race Iniciado! Clique R√ÅPIDO!');

    } catch (err) {
        showNotification('Erro ao iniciar Click Race: ' + err.message);
        elements.btnClickStart.disabled = false;
        elements.btnClickStart.onclick = elements.btnClickStart.onclick; // Restaura o clique
    }
};

function handleRaceClick() {
    clickCount++;
    elements.clickCount.textContent = clickCount;

    if (clickCount >= CLICK_TARGET) {
        clearTimeout(clickTimeout);
        handleClickRaceEnd(true);
    } else {
        const elapsed = (Date.now() - clickStartTime) / 1000;
        elements.clickTimer.textContent = elapsed.toFixed(2) + 's';
    }
}

async function handleClickRaceEnd(win) {
    elements.btnClickStart.disabled = true;
    elements.btnClickStart.style.background = 'var(--btn-blue)';
    elements.btnClickStart.textContent = 'START (20 Gold)';
    elements.btnClickStart.onclick = elements.btnClickStart.onclick; // Restaura a fun√ß√£o de start
    clickRaceCooldown = Date.now() + 10000; // Cooldown de 10s

    const finalTime = (Date.now() - clickStartTime) / 1000;
    elements.clickTimer.textContent = finalTime.toFixed(2) + 's';

    if (win) {
        await updateGold(CLICK_WIN, 'Click Race ganho');
        elements.clickStatus.textContent = `üéâ VIT√ìRIA em ${finalTime.toFixed(2)}s! Ganhou ${CLICK_WIN} Gold!`;
        showNotification(`Click Race Vencido! +${CLICK_WIN} Gold`);
    } else {
        elements.clickStatus.textContent = '‚ùå TEMPO ESGOTADO! Tente novamente.';
    }
}


// 4. Jogo da Mem√≥ria
const memoryEmoticons = ['‚≠ê', 'üåü', '‚ö°', 'üî•', '‚≠ê', 'üåü', '‚ö°', 'üî•']; // 4 pares
let memoryBoard = [];
let flippedCards = [];
let matchedPairs = 0;
let memoryTimer = null;
let memoryTimeLeft = 0;
let isMemoryActive = false;
const MEMORY_COST = 50;
const MEMORY_WIN = 150;

elements.btnStartMemory.onclick = async () => {
    const user = auth.currentUser;
    if (!user) { showNotification('Fa√ßa login.'); return; }
    if (isMemoryActive) return;

    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if ((doc.data().gold || 0) < MEMORY_COST) throw new Error('Gold insuficiente (50 Gold).');
            tx.update(userRef, { gold: doc.data().gold - MEMORY_COST });
        });
        reloadRank();
        
        // Inicia o jogo
        isMemoryActive = true;
        elements.btnStartMemory.disabled = true;
        memoryTimeLeft = 60;
        matchedPairs = 0;
        memoryBoard = shuffleArray(memoryEmoticons);
        elements.memoryGrid.innerHTML = '';
        flippedCards = [];

        memoryBoard.forEach((item, index) => {
            const card = document.createElement('div');
            card.classList.add('tictactoe-cell'); // Reutilizando o estilo de c√©lula
            card.dataset.index = index;
            card.textContent = '?';
            card.onclick = () => flipCard(card, item);
            elements.memoryGrid.appendChild(card);
        });

        memoryTimer = setInterval(() => {
            memoryTimeLeft--;
            elements.memoryMsg.textContent = `Tempo Restante: ${memoryTimeLeft}s`;
            if (memoryTimeLeft <= 0) {
                clearInterval(memoryTimer);
                handleMemoryEnd(false);
            }
        }, 1000);

        showNotification('Jogo da Mem√≥ria Iniciado! 60s para achar 4 pares.');

    } catch (err) {
        showNotification('Erro ao iniciar Mem√≥ria: ' + err.message);
        elements.btnStartMemory.disabled = false;
    }
};

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function flipCard(card, item) {
    if (flippedCards.length >= 2 || card.classList.contains('matched') || card.classList.contains('flipped')) return;

    card.textContent = item;
    card.classList.add('flipped');
    flippedCards.push(card);

    if (flippedCards.length === 2) {
        const [card1, card2] = flippedCards;

        if (card1.textContent === card2.textContent) {
            // Match!
            card1.classList.add('matched');
            card2.classList.add('matched');
            card1.classList.remove('flipped');
            card2.classList.remove('flipped');
            matchedPairs++;
            flippedCards = [];

            if (matchedPairs === 4) {
                clearInterval(memoryTimer);
                handleMemoryEnd(true);
            }
        } else {
            // Mismatch - Vira de volta
            setTimeout(() => {
                card1.textContent = '?';
                card2.textContent = '?';
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                flippedCards = [];
            }, 1000);
        }
    }
}

async function handleMemoryEnd(win) {
    isMemoryActive = false;
    elements.btnStartMemory.disabled = false;
    
    if (win) {
        await updateGold(MEMORY_WIN, 'Mem√≥ria ganho');
        elements.memoryMsg.textContent = `üéâ VIT√ìRIA! Voc√™ ganhou ${MEMORY_WIN} Gold!`;
        showNotification(`Mem√≥ria Vencido! +${MEMORY_WIN} Gold`);
    } else {
        elements.memoryMsg.textContent = '‚ùå TEMPO ESGOTADO ou DESIST√äNCIA! Tente novamente.';
    }
    
    // Mostra todos os pares no final
    elements.memoryGrid.querySelectorAll('.tictactoe-cell').forEach((card, index) => {
        card.textContent = memoryBoard[index];
        card.onclick = null;
    });

    setTimeout(() => { elements.memoryMsg.textContent = ''; elements.memoryGrid.innerHTML = ''; }, 4000);
}


// ===================================
// üèÜ RANK GLOBAL
// ===================================
async function reloadRank(){
  try {
    const snap=await db.collection('users').orderBy('gold','desc').limit(50).get();
    let html='<ol>';
    snap.forEach((doc, index)=>{
      const d=doc.data();
      const goldFormatted = Number(d.gold||0).toLocaleString('pt-BR');
      html+=`<li><span>${index + 1}.</span> <strong>${escapeHtml(d.displayName||'Usu√°rio')}</strong> <span>${goldFormatted} gold</span></li>`;
    });
    html+='</ol>';
    elements.rankList.innerHTML=html;
  } catch (err) {
    console.error("Erro ao carregar rank:", err);
    elements.rankList.innerHTML = `<p class="small" style="color: #e57373;">Erro ao carregar o ranking.</p>`;
  }
}
setInterval(reloadRank, 5000); 

// ===================================
// üí¨ CHAT GLOBAL E √ÅUDIO (Base64)
// ===================================

/** Converte Base64 para Blob para tocar √°udio */
function b64toBlob(b64Data, contentType, sliceSize=512) {
  const byteCharacters = atob(b64Data);
  const byteArrays = [];

  for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
    const slice = byteCharacters.slice(offset, offset + sliceSize);
    const byteNumbers = new Array(slice.length);
    for (let i = 0; i < slice.length; i++) {
      byteNumbers[i] = slice.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    byteArrays.push(byteArray);
  }
  
  const blob = new Blob(byteArrays, {type: contentType});
  return blob;
}

async function loadChat(){
  db.collection('chat').orderBy('timestamp','desc').limit(50).onSnapshot(snapshot=>{
    elements.chatBox.innerHTML='';
    const messages = [];
    snapshot.forEach(doc=>{ messages.push(doc.data()); });
    messages.reverse().forEach(msg => { 
      const el = document.createElement('div');
      el.classList.add('chat-msg');
      const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '...';
      const userDisplayName = escapeHtml(msg.user);
      
      let contentHTML = `<strong>${userDisplayName}</strong>: `;

      if (msg.audioBase64) {
          // √â uma mensagem de √°udio (Base64)
          const audioBlob = b64toBlob(msg.audioBase64, msg.audioMimeType || 'audio/webm');
          const audioUrl = URL.createObjectURL(audioBlob);
          contentHTML += '<span style="color:#90caf9;">[√Åudio]</span>';
          contentHTML += `<audio controls class="audio-player" src="${audioUrl}"></audio>`;

      } else {
          // √â uma mensagem de texto
          const textContent = escapeHtml(msg.text);
          contentHTML += textContent;
      }
      
      el.innerHTML = `[${time}] ${contentHTML}`;
      elements.chatBox.appendChild(el);
    });
    elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
  });
}

// Envio de Texto
elements.btnSendChat.onclick=async ()=>{
  const user = auth.currentUser;
  if(!user){ showNotification('Fa√ßa login para enviar mensagens.'); return; }
  const text = elements.chatInput.value.trim();
  if(!text || text.length > 150){ showNotification('A mensagem deve ter entre 1 e 150 caracteres.'); return; }

  try {
    await db.collection('chat').add({
      user: user.email.split('@')[0],
      text: text, 
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    elements.chatInput.value='';
  } catch (err) {
    console.error(err); showNotification('Erro ao enviar mensagem: '+err.message);
  }
};

// --- Sistema de Grava√ß√£o de √Åudio ---
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

elements.btnRecordAudio.onclick = async () => {
    if (!auth.currentUser) {
        showNotification('Fa√ßa login para gravar √°udio.');
        return;
    }
    
    if (isRecording) {
        // PARAR a grava√ß√£o
        mediaRecorder.stop();
        // A l√≥gica de envio est√° no mediaRecorder.onstop
    } else {
        // INICIAR a grava√ß√£o
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                isRecording = false;
                elements.btnRecordAudio.classList.remove('recording');
                elements.chatInput.placeholder = "Processando √°udio...";
                elements.btnSendChat.disabled = true;

                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = async () => {
                    const base64Data = reader.result.split(',')[1]; 
                    const mimeType = audioBlob.type;
                    
                    try {
                        await db.collection('chat').add({
                            user: auth.currentUser.email.split('@')[0],
                            audioBase64: base64Data,
                            audioMimeType: mimeType,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showNotification('√Åudio enviado com sucesso!');
                    } catch (err) {
                        console.error('Erro ao enviar √°udio:', err);
                        showNotification('Erro ao enviar √°udio. Tente novamente.');
                    } finally {
                        stream.getTracks().forEach(track => track.stop()); 
                        elements.chatInput.placeholder = "Digite sua mensagem ou grave um √°udio...";
                        elements.btnSendChat.disabled = false;
                    }
                };
            };

            mediaRecorder.start();
            isRecording = true;
            elements.btnRecordAudio.classList.add('recording');
            elements.chatInput.placeholder = "Gravando... (m√°x 60s)";
            
            // Limite de 60 segundos
            setTimeout(() => {
                if(isRecording) {
                    showNotification("Grava√ß√£o de √°udio parou (limite de 60s). Enviando...");
                    mediaRecorder.stop();
                }
            }, 60000); 

        } catch (err) {
            console.error('Permiss√£o de √°udio negada:', err);
            showNotification('Permiss√£o de microfone negada ou indispon√≠vel.');
        }
    }
};


// ===================================
// üí∞ VENDAS (AN√öNCIOS POR DINHEIRO REAL)
// ===================================
document.getElementById('btnSubmitSale').onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
        showNotification('Fa√ßa login para publicar uma venda.');
        return;
    }
    
    const title = document.getElementById('saleTitle').value.trim();
    const price = Number(document.getElementById('salePriceReal').value);
    const contact = document.getElementById('saleContact').value.trim();
    const description = document.getElementById('saleDescription').value.trim();
    const file = document.getElementById('saleImage').files[0];
    
    if (!title || isNaN(price) || price <= 0 || !contact || !description || !file) {
        showNotification('Preencha todos os campos corretamente (T√≠tulo, Pre√ßo R$, Contato, Descri√ß√£o e Imagem).');
        return;
    }
    
    try {
        const filePath = `sales_images/${user.uid}_${Date.now()}_${file.name}`;
        const storageRef = storage.ref(filePath);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                showNotification(`Upload em andamento: ${Math.round(progress)}%`);
            }, 
            (error) => {
                console.error("Erro no upload:", error);
                showNotification('Erro ao fazer upload da imagem.');
            }, 
            async () => {
                const downloadURL = await storageRef.getDownloadURL();
                
                await db.collection('sales').add({
                    sellerUid: user.uid,
                    sellerName: user.email.split('@')[0],
                    title: title,
                    priceReal: price,
                    contact: contact,
                    description: description,
                    imageUrl: downloadURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('‚úÖ An√∫ncio Publicado! Lembre-se da modera√ß√£o (Cloud Functions).');

                document.getElementById('saleTitle').value = '';
                document.getElementById('salePriceReal').value = '';
                document.getElementById('saleContact').value = '';
                document.getElementById('saleDescription').value = '';
                document.getElementById('saleImage').value = '';
            }
        );

    } catch (err) {
        console.error(err);
        showNotification('Erro ao publicar an√∫ncio: '+err.message);
    }
};


// ===================================
// üìà CONTADOR DE VISITANTES E ADMIN
// ===================================
if (!sessionStorage.getItem('visited')) {
  db.collection('visitors').doc('count').update({total:firebase.firestore.FieldValue.increment(1)})
    .catch(() => db.collection('visitors').doc('count').set({total:1})); 
  sessionStorage.setItem('visited', 'true');
}

db.collection('visitors').doc('count').onSnapshot(doc=>{
  elements.visitorCounter.textContent = doc.data()?.total?.toLocaleString('pt-BR') || 0;
});

// Fun√ßao para atualizar Gold em transa√ß√£o (Reutilizada por v√°rios jogos)
async function updateGold(amount, reason) {
    const user = auth.currentUser;
    if (!user) return;
    try {
        await db.runTransaction(async tx => {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await tx.get(userRef);
            if (!doc.exists) throw new Error('Usu√°rio n√£o encontrado');
            const currentGold = doc.data().gold || 0;
            const newGold = currentGold + amount;
            tx.update(userRef, { gold: newGold });
        });
        reloadRank();
    } catch (e) {
        console.error(`Erro ao atualizar Gold (${reason}):`, e);
        showNotification(`Erro no Gold: ${e.message}`);
    }
}

// PAINEL DO DONO
document.getElementById('btnGive').onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.uid!==OWNER_UID){ showNotification('Acesso negado.'); return; }
  const uname = document.getElementById('adminName').value.trim();
  const amount = Number(document.getElementById('adminAmount').value);
  if(!uname || isNaN(amount)){ showNotification('Preencha corretamente o nome e a quantidade.'); return; }

  try {
    const q = await db.collection('users').where('displayName','==',uname).limit(1).get();
    if(q.empty){ showNotification('Usu√°rio n√£o encontrado.'); return; }
    const docSnapshot = q.docs[0];
    const userRef = docSnapshot.ref;
    await userRef.update({gold: firebase.firestore.FieldValue.increment(amount)});
    
    reloadRank();
    const action = amount >= 0 ? 'adicionado' : 'removido';
    showNotification(`${Math.abs(amount).toLocaleString('pt-BR')} gold ${action} para ${uname}.`);

  } catch(err) {
    console.error(err);
    showNotification('Erro na transa√ß√£o de gold: '+err.message);
  }
};

document.getElementById('btnReset').onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.uid!==OWNER_UID){ showNotification('Acesso negado.'); return; }
  if(!confirm('ATEN√á√ÉO: Certeza que deseja ZERAR o GOLD de TODOS os jogadores? Esta a√ß√£o √© irrevers√≠vel.')) return;

  try {
    const snap = await db.collection('users').get();
    const batch = db.batch();
    snap.forEach(doc => {
       batch.update(doc.ref, { gold: 0 });
    });
    await batch.commit();
    showNotification('Ranking COMPLETAMENTE RESETADO! Gold zerado.');
    reloadRank();
  } catch(err) {
    console.error(err);
    showNotification('Erro ao resetar o ranking: '+err.message);
  }
};

document.getElementById('btnClearChat').onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.uid!==OWNER_UID){ showNotification('Acesso negado.'); return; }
  if(!confirm('ATEN√á√ÉO: Certeza que deseja APAGAR TODAS as mensagens do Chat Global?')) return;

  try {
    const snap = await db.collection('chat').get();
    const batch = db.batch();
    snap.forEach(doc => {
       batch.delete(doc.ref);
    });
    await batch.commit();
    showNotification('Chat Global limpo com sucesso.');
  } catch(err) {
    console.error(err);
    showNotification('Erro ao limpar o chat: '+err.message);
  }
};

<script>
    // ----------------------------------------------------
    // 1. CONFIGURA√á√ÉO DO FIREBASE (CR√çTICO)
    // ----------------------------------------------------
    const firebaseConfig = {
        // Sua chave API confirmada
        apiKey: "AIzaSyCkmyMqEJaM8jVvmTN8I3gLnbC8YtMPWOI", 
        
        // Baseado no seu Project ID (regras-ivad)
        authDomain: "regras-ivad.firebaseapp.com", 
        
        // Seu Project ID
        projectId: "regras-ivad", 
        
        // Seu Storage Bucket
        storageBucket: "regras-ivad.firebasestorage.app", 
        
        // Seu Project Number
        messagingSenderId: "812565896201", 
        
        // **ATEN√á√ÉO: App ID SIMULADO. Se n√£o conectar, substitua pelo seu App ID Web REAL**
        appId: "1:812565896201:web:d82f7e02e861d9a2a3b05a" 
    };

    // Inicializa o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore();
    const auth = app.auth();
    const storage = app.storage();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    // Constante para o UID do Admin (Para Painel do Dono e Regras)
    const OWNER_UID = 'm3h06woQv2V7lrNu1p8fDQCZ8IW2'; // <-- SUBSTITUA PELO SEU UID REAL DE ADMIN

    // Vari√°veis globais
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    // ----------------------------------------------------
    // 2. L√ìGICA DE INTERFACE E TABS
    // ----------------------------------------------------
    document.querySelectorAll('.tabbtn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.tabbtn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.content > div').forEach(div => div.style.display = 'none');
            document.getElementById(this.dataset.tab).style.display = 'block';

            // Chamadas espec√≠ficas ao carregar as abas
            if (this.dataset.tab === 'rankTab') {
                loadRank(true); // For√ßa a atualiza√ß√£o imediata
            }
            if (this.dataset.tab === 'socialTab') {
                loadFriendList();
            }
        });
    });

    // ----------------------------------------------------
    // 3. L√ìGICA DE AUTENTICA√á√ÉO E PERFIL
    // ----------------------------------------------------

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('signedOutUI').style.display = 'none';
            document.getElementById('signedInUI').style.display = 'block';
            document.getElementById('userLabel').textContent = `Bem-vindo, ${user.displayName || 'An√¥nimo'}!`;
            document.getElementById('playerInfo').style.display = 'block';
            document.getElementById('playerInfoSocial').style.display = 'block';
            document.getElementById('socialUsername').textContent = user.displayName || 'An√¥nimo';
            document.getElementById('socialUserId').textContent = user.uid;

            if (user.uid === OWNER_UID) {
                document.getElementById('ownerPanel').style.display = 'block';
            } else {
                document.getElementById('ownerPanel').style.display = 'none';
            }
            
            // Carrega e monitora o Gold do usu√°rio em tempo real
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                const data = doc.data();
                const gold = data ? (data.gold || 0).toLocaleString('pt-BR') : 0;
                document.getElementById('myGold').textContent = gold;
                document.getElementById('playerGold').textContent = gold;
            });
            
            loadChat(); // Inicia a escuta do chat ap√≥s login
        } else {
            document.getElementById('signedOutUI').style.display = 'block';
            document.getElementById('signedInUI').style.display = 'none';
            document.getElementById('playerInfo').style.display = 'none';
            document.getElementById('playerInfoSocial').style.display = 'none';

            // Tenta login an√¥nimo para permitir a leitura do Rank e Chat
            auth.signInAnonymously().catch(error => {
                console.error("Erro ao logar anonimamente:", error);
            });
        }
    });

    document.getElementById('btnLogout').addEventListener('click', () => auth.signOut());
    
    // --- Fun√ß√µes de Login e Cadastro (Simples) ---
    document.getElementById('btnSignup').addEventListener('click', () => {
        const email = document.getElementById('username').value + '@ivad.temp'; // Usa nome como parte do email
        const password = document.getElementById('pwd').value;
        const name = document.getElementById('username').value;
        
        if (!name || password.length < 6) return alert("Nome e senha (m√≠n. 6 caracteres) s√£o obrigat√≥rios.");

        auth.createUserWithEmailAndPassword(email, password)
            .then(cred => {
                return cred.user.updateProfile({ displayName: name }).then(() => {
                    // Cria o documento inicial do usu√°rio no Firestore
                    return db.collection('users').doc(cred.user.uid).set({
                        name: name,
                        displayName: name,
                        gold: 100, // Gold inicial
                        createdAt: serverTimestamp()
                    });
                });
            })
            .then(() => alert("Conta criada com sucesso! 100 Gold de b√¥nus."))
            .catch(error => alert("Erro ao criar conta: " + error.message.replace('auth/', '')));
    });

    document.getElementById('btnLogin').addEventListener('click', () => {
        const email = document.getElementById('username').value + '@ivad.temp';
        const password = document.getElementById('pwd').value;
        auth.signInWithEmailAndPassword(email, password)
            .catch(error => alert("Erro no login: " + error.message.replace('auth/', '')));
    });

    // ----------------------------------------------------
    // 4. L√ìGICA DO RANK GLOBAL (COMPETITIVO EM TEMPO REAL)
    // ----------------------------------------------------

    function loadRank(force = false) {
        const rankList = document.querySelector('.rank-list ol') || document.createElement('ol');
        if (!document.querySelector('.rank-list ol')) {
            const container = document.querySelector('.rank-list') || document.getElementById('rankList');
            if(container) container.innerHTML = '';
            container.appendChild(rankList);
        }

        db.collection("users")
            .orderBy("gold", "desc")
            .limit(10)
            .get()
            .then(snapshot => {
                let html = '';
                let position = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const userName = data.displayName || data.name || `Usu√°rio #${doc.id.substring(0, 4)}`;
                    const gold = data.gold ? data.gold.toLocaleString('pt-BR') : 0;
                    const isCurrentUser = auth.currentUser && doc.id === auth.currentUser.uid;
                    const style = isCurrentUser ? 'style="border: 2px solid var(--main-gold); background: rgba(255,179,0,0.1); border-radius: 4px;"' : '';

                    html += `
                        <li ${style}>
                            <span>${position}. <strong>${userName}</strong></span> 
                            <span>${gold} Gold</span>
                        </li>
                    `;
                    position++;
                });
                rankList.innerHTML = html;
            })
            .catch(error => {
                rankList.innerHTML = '<li>Erro ao carregar o rank. Verifique as Regras.</li>';
                console.error("Erro ao carregar o rank: ", error);
            });
    }
    
    // Atualiza o rank a cada 5 segundos para manter a competitividade
    setInterval(loadRank, 5000); 
    loadRank(); // Carrega na inicializa√ß√£o


    // ----------------------------------------------------
    // 5. L√ìGICA DO CHAT GLOBAL (TEMPO REAL E √ÅUDIO)
    // ----------------------------------------------------

    function loadChat() {
        const chatMessagesDiv = document.querySelector('.chat-box') || document.createElement('div');
        if (!document.querySelector('.chat-box')) {
            // Se o elemento n√£o existe (porque o c√≥digo HTML foi cortado), cria um b√°sico
            chatMessagesDiv.classList.add('chat-box');
            // Voc√™ pode querer coloc√°-lo em uma aba espec√≠fica se o HTML for restaurado
            document.getElementById('chatTab').appendChild(chatMessagesDiv); 
        }

        db.collection("chat")
            .orderBy("timestamp", "asc")
            .limitToLast(50) 
            .onSnapshot(snapshot => {
                chatMessagesDiv.innerHTML = ''; 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const userName = data.userName || "An√¥nimo";
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : 'agora';
                    const isCurrentUser = auth.currentUser && data.userId === auth.currentUser.uid;
                    const nameColor = isCurrentUser ? 'var(--main-gold)' : '#42a5f5';
                    
                    let content = '';
                    if (data.message) {
                        content = data.message;
                    } else if (data.audioURL) {
                        content = `
                            üîà √Åudio: 
                            <audio controls class="audio-player" src="${data.audioURL}"></audio>
                        `;
                    }

                    const msgElement = document.createElement('div');
                    msgElement.classList.add('chat-msg');
                    msgElement.innerHTML = `<strong style="color:${nameColor}">[${timestamp}] ${userName}:</strong> ${content}`;
                    chatMessagesDiv.appendChild(msgElement);
                });
                // Rola para o final para ver a mensagem mais recente
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }, error => {
                console.error("Erro ao carregar o chat em tempo real:", error);
            });
    }
    
    // Envia mensagem de TEXTO
    window.sendMessage = function() {
        const user = auth.currentUser;
        const input = document.getElementById('chat-message-input');
        const messageText = input.value.trim();

        if (!user || user.isAnonymous) {
            alert("Voc√™ precisa fazer login (n√£o an√¥nimo) para enviar mensagens.");
            return;
        }

        if (messageText === "") return;

        db.collection("chat").add({
            userId: user.uid,
            userName: user.displayName || `Competidor-${user.uid.substring(0, 4)}`,
            message: messageText,
            timestamp: serverTimestamp()
        })
        .then(() => {
            input.value = ''; // Limpa o campo
        })
        .catch(error => {
            alert("Erro ao enviar mensagem. Verifique as Regras de Seguran√ßa!");
            console.error("Erro ao enviar mensagem:", error);
        });
    }
    
    // Configura eventos de √°udio
    const btnRecordAudio = document.getElementById('btnRecordAudio');
    if(btnRecordAudio) {
        btnRecordAudio.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });
    }

    // --- L√≥gica de √Åudio (startRecording, stopRecording, uploadAudio) ---
    // (As fun√ß√µes de √°udio do seu c√≥digo anterior foram otimizadas e inseridas aqui)

    function startRecording() {
        if (!auth.currentUser || auth.currentUser.isAnonymous) {
            alert("Voc√™ precisa fazer login (n√£o an√¥nimo) para gravar √°udio.");
            return;
        }

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                // Atualiza a UI
                btnRecordAudio.classList.add('recording');
                btnRecordAudio.textContent = 'üõë Parar';
                document.getElementById('chat-message-input').placeholder = 'üî¥ Gravando...';
                document.getElementById('chat-message-input').disabled = true;

                setTimeout(() => {
                    if (isRecording) stopRecording();
                }, 60000); 
            })
            .catch(error => {
                alert('Erro: Microfone n√£o encontrado ou permiss√£o negada.');
            });
    }

    function stopRecording() {
        if (!mediaRecorder || !isRecording) return;

        mediaRecorder.stop();
        isRecording = false;

        btnRecordAudio.classList.remove('recording');
        btnRecordAudio.textContent = 'Aguarde...';
        btnRecordAudio.disabled = true;

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            uploadAudio(audioBlob);

            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        };
    }

    function uploadAudio(audioBlob) {
        const user = auth.currentUser;
        const fileName = `${user.uid}/${Date.now()}.webm`;
        const storageRef = storage.ref().child('chat_audios/' + fileName);

        storageRef.put(audioBlob)
            .then(snapshot => snapshot.ref.getDownloadURL())
            .then(audioURL => {
                return db.collection("chat").add({
                    userId: user.uid,
                    userName: user.displayName || `Competidor-${user.uid.substring(0, 4)}`,
                    audioURL: audioURL,
                    timestamp: serverTimestamp()
                });
            })
            .then(() => {
                btnRecordAudio.textContent = 'üé§ Gravar √Åudio';
                btnRecordAudio.disabled = false;
                document.getElementById('chat-message-input').placeholder = 'Digite sua mensagem...';
                document.getElementById('chat-message-input').disabled = false;
                showGlobalNotice("√Åudio enviado com sucesso!", 'var(--green-win)');
            })
            .catch(error => {
                btnRecordAudio.textContent = 'Erro! Tente Novamente';
                btnRecordAudio.disabled = false;
                document.getElementById('chat-message-input').placeholder = 'Digite sua mensagem...';
                document.getElementById('chat-message-input').disabled = false;
                alert("Erro ao enviar √°udio. Verifique suas Regras de Storage!");
                console.error("Erro ao fazer upload ou enviar √°udio:", error);
            });
    }


    // ----------------------------------------------------
    // 6. FUN√á√ïES DIVERSAS E ADMIN (Exemplo de Transa√ß√£o)
    // ----------------------------------------------------

    // Exemplo de Transa√ß√£o Segura: Dar/Remover Gold (Admin)
    document.getElementById('btnGive').addEventListener('click', () => {
        const adminName = document.getElementById('adminName').value;
        const adminAmount = parseInt(document.getElementById('adminAmount').value);

        if (auth.currentUser.uid !== OWNER_UID) return alert("Acesso negado.");
        if (!adminName || isNaN(adminAmount) || adminAmount === 0) return alert("Preencha nome e valor v√°lido.");

        db.collection("users").where("displayName", "==", adminName).limit(1).get()
            .then(snapshot => {
                if (snapshot.empty) return alert("Usu√°rio n√£o encontrado.");
                const targetUid = snapshot.docs[0].id;
                
                return db.runTransaction(transaction => {
                    const userRef = db.collection('users').doc(targetUid);
                    return transaction.get(userRef).then(doc => {
                        const newGold = (doc.data().gold || 0) + adminAmount;
                        transaction.update(userRef, { gold: newGold });
                        showGlobalNotice(`Gold de ${adminName} alterado para ${newGold}.`, 'var(--btn-blue)');
                    });
                });
            })
            .catch(error => {
                console.error("Erro na transa√ß√£o de Gold:", error);
                alert("Erro ao processar transa√ß√£o.");
            });
    });

    // Fun√ß√µes de jogos (Trabalhar/Apostar - Exemplo de uso de Transa√ß√µes)
    window.work = function() {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return alert("Fa√ßa login para trabalhar.");
        
        db.runTransaction(transaction => {
            const userRef = db.collection('users').doc(user.uid);
            return transaction.get(userRef).then(doc => {
                const currentGold = doc.data().gold || 0;
                const earned = Math.floor(currentGold * (Math.random() * 0.99 + 0.01)); // 1% a 100%
                const newGold = currentGold + earned;

                transaction.update(userRef, { gold: newGold });
                document.getElementById('workMsg').textContent = `üí∞ Voc√™ ganhou ${earned.toLocaleString('pt-BR')} Gold! Total: ${newGold.toLocaleString('pt-BR')}`;
            });
        }).catch(error => {
            console.error("Erro na transa√ß√£o de trabalho:", error);
            document.getElementById('workMsg').textContent = `‚ùå Aguarde 5 segundos antes de trabalhar novamente.`;
        });
    };
    
    // Adiciona o evento de trabalho (simulando cooldown pelo erro da transa√ß√£o)
    document.getElementById('btnWork').addEventListener('click', work);


    // Exibe notifica√ß√£o global no canto
    function showGlobalNotice(message, color = 'var(--main-gold)') {
        const notice = document.getElementById('globalNotice');
        if(!notice) return; // Se o elemento n√£o foi carregado pelo corte no HTML

        // Cria o elemento se ele n√£o existir
        if (!notice.parentElement) document.body.appendChild(notice);

        notice.textContent = message;
        notice.style.backgroundColor = color;
        notice.style.display = 'block';
        
        // Reinicia a anima√ß√£o
        notice.style.animation = 'none';
        void notice.offsetWidth; // Trigger reflow
        notice.style.animation = 'fadeInOut 4.5s cubic-bezier(0.19, 1, 0.22, 1) forwards';
    }

    // Visitas online (Exemplo simples de documento contador)
    function trackVisitor() {
        if (!auth.currentUser) return; // Apenas conta usu√°rios autenticados
        
        const docRef = db.collection('visitors').doc(auth.currentUser.uid);
        docRef.set({
            lastActive: serverTimestamp()
        }, { merge: true });

        // Limpa visitantes inativos (ex: 5 minutos)
        const fiveMinutesAgo = new Date(Date.now() - 300000); 

        db.collection('visitors').where('lastActive', '>', fiveMinutesAgo).onSnapshot(snapshot => {
            document.getElementById('visitorCount').textContent = snapshot.size;
        });
    }
    
    auth.onAuthStateChanged(trackVisitor); // Inicia o contador ao logar
    
    // Fun√ß√µes de Amigos (Mockup - apenas listagem e adi√ß√£o)
    window.loadFriendList = function() {
        const user = auth.currentUser;
        if (!user) return;
        
        // L√≥gica real seria carregar a subcole√ß√£o 'friends' do documento do usu√°rio.
        // Simulando com uma lista b√°sica aqui:
        const friendList = document.getElementById('friendList');
        // Voc√™ precisaria de um array de UIDs de amigos no documento do usu√°rio
        // e buscar o perfil de cada um para preencher a lista.
        friendList.innerHTML = '<p class="small" style="text-align: center;">Funcionalidade Social requer l√≥gica de backend mais complexa. Adicionar/Listar amigos n√£o est√° totalmente implementado.</p>';
        document.getElementById('friendCount').textContent = '0 (Mock)';
    }


</script>
</body>
</html>
