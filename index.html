<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVAD TROCAS E VENDAS - MULTIJOGOS</title>
<style>
/* VARS */
:root{
  --card-bg: rgba(15, 10, 30, 0.95); /* Deep Violet Transparent */
  --btn-gradient: linear-gradient(90deg, #5EEAD4, #10B981); /* Teal/Green */
  --btn-blue: linear-gradient(90deg, #8B5CF6, #6D28D9); /* Deep Purple Blue */
  --btn-red: linear-gradient(90deg, #F87171, #EF4444); /* Red */
  --text-primary: #E5E7EB;
  --text-secondary: #C4B5FD; /* Light purple for secondary text */
  --main-gold: #FCD34D; /* Light Gold */
  --border-color: rgba(139, 92, 246, 0.3); /* Purple Border */
  --green-win: #10B981;
  --red-loss: #EF4444;
}

/* BASE & LAYOUT */
html,body{height:100%;margin:0;font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color:var(--text-primary);background:#05050A}
body{perspective:1000px;overflow-x:hidden}

.bg3d{
  position:fixed;inset:0;
  /* NOVO FUNDO 3D: Imagem de Nebulosa Roxa/Azul */
  background:url('https://i.imgur.com/gK2g2f7.jpeg') no-repeat center center; 
  background-size:cover;z-index:-2;
  /* Efeito de cor e contraste para vibrante */
  filter:contrast(1.2) saturate(1.5) brightness(0.65); 
  transform-origin:center center;animation:float3d 18s ease-in-out infinite alternate;
}
@keyframes float3d{
  0%{transform:translateZ(0px) rotateY(0deg) rotateX(0deg) scale(1.05)}
  50%{transform:translateZ(15px) rotateY(2deg) rotateX(1deg) scale(1.06)}
  100%{transform:translateZ(0px) rotateY(-1deg) rotateX(-1deg) scale(1.05)}
}
.overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(135deg, rgba(5,5,10,0.95), rgba(5,5,10,0.6))}

header{
    background:var(--card-bg);padding:1.4rem;text-align:center;position:relative;z-index:2;
    border-bottom: 3px solid var(--main-gold); box-shadow: 0 4px 25px rgba(0,0,0,0.9);
}
header h1{margin:.2rem;font-size:2.4rem; letter-spacing: 5px; text-shadow: 0 0 18px rgba(252,211,77,0.9); font-weight: 900; }
header p{margin:.1rem;color:var(--text-secondary);font-size:1rem; font-style: italic;}

.container{max-width:1200px;margin:3rem auto;padding:1rem;display:grid;grid-template-columns:280px 1fr;gap:2.5rem}
.card{background:var(--card-bg);padding:2rem;border-radius:15px;box-shadow:0 15px 50px rgba(0,0,0,0.95);border: 1px solid var(--border-color); transition: transform 0.3s, box-shadow 0.3s;}

/* MENU E ABAS */
.menu button{
    display:block;width:100%;margin-bottom:.9rem;padding:1rem 1rem;border-radius:12px;border:none;
    background:rgba(255,255,255,0.08);color:var(--text-primary);font-weight:600;cursor:pointer;
    transition:all .3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.6); text-align: left;
}
.menu button:hover{
    transform:translateY(-3px);
    background:rgba(255,255,255,0.12);
    box-shadow:0 10px 25px rgba(252,211,77,0.4);
}
.menu button.active{
    background:var(--btn-blue); /* Mudan√ßa para azul-roxo */
    color:var(--text-primary);
    transform:translateY(0);
    box-shadow:0 4px 15px rgba(0,0,0,0.8); font-weight: 700;
}

/* CONTE√öDO */
.content h2{
    margin-top:0; border-bottom: 3px solid var(--main-gold); padding-bottom: 15px; 
    margin-bottom: 2rem; color: var(--main-gold); font-size: 2rem; font-weight: 800;
}
.content h3 { color: var(--text-primary); margin-top: 2rem; border-left: 4px solid var(--green-win); padding-left: 10px; }
ul{padding-left:1.5rem}
.small{font-size:.88rem;color:var(--text-secondary)}

/* BOT√ïES GERAIS (Efeito Neon Glow Refor√ßado) */
.btn{
  display:inline-block;padding:1rem 2rem;border-radius:12px;border:none;background:var(--btn-gradient);
  color:#111;font-weight:800;cursor:pointer; transition: all .3s; position: relative; overflow: hidden;
  box-shadow: 0 0 20px rgba(94, 237, 212, 0.5); /* Sombra mais forte */
}
.btn:hover:not(:disabled){
    box-shadow: 0 0 40px rgba(94, 237, 212, 1), 0 0 15px rgba(0,0,0,0.7); 
    transform: scale(1.03) translateY(-2px);
}
.btn:disabled{opacity:0.4; cursor: not-allowed; filter: grayscale(100%); box-shadow: none;}

/* INPUTS */
input[type="text"],input[type="password"],input[type=number],select,textarea{
    width:100%;padding:1rem;margin:.6rem 0;border-radius:10px;
    border:1px solid var(--border-color);background:rgba(0,0,0,0.6);
    color:var(--text-primary);box-sizing: border-box; transition: border-color .3s, box-shadow .3s;
}
input:focus, textarea:focus{
    outline: none; border-color: var(--main-gold); 
    box-shadow: 0 0 8px var(--main-gold);
}
/* Estilo para input file */
input[type="file"]{
    padding: 10px; 
    background: rgba(255,255,255,0.05); 
    border-radius: 10px; 
    border: 1px dashed var(--border-color); 
    color: var(--text-secondary);
}
input[type="file"]::-webkit-file-upload-button {
    background: var(--btn-blue);
    color: white;
    padding: 8px 15px;
    border-radius: 8px;
    border: none;
    outline: none;
    cursor: pointer;
    margin-right: 10px;
}
input[type="file"]::file-selector-button { /* Padr√£o moderno */
    background: var(--btn-blue);
    color: white;
    padding: 8px 15px;
    border-radius: 8px;
    border: none;
    outline: none;
    cursor: pointer;
    margin-right: 10px;
}


/* VENDAS GRID */
.sales-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px;
}
.sale-post {
    background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 15px;
    border: 1px solid var(--border-color);
    box-shadow: 0 6px 20px rgba(0,0,0,0.7); transition: transform 0.4s, box-shadow 0.4s;
}
.sale-post:hover { transform: translateY(-7px); box-shadow: 0 12px 35px rgba(0,0,0,0.9); }

.sale-post img {
    width: 100%; height: 240px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;
    border: 3px solid var(--main-gold);
}
.sale-price {
    font-size: 1.8rem; color: var(--green-win); font-weight: bold; margin: 5px 0;
}
.sale-contact-btn {
    display: block; width: 100%; margin-top: 15px; 
    padding: 14px; border-radius: 10px; text-decoration: none; text-align: center;
    font-weight: bold; font-size: 1.1rem; transition: background .3s, transform .2s;
    border: none; cursor: pointer;
}
.sale-contact-btn:hover { transform: scale(1.02); }


/* RANKING */
.rank-list{max-height:500px;overflow-y:auto;padding:1.5rem; background: rgba(0,0,0,0.6); border-radius: 10px;}
.rank-list li{padding: 5px 0; border-bottom: 1px dotted var(--border-color); transition: background-color 0.2s, padding-left 0.2s; display: flex; justify-content: space-between; align-items: center;}
.rank-list li:last-child { border-bottom: none; }
.rank-list li:hover { background-color: rgba(255,255,255,0.1); padding-left: 15px; border-radius: 6px; }

/* CHAT */
.chat-box{max-height:380px;overflow-y:auto;background:rgba(0,0,0,0.5);padding:1rem;margin-top:1rem;border-radius:12px;border: 1px solid var(--border-color)}
.chat-input-area{margin-top:1rem; display: flex; gap: 8px; align-items: stretch;}
.chat-input-area input[type=text]{margin: 0; flex-grow: 1; padding: 1rem; border-radius: 12px;}
.chat-input-area button{padding: 0 1.5rem; margin: 0; font-size: 1.2rem; border-radius: 12px;}
#btnRecordAudio{background: var(--btn-blue); color: #fff; width: 65px; font-size: 1.6rem; opacity: 0.5;} /* Desabilitado por enquanto */

/* JOGOS */
.game-area{
    display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;
}
.bet-option-card {
    background: rgba(255,255,255,0.08); padding: 1.8rem; border-radius: 15px;
    border: 1px solid var(--main-gold); /* Borda de ouro */
}
.bet-option-card h3 { color: var(--main-gold); font-size: 1.5rem; margin-bottom: 0.8rem; }


/* NOTIFICA√á√ÉO GLOBAL */
#globalNotice{
    position:fixed;top:20px;right:20px;background:var(--main-gold);color:#111;padding:1.2rem 2.2rem;border-radius:12px;display:none;z-index:9999;
    font-weight:900;box-shadow:0 8px 30px rgba(0,0,0,0.9);
    animation: fadeInOut 4.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
}
/* Requisito de Cooldown para o Trabalho */
#btnWork.cooldown {
    opacity: 0.6;
    cursor: not-allowed;
    background: var(--btn-red);
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
}

@media(max-width:880px){ 
    .container{grid-template-columns:1fr; padding:.5rem; margin-top: 1.5rem} 
    .menu{order:2} 
    header h1 { font-size: 1.8rem; letter-spacing: 3px; }
    .game-area { grid-template-columns: 1fr; }
    .sales-grid { grid-template-columns: 1fr; }
    .menu button { text-align: center; }
}
</style>
</head>
<body>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<div class="bg3d" aria-hidden="true"></div>
<div class="overlay" aria-hidden="true"></div>

<header>
  <h1>IVAD TROCAS E VENDAS</h1>
  <p>O melhor ambiente multijogos de compra e venda.</p>
</header>

<main class="container">
  <aside class="card menu">
    <button class="tabbtn active" data-tab="regrasTab">üìú REGRAS</button>
    <button class="tabbtn" data-tab="socialTab">ü§ù SOCIAL (ID e Amigos)</button>
    <button class="tabbtn" data-tab="jogoSimplesTab">üí∞ GOLD SIMPLES</button>
    <button class="tabbtn" data-tab="apostasAvancadasTab">üé≤ APOSTAS AVAN√áADAS</button>
    <button class="tabbtn" data-tab="habilidadeTab">üß† JOGOS DE HABILIDADE</button>
    <button class="tabbtn" data-tab="salesTab">üõí VENDAS (Dinheiro Real)</button>
    <button class="tabbtn" data-tab="rankTab">üèÜ RANK GLOBAL</button>
    <button class="tabbtn" data-tab="chatTab">üí¨ CHAT GLOBAL</button>
    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">

    <div id="authArea" class="small">
      <div id="signedOutUI">
        <input id="username" type="text" placeholder="Nome de Usu√°rio (√∫nico)">
        <input id="pwd" type="password" placeholder="Senha (m√≠n. 6 caracteres)">
        <div style="display:flex;gap:.5rem; margin-top: 10px;">
          <button id="btnSignup" class="btn" onclick="signup()" style="background:var(--btn-blue); flex-grow: 1; padding: .8rem;">Criar conta</button>
          <button id="btnLogin" class="btn" onclick="login()" style="flex-grow: 1; padding: .8rem;">Entrar</button>
        </div>
        <p class="small" style="margin-top: 8px;">Nome de usu√°rio √© √∫nico e n√£o pode ser alterado.</p>
      </div>

      <div id="signedInUI" style="display:none">
        <p style="margin-bottom: .8rem; font-size: 1.1rem;"><strong id="userLabel"></strong></p>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="btnLogout" class="btn" onclick="auth.signOut()" style="background:var(--btn-red); padding: .7rem 1.2rem; font-size: 0.9rem;">Sair</button>
          <div style="margin-left:auto; font-size: 1.3rem;"><span class="small" style="color:var(--main-gold); font-size: 0.9em;">Gold: </span><strong id="myGold" style="color: var(--main-gold);">0</strong></div>
        </div>
      </div>
    </div>

    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
    <div id="ownerPanel" style="display:none">
      <h4 style="margin:.3rem 0; color: #e57373;">üõ†Ô∏è Painel do Dono</h4>
      <input id="adminName" placeholder="Nome do Usu√°rio (exato)">
      <input id="adminAmount" type="number" placeholder="Gold (+/-)">
      <button id="btnGive" class="btn" onclick="adminGiveGold()" style="width: 100%; margin-top: .5rem; background: var(--btn-blue);">Dar/Remover Gold</button>
      <button id="btnClearChat" class="btn" onclick="adminClearChat()" style="background:var(--btn-red);margin-top:.5rem; width: 100%;">Limpar Chat Global</button>
      <p class="small" style="margin-top: 5px; color: #F87171;">Apenas para OWNER_UID.</p>
    </div>
    <hr style="border:none;height:1px;background:var(--border-color);margin:15px 0">
    <p class="small">Visitantes online: <strong id="visitorCount">0</strong></p>
  </aside>

  <section class="card content">
    <div id="regrasTab">
      <h2>üìú Regras da Comunidade</h2>
      <h3 style="color: var(--red-loss);">üö´ Proibido (Banimento Imediato)</h3>
      <ul>
        <li>**Conte√∫do NSFW:** Fotos ou links de **partes √≠ntimas** ou expl√≠cito. (An√°lise de IA e banimento acionados).</li>
        <li>**Ofensas Graves/Racismo:** Qualquer forma de desrespeito ou preconceito.</li>
        <li>**Golpes/Scam:** Tentar enganar outros membros.</li>
        <li>**Spam** ou flood excessivo.</li>
      </ul>
      <h3 style="color: var(--green-win);">‚úÖ Permitido</h3>
      <ul>
        <li>Anunciar itens e contas de jogo na aba Vendas.</li>
        <li>Negociar e interagir de forma educada e transparente.</li>
        <li>Usar o Chat Global para assuntos da comunidade.</li>
      </ul>
      <h3 style="color: var(--main-gold);">‚ö†Ô∏è Observa√ß√µes de Venda</h3>
      <ul>
        <li>Negocia√ß√µes s√£o **responsabilidade das partes**.</li>
        <li>O descumprimento das regras de conte√∫do resulta em **banimento permanente**.</li>
      </ul>
    </div>

    <div id="socialTab" style="display:none">
      <h2>ü§ù Social: Amigos e ID</h2>
      <div id="playerInfoSocial" class="user-id-box card" style="display:none; background: rgba(0,0,0,0.4); padding: 1.5rem;">
          <p style="margin: 0;"><span class="small" style="color:var(--main-gold);">Seu Nome: </span><strong id="socialUsername"></strong></p>
          <p style="margin: 5px 0 0 0;"><span class="small" style="color:var(--main-gold);">Seu ID √önico: </span><strong id="socialUserId"></strong></p>
          <p class="small" style="margin-top: 10px;">Compartilhe este ID para ser adicionado.</p>
      </div>
      <h3 style="color: var(--btn-blue);">Minha Lista de Amigos</h3>
      <ul class="friend-list" id="friendList">
        <p class="small" style="text-align: center; margin: 10px 0;">Funcionalidade de amigos ser√° implementada em breve.</p>
      </ul>
    </div>

    <div id="jogoSimplesTab" style="display:none">
        <h2>üí∞ Gold Simples (Trabalho e Apostas)</h2>
      
        <div id="playerInfo" class="card" style="margin-bottom:1.5rem; padding: 1rem; background: rgba(255,255,255,0.1); display:block; border: 1px solid var(--main-gold);">
            <p style="margin: 0; font-size: 1.1rem;">Seu Gold: <strong id="playerGold" style="color: var(--main-gold);">0</strong></p>
        </div>

        <h3 style="margin-top: 1rem;">üíº Trabalhar (RNG)</h3>
        <p class="small">Ganho varia de **1% a 100%** do seu Gold atual. (Cooldown: 5s)</p>
        <button id="btnWork" class="btn" onclick="work()">Trabalhar (Gold Aleat√≥rio)</button>
        <span id="workMsg" class="small" style="margin-left:1rem; color: #5EEAD4;"></span>

        <hr style="border:none;height:1px;background:var(--border-color);margin:25px 0">

        <h3 style="margin-top: 1rem;">Apostas R√°pidas (Multiplicadores)</h3>
        
        <div class="game-area">
            <div class="bet-option-card">
                <h4 style="color: var(--main-gold); margin-top: 0;">2x (Mediano)</h4>
                <p class="small">Tente dobrar sua aposta. 45% de chance.</p>
                <input type="number" id="betAmount_2x" placeholder="Quantos golds apostar?" min="1">
                <button onclick="betSimple(2, 'betAmount_2x', 'betMsg_2x', 45)" class="btn" style="background: var(--btn-gradient); width: 100%; margin-top: 10px;">Apostar 2x</button>
                <span id="betMsg_2x" class="small" style="display: block; margin-top: 8px;"></span>
            </div>
            
            <div class="bet-option-card">
                <h4 style="color: var(--btn-blue); margin-top: 0;">5x (Alto Risco)</h4>
                <p class="small">Arrisque por 5x. Chance de 20%.</p>
                <input type="number" id="betAmount_5x" placeholder="Quantos golds apostar?" min="1">
                <button onclick="betSimple(5, 'betAmount_5x', 'betMsg_5x', 20)" class="btn" style="background:var(--btn-blue); width: 100%; margin-top: 10px;">Apostar 5x</button>
                <span id="betMsg_5x" class="small" style="display: block; margin-top: 8px;"></span>
            </div>
            
            <div class="bet-option-card">
                <h4 style="color: var(--btn-red); margin-top: 0;">10x (Aposta Extrema)</h4>
                <p class="small">Alt√≠ssimo risco. Chance de 10%.</p>
                <input type="number" id="betAmount_10x" placeholder="Quantos golds apostar?" min="1">
                <button onclick="betSimple(10, 'betAmount_10x', 'betMsg_10x', 10)" class="btn" style="background:var(--btn-red); width: 100%; margin-top: 10px;">Apostar 10x</button>
                <span id="betMsg_10x" class="small" style="display: block; margin-top: 8px;"></span>
            </div>
        </div>
    </div>

    <div id="apostasAvancadasTab" style="display:none">
        <h2>üé≤ Apostas Avan√ßadas</h2>

        <p class="small">Jogos mais elaborados com maior intera√ß√£o e potencial de ganho/perda.</p>

        <div class="game-area">
            <div class="bet-option-card">
                <h3 style="margin-top: 0;">Cor (2x ou 4x)</h3>
                <p class="small">Aposte no Vermelho (2x), Preto (2x) ou Verde (4x).</p>
                <input type="number" id="betCorAmount" placeholder="Gold para apostar" min="1">
                <select id="betCorColor" style="margin-bottom: 10px; padding: 10px; border-radius: 8px; width: 100%; background: rgba(0,0,0,0.7); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <option value="red" style="color: red;">Vermelho (48%)</option>
                    <option value="black" style="color: #333;">Preto (48%)</option>
                    <option value="green" style="color: green;">Verde (4%)</option>
                </select>
                <button onclick="betCor()" class="btn" style="width: 100%;">Girar</button>
                <span id="betCorMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>
            
            <div class="bet-option-card">
                <h3 style="margin-top: 0;">Moeda da Sorte (2x)</h3>
                <p class="small">Aposte cara ou coroa. 50% de chance. (Exclusivo)</p>
                <input type="number" id="betCoinAmount" placeholder="Gold para apostar" min="1">
                <select id="betCoinSide" style="margin-bottom: 10px; padding: 10px; border-radius: 8px; width: 100%; background: rgba(0,0,0,0.7); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <option value="cara">Cara</option>
                    <option value="coroa">Coroa</option>
                </select>
                <button onclick="betCoin()" class="btn" style="width: 100%;">Lan√ßar Moeda</button>
                <span id="betCoinMsg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>
            
            <div class="bet-option-card">
                <h3 style="margin-top: 0;">DICE 12x (Extremo)</h3>
                <p class="small">Acerte um n√∫mero de 1 a 12. Paga 12x a aposta. (8.3% chance)</p>
                <input type="number" id="betDice12Amount" placeholder="Gold para apostar" min="1">
                <input type="number" id="betDice12Number" placeholder="Seu N√∫mero (1-12)" min="1" max="12">
                <button onclick="betDice(12, 12, 'betDice12Amount', 'betDice12Number', 'betDice12Msg')" class="btn" style="width: 100%; background: var(--btn-red);">Rolar Alto Risco</button>
                <span id="betDice12Msg" class="small" style="display: block; margin-top: 5px;"></span>
            </div>
            
            <div class="bet-option-card">
                <h3 style="margin-top: 0;">N√∫mero M√°gico (4x)</h3>
                <p class="small">Aposta fixa de 50 Gold. Chance de 25% de acertar.</p>
                <button onclick="betRNG(4, 50, 25, 'betRNGMsg_4x')" class="btn" style="width: 100%; background: var(--btn-blue);">Apostar 50 Gold (4x)</button>
                <span id="betRNGMsg_4x" class="small" style="display: block; margin-top: 5px;"></span>
            </div>
            
             <div class="bet-option-card" style="opacity: 0.5;">
                <h3 style="margin-top: 0;">Roleta de Pr√™mios VIP</h3>
                <p class="small">Custo 100 Gold. (Em desenvolvimento: Funcionalidade visual da roleta)</p>
                <div style="position: relative; text-align: center; margin-bottom: 20px;">
                    <div class="wheel-pointer"></div>
                    <button class="btn" disabled>Girar Roleta (Em Breve)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="habilidadeTab" style="display:none">
        <h2>üß† Jogos de Habilidade</h2>
        <p class="small">Jogos que dependem da sua capacidade e n√£o da sorte.</p>
        <div class="game-area">
            <div class="bet-option-card" style="opacity: 0.5;">
                <h3 style="margin-top: 0;">Jogo de Mem√≥ria</h3>
                <p class="small">Combine os pares em 60 segundos para ganhar 2x a aposta.</p>
                <button class="btn" disabled>Jogar (Em Breve)</button>
            </div>
            <div class="bet-option-card" style="opacity: 0.5;">
                <h3 style="margin-top: 0;">Quiz Global</h3>
                <p class="small">Responda a 10 perguntas em 30 segundos para ganhar 3x.</p>
                <button class="btn" disabled>Jogar (Em Breve)</button>
            </div>
        </div>
    </div>

    <div id="salesTab" style="display:none">
        <h2>üõí Mercado de Vendas (Dinheiro Real)</h2>
        <p class="small">Publique suas contas, skins ou itens de jogos para venda.</p>
        
        <div class="sale-post" style="background: var(--card-bg); border: 1px solid var(--main-gold); margin-bottom: 2rem;">
            <h3>üìù Criar Nova Postagem</h3>
            <input type="text" id="saleTitle" placeholder="T√≠tulo do Item (Ex: Conta Free Fire Elite)">
            <input type="text" id="saleContact" placeholder="Seu Contato (WhatsApp, Discord, etc.)">
            <textarea id="saleDescription" placeholder="Descri√ß√£o Detalhada do Item e Condi√ß√µes de Venda." rows="3"></textarea>
            <input type="number" id="salePrice" placeholder="Pre√ßo em R$ (Ex: 150.00)" step="0.01">
            <input type="file" id="saleImage" accept="image/*">
            <button id="btnPostSale" class="btn" onclick="postSale()" style="width: 100%; margin-top: 1rem;">Postar Venda</button>
        </div>

        <h3>Itens Ativos no Mercado</h3>
        <div id="salesList" class="sales-grid">
            <p class="small" style="grid-column: 1 / -1; text-align: center;">Carregando vendas...</p>
        </div>
    </div>

    <div id="rankTab" style="display:none">
        <h2>üèÜ Rank Global</h2>
        <p class="small" style="color: var(--green-win);">Ranking atualizado em tempo real pelo Gold. Competi√ß√£o acirrada!</p>
        <ol id="rankingList" class="rank-list">
            <li>Carregando ranking...</li>
        </ol>
    </div>

    <div id="chatTab" style="display:none">
        <h2>üí¨ Chat Global</h2>
        <p class="small">Mensagens em tempo real. M√°ximo de 200 caracteres por mensagem.</p>
        <div id="chatWindow" class="chat-box">
            </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
            <button id="btnSendMsg" class="btn" onclick="sendMessage()">Enviar</button>
            <button id="btnRecordAudio" class="btn" disabled>üé§</button>
        </div>
        <p id="chatError" class="small" style="color: var(--red-loss); margin-top: 5px;"></p>
    </div>
  </section>
</main>

<div id="globalNotice" style="display:none"></div>

<script>
// ----------------------------------------------------
// 1. CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE (v8)
// ----------------------------------------------------
// SEU UID DE ADMINISTRADOR! ESSENCIAL PARA O PAINEL E REGRAS!
// **SUBSTITUA ESTE VALOR PELO SEU UID REAL**
const OWNER_UID = "SEU_UID_DE_ADMINISTRADOR"; 
let currentUser = null; 
let initialGold = 1000; 
let isOnlineRef = null; 
const CHAT_LIMIT = 50;
let isWorkingCooldown = false;

// ATEN√á√ÉO: SUBSTITUA OS VALORES ABAIXO PELOS SEUS DADOS REAIS DO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyCkmyMqEJaM8jVvmTN8I3gLnbC8YtMPWOI", // Sua chave fornecida
    // **SUBSTITUA ESTES VALORES PELOS SEUS DADOS**
    authDomain: "SEU_AUTH_DOMAIN", 
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_MESSAGING_SENDER_ID",
    appId: "SEU_APP_ID"
};

// Certifica-se de que o Firebase SDK est√° carregado antes de inicializar
if (typeof firebase !== 'undefined') {
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;
    const storage = firebase.storage(); 

    // Refer√™ncias Comuns
    const usersColRef = db.collection('users');
    const chatColRef = db.collection('chat');
    const salesColRef = db.collection('sales');
    const onlineUsersColRef = db.collection('onlineUsers');
    const storageRef = storage.ref('sales_images');


    // ----------------------------------------------------
    // 2. FUN√á√ïES DE UTILIDADE E UI
    // ----------------------------------------------------

    function updateStatus(message, isError = false) {
        const statusElement = document.getElementById('globalNotice');
        statusElement.textContent = message;
        
        // Usando style.setProperty para garantir que as vari√°veis CSS sejam lidas
        if (isError) {
             statusElement.style.backgroundColor = 'var(--red-loss)';
             statusElement.style.color = 'white';
        } else {
             statusElement.style.backgroundColor = 'var(--main-gold)';
             statusElement.style.color = '#111';
        }

        statusElement.style.display = 'block';

        clearTimeout(window.noticeTimeout);
        window.noticeTimeout = setTimeout(() => {
            statusElement.style.display = 'none';
        }, 4000);
    }

    function switchTab(tabId) {
        // 1. Esconde todos os conte√∫dos
        document.querySelectorAll('.content > div').forEach(tab => {
            tab.style.display = 'none';
        });
        // 2. Desativa todos os bot√µes
        document.querySelectorAll('.tabbtn').forEach(btn => {
            btn.classList.remove('active');
        });

        // 3. Mostra o conte√∫do da aba selecionada
        const content = document.getElementById(tabId);
        if (content) {
            content.style.display = 'block';
             // Reset CSS display for the main content area
            document.querySelector('.content').style.display = 'block';
        }

        // 4. Ativa o bot√£o selecionado
        document.querySelector(`.tabbtn[data-tab="${tabId}"]`).classList.add('active');
    }

    // Listener para as abas
    document.querySelectorAll('.tabbtn').forEach(button => {
        button.addEventListener('click', () => {
            switchTab(button.getAttribute('data-tab'));
        });
    });


    // ----------------------------------------------------
    // 3. AUTENTICA√á√ÉO E PERFIL
    // ----------------------------------------------------

    async function checkUsernameAvailability(username) {
        const snapshot = await usersColRef.where('username', '==', username).get();
        return snapshot.empty;
    }

    async function signup() {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('username').value.trim() + "@ivad.com"; 
        const password = document.getElementById('pwd').value;
        
        if (username.length < 3) {
            return updateStatus("Nome de usu√°rio deve ter no m√≠nimo 3 caracteres.", true);
        }
        if (password.length < 6) {
            return updateStatus("Senha deve ter no m√≠nimo 6 caracteres.", true);
        }

        // 1. Verifica se o username √© √∫nico
        const isAvailable = await checkUsernameAvailability(username);
        if (!isAvailable) {
            return updateStatus("Nome de usu√°rio j√° est√° em uso.", true);
        }

        updateStatus("Criando conta...");
        
        // 2. Cria usu√°rio no Auth
        auth.createUserWithEmailAndPassword(email, password)
            .then(async (userCredential) => {
                const user = userCredential.user;
                
                // 3. Cria documento no Firestore 
                await usersColRef.doc(user.uid).set({
                    username: username,
                    gold: initialGold,
                    wins: 0,
                    losses: 0,
                    creationTime: FieldValue.serverTimestamp()
                });
                updateStatus(`Conta de ${username} criada com sucesso!`, false);
            })
            .catch(error => {
                if (error.code === 'auth/email-already-in-use') {
                     updateStatus("Um usu√°rio com este nome j√° existe. Tente outro nome.", true);
                } else {
                     updateStatus(`Erro no registro: ${error.message}`, true);
                }
            });
    }

    function login() {
        const email = document.getElementById('username').value.trim() + "@ivad.com";
        const password = document.getElementById('pwd').value;
        
        auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
                updateStatus(`Erro no login: ${error.message}`, true);
            });
    }

    async function loadUserData(user) {
        currentUser = user;
        
        // 1. Troca a UI
        document.getElementById('signedOutUI').style.display = 'none';
        document.getElementById('signedInUI').style.display = 'block';

        // 2. Verifica e mostra o Painel do Dono
        document.getElementById('ownerPanel').style.display = user.uid === OWNER_UID ? 'block' : 'none';

        const userRef = usersColRef.doc(user.uid);
        
        // 3. Listener em tempo real para Gold e Username
        userRef.onSnapshot(docSnapshot => {
            if (docSnapshot.exists) {
                const data = docSnapshot.data();
                const currentGold = Math.max(0, data.gold || 0); 
                
                document.getElementById('myGold').textContent = currentGold.toLocaleString();
                document.getElementById('playerGold').textContent = currentGold.toLocaleString();
                document.getElementById('userLabel').textContent = `Bem-vindo, ${data.username}!`;
                document.getElementById('socialUsername').textContent = data.username;
                document.getElementById('socialUserId').textContent = user.uid;
                document.getElementById('playerInfoSocial').style.display = 'block';

                if (data.username !== document.getElementById('username').value.trim()) {
                    document.getElementById('username').value = data.username; 
                }
            }
        });

        // 4. Ativar fun√ß√µes de tempo real
        loadRanking(); 
        loadChat();    
        loadSales();
        trackOnlineStatus(user.uid);
    }


    // ----------------------------------------------------
    // 4. JOGOS E SISTEMA ANTI-HACK DE GOLD
    // ----------------------------------------------------

    async function updateGold(amount, isWin = false) {
        if (!currentUser) return false;
        
        const updateData = {
            gold: FieldValue.increment(amount)
        };

        if (isWin && amount > 0) {
            updateData.wins = FieldValue.increment(1);
        } else if (!isWin && amount < 0) {
            updateData.losses = FieldValue.increment(1);
        }

        return usersColRef.doc(currentUser.uid).update(updateData)
            .catch(error => {
                updateStatus(`Erro ao atualizar Gold: ${error.message}`, true);
                return false;
            });
    }

    function validateBet(amount) {
        // L√™ o gold atual, removendo formata√ß√£o. Se n√£o tiver gold, usa 0.
        const currentGoldText = document.getElementById('myGold').textContent.replace(/,/g, '');
        const currentGold = parseInt(currentGoldText) || 0;
        
        if (!currentUser) { 
            updateStatus("Fa√ßa login para apostar.", true); return false; 
        }
        // Garante que o amount seja um n√∫mero inteiro positivo
        const betAmount = parseInt(amount); 
        
        if (isNaN(betAmount) || betAmount <= 0) { 
            updateStatus("A aposta deve ser um valor positivo e num√©rico.", true); return false; 
        }
        if (betAmount > currentGold) { 
            updateStatus("Gold insuficiente para esta aposta.", true); return false; 
        }
        return true;
    }

    function notify(message, isWin) {
        const element = document.getElementById('globalNotice');
        element.textContent = message;
        
        if (isWin) {
             element.style.backgroundColor = 'var(--green-win)';
        } else {
             element.style.backgroundColor = 'var(--red-loss)';
        }

        element.style.color = 'white';
        element.style.display = 'block';

        clearTimeout(window.noticeTimeout);
        window.noticeTimeout = setTimeout(() => {
            element.style.display = 'none';
        }, 4000);
    }

    // Jogo Simples: Trabalho (AGORA COM COOLDOWN VISUAL)
    async function work() {
        const btnWork = document.getElementById('btnWork');
        if (isWorkingCooldown) return updateStatus("Aguarde o cooldown (5 segundos).", true);
        if (!currentUser) return updateStatus("Voc√™ precisa estar logado para trabalhar.", true);
        
        isWorkingCooldown = true;
        btnWork.disabled = true;
        btnWork.classList.add('cooldown');

        const currentGold = parseInt(document.getElementById('myGold').textContent.replace(/,/g, '')) || 0;
        const percentage = Math.floor(Math.random() * 100) + 1; // 1% a 100%
        const earnings = Math.max(1, Math.floor(currentGold * (percentage / 100))); 
        
        await updateGold(earnings, true);

        document.getElementById('workMsg').textContent = `Voc√™ trabalhou e ganhou +${earnings.toLocaleString()} Gold (${percentage}%).`;
        
        setTimeout(() => {
            isWorkingCooldown = false;
            btnWork.disabled = false;
            btnWork.classList.remove('cooldown');
            document.getElementById('workMsg').textContent = '';
        }, 5000); // 5 segundos de cooldown
    }

    // Jogo Simples: Multiplicador (CORRIGIDO)
    async function betSimple(multiplier, inputId, msgId, winChance) {
        const inputElement = document.getElementById(inputId);
        const amount = parseInt(inputElement.value);
        if (!validateBet(amount)) return;
        
        const win = Math.random() * 100 < winChance;
        const result = win ? amount * (multiplier - 1) : -amount; 
        
        await updateGold(result, win);
        
        const msg = win 
            ? `‚úÖ GANHOU ${multiplier}x! Lucro de ${result.toLocaleString()} Gold.` 
            : `‚ùå PERDEU. Menos ${amount.toLocaleString()} Gold.`;
        
        document.getElementById(msgId).textContent = msg;
        notify(msg, win);
    }

    // Aposta Avan√ßada: Cor (48% 2x, 4% 4x) - (CORRIGIDO)
    async function betCor() {
        const amount = parseInt(document.getElementById('betCorAmount').value);
        const choice = document.getElementById('betCorColor').value;
        if (!validateBet(amount)) return;

        const rand = Math.random();
        let outcome = '';
        let mult = 0;

        if (rand < 0.48) { 
            outcome = 'red';
            mult = 2;
        } else if (rand < 0.96) { 
            outcome = 'black';
            mult = 2;
        } else { 
            outcome = 'green';
            mult = 4;
        }

        const win = choice === outcome;
        const result = win ? amount * (mult - 1) : -amount;
        
        await updateGold(result, win);
        
        const msg = win 
            ? `‚úÖ GANHOU ${mult}x! Sorteado: ${outcome.toUpperCase()}. Lucro: ${result.toLocaleString()} Gold.` 
            : `‚ùå PERDEU. Sorteado: ${outcome.toUpperCase()}. Menos ${amount.toLocaleString()} Gold.`;
        
        document.getElementById('betCorMsg').textContent = msg;
        notify(msg, win);
    }

    // Aposta Avan√ßada: Moeda (50% 2x) - (CORRIGIDO)
    async function betCoin() {
        const amount = parseInt(document.getElementById('betCoinAmount').value);
        const choice = document.getElementById('betCoinSide').value;
        if (!validateBet(amount)) return;

        const outcome = Math.random() < 0.5 ? 'cara' : 'coroa';
        const win = choice === outcome;
        const result = win ? amount : -amount;
        
        await updateGold(result, win);
        
        const msg = win 
            ? `‚úÖ GANHOU 2x! Deu ${outcome.toUpperCase()}. Lucro: ${result.toLocaleString()} Gold.` 
            : `‚ùå PERDEU. Deu ${outcome.toUpperCase()}. Menos ${amount.toLocaleString()} Gold.`;
        
        document.getElementById('betCoinMsg').textContent = msg;
        notify(msg, win);
    }

    // Aposta Avan√ßada: Dice (12x) - (CORRIGIDO)
    async function betDice(maxNumber, multiplier, inputAmountId, inputChoiceId, msgId) {
        const amount = parseInt(document.getElementById(inputAmountId).value);
        const choice = parseInt(document.getElementById(inputChoiceId).value);
        
        if (!validateBet(amount) || isNaN(choice) || choice < 1 || choice > maxNumber) {
            return updateStatus(`N√∫mero de ${maxNumber} lados inv√°lido (1-${maxNumber}).`, true);
        }

        const outcome = Math.floor(Math.random() * maxNumber) + 1;
        const win = choice === outcome;
        const result = win ? amount * (multiplier - 1) : -amount;
        
        await updateGold(result, win);
        
        const msg = win 
            ? `‚úÖ ACERTOU ${outcome}! Lucro de ${result.toLocaleString()} Gold (${multiplier}x).` 
            : `‚ùå ERROU ${outcome}. Perdeu ${amount.toLocaleString()} Gold.`;
        
        document.getElementById(msgId).textContent = msg;
        notify(msg, win);
    }

    // Aposta Avan√ßada: RNG M√°gico (4x) - (CORRIGIDO)
    async function betRNG(multiplier, fixedAmount, winChance, msgId) {
        const amount = fixedAmount;
        if (!validateBet(amount)) return; 

        const rand = Math.random() * 100;
        const win = rand < winChance;
        const result = win ? amount * (multiplier - 1) : -amount;
        
        await updateGold(result, win);
        
        const msg = win 
            ? `‚úÖ N√öMERO M√ÅGICO! Lucro de ${result.toLocaleString()} Gold (${multiplier}x).` 
            : `‚ùå N√ÉO FOI DESSA VEZ. Perdeu ${amount.toLocaleString()} Gold.`;
        
        document.getElementById(msgId).textContent = msg;
        notify(msg, win);
    }


    // ----------------------------------------------------
    // 5. RANKING GLOBAL
    // ----------------------------------------------------

    function loadRanking() {
        usersColRef.orderBy('gold', 'desc').limit(15).onSnapshot(snapshot => {
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = ''; 
            
            if (snapshot.empty) {
                rankingList.innerHTML = '<li>Nenhum usu√°rio no ranking ainda.</li>';
                return;
            }

            snapshot.forEach((doc, index) => {
                const data = doc.data();
                const li = document.createElement('li');
                li.style.color = doc.id === currentUser.uid ? 'var(--main-gold)' : 'var(--text-primary)';
                li.style.fontWeight = doc.id === currentUser.uid ? 'bold' : 'normal';

                let usernameDisplay = data.username;
                if (doc.id === OWNER_UID) {
                     usernameDisplay = `<span style="color: #ff00ff;">${data.username} [DONO]</span>`;
                }

                li.innerHTML = `
                    <span style="width: 30px; display: inline-block;">#${index + 1}</span>
                    ${usernameDisplay}
                    <span style="color: var(--main-gold);">${data.gold ? data.gold.toLocaleString() : '0'} Gold</span>
                `;
                rankingList.appendChild(li);
            });
        }, error => {
            updateStatus(`Erro ao carregar ranking: ${error.message}. Verifique as Regras de Seguran√ßa.`, true);
        });
    }


    // ----------------------------------------------------
    // 6. CHAT GLOBAL
    // ----------------------------------------------------

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message || !currentUser) return;
        
        if (message.length > 200) {
            return document.getElementById('chatError').textContent = "Mensagem muito longa (M√°x. 200).";
        }
        
        document.getElementById('chatError').textContent = "";
        const userData = (await usersColRef.doc(currentUser.uid).get()).data();
        
        chatColRef.add({
            username: userData.username,
            text: message,
            uid: currentUser.uid,
            timestamp: FieldValue.serverTimestamp()
        })
        .then(() => input.value = '')
        .catch(error => {
            document.getElementById('chatError').textContent = `Erro: ${error.message}.`;
        });
    }

    function loadChat() {
        chatColRef.orderBy('timestamp', 'desc').limit(CHAT_LIMIT).onSnapshot(snapshot => {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = '';
            
            const messages = [];
            snapshot.forEach(doc => messages.push(doc.data()));
            messages.reverse().forEach(data => {
                const div = document.createElement('div');
                div.className = 'chat-message';
                
                let nameColor = data.uid === OWNER_UID ? '#ff00ff' : 'var(--text-secondary)';
                let nameDisplay = data.uid === OWNER_UID ? `${data.username} [DONO]:` : `${data.username}:`;

                div.innerHTML = `<span style="color: ${nameColor}; font-weight: bold;">${nameDisplay}</span> <span>${data.text}</span>`;
                
                chatWindow.appendChild(div);
            });
            
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }, error => console.error("Erro ao carregar chat: ", error));
    }


    // ----------------------------------------------------
    // 7. SISTEMA DE VENDAS (Com Upload de Imagem)
    // ----------------------------------------------------

    async function postSale() {
        if (!currentUser) return updateStatus("Fa√ßa login para postar.", true);

        const title = document.getElementById('saleTitle').value.trim();
        const contact = document.getElementById('saleContact').value.trim();
        const description = document.getElementById('saleDescription').value.trim();
        const price = parseFloat(document.getElementById('salePrice').value);
        const imageFile = document.getElementById('saleImage').files[0];

        if (!title || !contact || !description || isNaN(price) || price <= 0 || !imageFile) {
            return updateStatus("Preencha todos os campos e anexe uma imagem.", true);
        }

        document.getElementById('btnPostSale').disabled = true;
        updateStatus("Subindo imagem e postando...");

        try {
            const userData = (await usersColRef.doc(currentUser.uid).get()).data();
            const fileName = `${currentUser.uid}_${Date.now()}_${imageFile.name}`;
            const imageRef = storageRef.child(fileName);
            
            // 1. Upload da Imagem
            const snapshot = await imageRef.put(imageFile);
            const imageUrl = await snapshot.ref.getDownloadURL();

            // 2. Cria√ß√£o do Documento no Firestore 
            await salesColRef.add({
                title: title,
                description: description,
                contact: contact,
                price: price,
                imageUrl: imageUrl,
                sellerUid: currentUser.uid,
                sellerUsername: userData.username,
                timestamp: FieldValue.serverTimestamp()
            });

            updateStatus("Item postado no mercado com sucesso!", false);
            document.getElementById('saleTitle').value = '';
            document.getElementById('saleContact').value = '';
            document.getElementById('saleDescription').value = '';
            document.getElementById('salePrice').value = '';
            document.getElementById('saleImage').value = '';

        } catch (error) {
            updateStatus(`Erro ao postar venda: ${error.message}`, true);
        } finally {
            document.getElementById('btnPostSale').disabled = false;
        }
    }

    function loadSales() {
        salesColRef.orderBy('timestamp', 'desc').onSnapshot(snapshot => {
            const salesList = document.getElementById('salesList');
            salesList.innerHTML = '';

            if (snapshot.empty) {
                salesList.innerHTML = '<p class="small" style="grid-column: 1 / -1; text-align: center;">Nenhum item √† venda no momento.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'sale-post';
                
                let buttons = '';

                // Bot√£o de Contato Padr√£o
                if (data.contact) {
                     if (data.contact.toLowerCase().includes('discord')) {
                        buttons += `<a href="#" onclick="updateStatus('Contato: ${data.contact} - Copiado!', false); navigator.clipboard.writeText('${data.contact}')" class="sale-contact-btn" style="background: #7289da;">VER DISCORD</a>`;
                     } else if (data.contact.toLowerCase().includes('wa.me') || data.contact.match(/^\+?\d{10,15}$/)) {
                         const waLink = data.contact.startsWith('https://wa.me') ? data.contact : `https://wa.me/${data.contact.replace(/[^\d+]/g, '')}?text=Tenho%20interesse%20no%20seu%20item%20'${data.title}'%20no%20IVAD!`;
                         buttons += `<a href="${waLink}" target="_blank" class="sale-contact-btn" style="background: #25d366;">CHAMAR NO WHATSAPP</a>`;
                     } else {
                         buttons += `<a href="#" onclick="navigator.clipboard.writeText('${data.contact}'); updateStatus('Contato copiado!', false);" class="sale-contact-btn" style="background: #4A90E2;">COPIAR CONTATO</a>`;
                     }
                }
                
                // Bot√£o de Excluir (para o vendedor ou dono)
                if (currentUser && (data.sellerUid === currentUser.uid || currentUser.uid === OWNER_UID)) {
                    buttons += `<button onclick="deleteSale('${doc.id}', '${data.imageUrl}')" class="btn" style="background: var(--btn-red); width: 100%; margin-top: 10px;">Excluir Postagem</button>`;
                }

                div.innerHTML = `
                    <img src="${data.imageUrl || 'https://via.placeholder.com/320x240?text=Sem+Imagem'}" alt="${data.title}">
                    <h4 style="margin-top: 0; color: var(--text-primary);">${data.title}</h4>
                    <p class="small" style="color: var(--text-primary);">${data.description}</p>
                    <div class="sale-price">R$ ${data.price.toFixed(2).replace('.', ',')}</div>
                    <p class="small" style="margin-top: 5px; color: var(--text-secondary);">Vendedor: ${data.sellerUsername}</p>
                    ${buttons}
                `;
                salesList.appendChild(div);
            });
        }, error => updateStatus(`Erro ao carregar vendas: ${error.message}`, true));
    }

    async function deleteSale(saleId, imageUrl) {
        if (!currentUser) return;
        if (!confirm("Tem certeza que deseja excluir esta postagem?")) return;
        
        try {
            // 1. Excluir imagem do Storage
            if (imageUrl) {
                const fileRef = storage.refFromURL(imageUrl);
                await fileRef.delete();
            }
            
            // 2. Excluir documento do Firestore 
            await salesColRef.doc(saleId).delete();
            updateStatus("Postagem exclu√≠da com sucesso.", false);
        } catch (error) {
            updateStatus(`Erro ao excluir postagem: ${error.message}`, true);
        }
    }


    // ----------------------------------------------------
    // 8. FUN√á√ïES DE ADMINISTRADOR
    // ----------------------------------------------------

    async function adminGiveGold() {
        if (currentUser.uid !== m3h06woQv2V7lrNu1p8fDQCZ8IW2) return;

        const targetUsername = document.getElementById('adminName').value.trim();
        const amount = parseInt(document.getElementById('adminAmount').value);

        if (!targetUsername || isNaN(amount) || amount === 0) {
            return updateStatus("[ADMIN] Preencha o nome do usu√°rio e a quantidade de Gold.", true);
        }
        
        try {
            const snapshot = await usersColRef.where('username', '==', targetUsername).limit(1).get();
            if (snapshot.empty) {
                return updateStatus(`[ADMIN] Usu√°rio '${targetUsername}' n√£o encontrado.`, true);
            }
            const targetUid = snapshot.docs[0].id;
            const isWin = amount > 0;

            // Uso de FieldValue.increment para seguran√ßa
            await usersColRef.doc(targetUid).update({
                gold: FieldValue.increment(amount) ,
                wins: isWin ? FieldValue.increment(1) : FieldValue.increment(0),
                losses: isWin ? FieldValue.increment(0) : FieldValue.increment(1)
            });

            updateStatus(`[ADMIN] ${amount > 0 ? 'DADO' : 'REMOVIDO'} ${Math.abs(amount).toLocaleString()} Gold para ${targetUsername}.`);
            document.getElementById('adminName').value = '';
            document.getElementById('adminAmount').value = '';
        } catch (error) {
            updateStatus(`[ADMIN] Erro: ${error.message}`, true);
        }
    }

    async function adminClearChat() {
        if (currentUser.uid !== OWNER_UID) return;
        if (!confirm("Tem certeza que deseja apagar TODAS as mensagens do Chat Global?")) return;
        
        // Limita o n√∫mero de documentos para evitar timeout (Firestore limita batches)
        chatColRef.limit(200).get().then(snapshot => {
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            return batch.commit();
        })
        .then(() => updateStatus("[ADMIN] Chat Global limpo (parcialmente - repita se for necess√°rio)!", false))
        .catch(error => updateStatus(`[ADMIN] Erro ao limpar chat: ${error.message}`, true));
    }


    // ----------------------------------------------------
    // 9. CONTADOR DE USU√ÅRIOS ONLINE
    // ----------------------------------------------------

    function trackOnlineStatus(uid) {
        if (isOnlineRef) return; 
        
        isOnlineRef = onlineUsersColRef.doc(uid);
        
        isOnlineRef.set({ 
            username: document.getElementById('userLabel').textContent.split(', ')[1].replace('!', ''), 
            timestamp: FieldValue.serverTimestamp() 
        });
        
        // Marca como offline
        window.addEventListener('beforeunload', () => isOnlineRef.delete());
        auth.onAuthStateChanged(user => {
            if (!user && isOnlineRef) isOnlineRef.delete();
        });

        // Listener do contador em tempo real
        onlineUsersColRef.onSnapshot(snapshot => {
            let count = 0;
            const now = firebase.firestore.Timestamp.now().toMillis();
            const timeout = 5 * 60 * 1000; // 5 minutos
            const batch = db.batch();
            let hasCleanup = false;

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.timestamp && (now - data.timestamp.toMillis() > timeout)) {
                    // Marca para exclus√£o se estiver desatualizado
                    batch.delete(doc.ref);
                    hasCleanup = true;
                } else {
                    count++;
                }
            });

            if (hasCleanup) {
                 batch.commit().catch(e => console.error("Erro ao limpar usu√°rios online: ", e));
            }
            
            document.getElementById('visitorCount').textContent = count.toLocaleString();
        }, error => console.error("Erro no contador online: ", error));
    }


    // ----------------------------------------------------
    // 10. LISTENERS GLOBAIS
    // ----------------------------------------------------

    auth.onAuthStateChanged(user => {
        if (user) {
            loadUserData(user);
        } else {
            currentUser = null;
            document.getElementById('signedOutUI').style.display = 'block';
            document.getElementById('signedInUI').style.display = 'none';
            document.getElementById('ownerPanel').style.display = 'none';
            document.getElementById('playerInfoSocial').style.display = 'none';
            // Garante que o contador online seja zerado para este usu√°rio ao deslogar
            if (isOnlineRef) { isOnlineRef.delete(); isOnlineRef = null; }
            updateStatus("Desconectado. Fa√ßa login para usar o sistema.", true);
        }
    });

    // Inicializa a primeira aba e listeners
    document.addEventListener('DOMContentLoaded', () => {
        switchTab('regrasTab');
    });
} else {
    // Se o SDK n√£o carregou, avisa o erro
    document.addEventListener('DOMContentLoaded', () => {
        alert("ERRO: O SDK do Firebase n√£o carregou. Verifique a conex√£o com a internet e se os links <script> do Firebase est√£o corretos.");
    });
}

</script>

</body>
</html>
